// ===============================
// Fun√ß√µes de Integra√ß√£o com o Ecossistema MIV
// ===============================
const MivEngine = {

    /* =========================
       1. CADASTRO DE ATIVO
    ========================= */
    async cadastrarAtivo() {
        const url = prompt("Cole o link do seu √∫ltimo lan√ßamento no YouTube:");
        const titulo = prompt("T√≠tulo da Obra:");
        const valorCota = prompt("Valor da cota (R$):", "10");

        if (!url || !titulo) return;

        const user = JSON.parse(localStorage.getItem('miv_session'));

        const res = await fetch(
            `${API_URL}?acao=cadastrar_ativo` +
            `&artistaId=${user.id}` +
            `&urlYoutube=${encodeURIComponent(url)}` +
            `&titulo=${encodeURIComponent(titulo)}` +
            `&valorCota=${valorCota}`
        );

        const data = await res.json();

        if (data.success) {
            alert("üéµ M√∫sica tokenizada e listada no Market!");
            carregarMercado();
        } else {
            alert(data.msg || "Erro ao cadastrar ativo");
        }
    },

    /* =========================
       2. COMPRA DE COTAS
    ========================= */
    async comprarCota(musicaId, valor) {
        if (!confirm(`Confirmar investimento de R$ ${valor} neste ativo?`)) return;

        const user = JSON.parse(localStorage.getItem('miv_session'));

        const res = await fetch(
            `${API_URL}?acao=comprar_cota` +
            `&userId=${user.id}` +
            `&musicaId=${musicaId}` +
            `&valor=${valor}` +
            `&qtd=1`
        );

        const data = await res.json();

        if (data.success) {
            alert("üìà Investimento realizado! Cota adicionada √† sua carteira.");
            location.reload();
        } else {
            alert(data.msg || "Erro ao comprar cota");
        }
    },

    /* =========================
       3. REGISTRAR STREAM FINANCEIRO
    ========================= */
    notificarStream(musicaId) {
        const user = JSON.parse(localStorage.getItem('miv_session'));

        fetch(
            `${API_URL}?acao=registrar_play` +
            `&userId=${user.id}` +
            `&musicaId=${musicaId}`
        );
    }
};

// ===============================
// PLAYER YOUTUBE ‚Üí PLAY FINANCEIRO
// ===============================
let musicaAtual = null;

function tocarMusica(videoId, titulo, artista, musicaId) {
    musicaAtual = musicaId;

    document.getElementById('p-title').innerText = titulo;
    document.getElementById('p-artist').innerText = artista;

    ytPlayer.loadVideoById(videoId);
}

function onPlayerStateChange(event) {
    if (event.data === YT.PlayerState.PLAYING && musicaAtual) {

        // Evita m√∫ltiplos registros do mesmo play
        clearTimeout(window.mivPlayTimer);

        window.mivPlayTimer = setTimeout(() => {
            if (ytPlayer.getPlayerState() === YT.PlayerState.PLAYING) {
                MivEngine.notificarStream(musicaAtual);
            }
        }, 30000); // 30 segundos = play v√°lido
    }
}
