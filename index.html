<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>SELO MIV Play</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- ⚠️ NÃO MEXI EM ESTILO / CLASSES -->
<link rel="stylesheet" href="style.css">

</head>
<body>

<!-- ================= AUTH SCREEN ================= -->
<div id="authScreen">

  <!-- LOGIN -->
  <div id="loginForm">
    <h2>Login</h2>

    <input id="loginEmail" type="email" placeholder="Email">
    <input id="loginPassword" type="password" placeholder="Senha">

    <button onclick="handleLogin()">Entrar</button>

    <p>
      <a href="#" onclick="showRegister()">Criar conta</a>
    </p>
  </div>

  <!-- REGISTRO -->
  <div id="registerForm" style="display:none">
    <h2>Cadastro</h2>

    <input id="registerName" type="text" placeholder="Nome">
    <input id="registerEmail" type="email" placeholder="Email">
    <input id="registerPassword" type="password" placeholder="Senha">

    <select id="registerType" onchange="toggleArtistField()">
      <option value="">Tipo</option>
      <option value="investidor">Investidor</option>
      <option value="artista">Artista</option>
    </select>

    <div id="artistLinkField" style="display:none">
      <input id="registerLink" type="text" placeholder="Link artístico">
    </div>

    <button onclick="handleRegister()">Cadastrar</button>

    <p>
      <a href="#" onclick="showLogin()">Já tenho conta</a>
    </p>
  </div>

</div>

<!-- ================= MAIN APP ================= -->
<div id="mainApp" style="display:none">

  <header>
    <h2>SELO MIV</h2>
    <button onclick="logout()">Sair</button>
  </header>

  <section>
    <h3>Saldo</h3>
    <div id="saldo">R$ 0,00</div>
  </section>

  <section>
    <h3>Músicas</h3>
    <div id="musicList"></div>
  </section>

</div>

<!-- ================= JS ================= -->
<script>
/* ================= CONFIG ================= */
const API_URL = 'https://script.google.com/macros/s/AKfycbwcs1mvYQb81WkwoMtSgtyXkSJfwaInXNy0DLzJjovFbxHs78vYwj13Mel3p5d3XuI/exec';

/* ================= HELPERS ================= */
function api(action, data = {}) {
  return fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ action, ...data })
  }).then(r => r.json());
}

function $(id) {
  return document.getElementById(id);
}

/* ================= UI ================= */
function showRegister() {
  $('loginForm').style.display = 'none';
  $('registerForm').style.display = 'block';
}

function showLogin() {
  $('registerForm').style.display = 'none';
  $('loginForm').style.display = 'block';
}

function toggleArtistField() {
  $('artistLinkField').style.display =
    $('registerType').value === 'artista' ? 'block' : 'none';
}

/* ================= AUTH ================= */
function handleRegister() {
  const data = {
    nome: $('registerName').value.trim(),
    email: $('registerEmail').value.trim(),
    password: $('registerPassword').value.trim(),
    tipo: $('registerType').value,
    workLink: $('registerLink').value.trim()
  };

  api('register', data).then(res => {
    if (!res.success) {
      alert(res.error);
      return;
    }
    alert('Cadastro realizado. Faça login.');
    showLogin();
  });
}

function handleLogin() {
  const email = $('loginEmail').value.trim();
  const password = $('loginPassword').value.trim();

  api('login', { email, password }).then(res => {
    if (!res.success) {
      alert(res.error);
      return;
    }

    localStorage.setItem('user', JSON.stringify(res.user));
    initApp();
  });
}

function logout() {
  localStorage.removeItem('user');
  location.reload();
}

/* ================= APP ================= */
function initApp() {
  const user = JSON.parse(localStorage.getItem('user'));
  if (!user) return;

  $('authScreen').style.display = 'none';
  $('mainApp').style.display = 'block';

  loadSaldo();
  loadMusicas();
}

function loadSaldo() {
  const user = JSON.parse(localStorage.getItem('user'));
  api('getSaldo', { userId: user.id }).then(res => {
    if (res.success) {
      $('saldo').innerText = 'R$ ' + res.saldo.toFixed(2);
    }
  });
}

function loadMusicas() {
  api('getMusicas').then(res => {
    if (!res.success) return;

    const box = $('musicList');
    box.innerHTML = '';

    res.musicas.forEach(m => {
      const div = document.createElement('div');
      div.innerHTML = `
        <strong>${m.nome}</strong><br>
        Preço: R$ ${m.precoAcao}<br>
        Disponíveis: ${m.acoesDisponiveis}<br>
        <button onclick="buy('${m.id}', ${m.precoAcao})">Comprar 1</button>
        <hr>
      `;
      box.appendChild(div);
    });
  });
}

function buy(musicId, price) {
  const user = JSON.parse(localStorage.getItem('user'));

  api('buy', {
    userId: user.id,
    musicaId: musicId,
    quantidade: 1
  }).then(res => {
    alert(res.message || res.error);
    loadSaldo();
    loadMusicas();
  });
}

/* ================= INIT ================= */
document.addEventListener('DOMContentLoaded', initApp);
</script>

</body>
</html>
