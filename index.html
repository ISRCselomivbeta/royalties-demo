# **C√ìDIGO COMPLETO ATUALIZADO - SELO MIV**

## **1. C√ìDIGO DO GOOGLE APPS SCRIPT (backend.gs)**

```javascript
// ========== CONFIGURA√á√ÉO DO WEB APP ========== 
const SPREADSHEET_ID = '1CwF9hf-lsjYkol-V7r3WOT5ld3dQFqKRTQ8nHcV45Wo';

// ========== FUN√á√ïES PRINCIPAIS ==========
function doGet(e) {
  console.log('üì• GET Recebido');
  
  const params = e?.parameter || {};
  const action = params.action || params.acao;
  
  // Se for uma chamada de API
  if (action) {
    console.log(`üéØ API GET: ${action}`, params);
    
    try {
      let result;
      
      switch(action) {
        case 'test':
          result = {
            success: true,
            message: 'üéµ MIV API ONLINE v1.0',
            timestamp: new Date().toISOString(),
            endpoints: ['test', 'login', 'register', 'get_musicas', 'get_saldo', 'setup']
          };
          break;
          
        case 'get_musicas':
          result = getMusicas();
          break;
          
        case 'login':
          result = handleLogin(params);
          break;
          
        case 'register':
          result = handleRegister(params);
          break;
          
        case 'get_saldo':
          result = getSaldo(params);
          break;
          
        case 'get_carteira':
          result = getCarteira(params);
          break;
          
        case 'get_extrato':
          result = getExtrato(params);
          break;
          
        case 'get_historico_financeiro':
          result = getHistoricoFinanceiro(params.user_id);
          break;
          
        case 'get_resumo':
          result = getResumoPortfolio(params);
          break;
          
        case 'get_artist_data':
          result = getArtistData(params);
          break;
          
        case 'setup':
          result = setupSpreadsheet();
          break;
          
        case 'ping':
          result = { success: true, pong: Date.now() };
          break;
          
        default:
          result = {
            success: false,
            message: `A√ß√£o '${action}' n√£o suportada via GET`,
            supported: ['test', 'get_musicas', 'login', 'register', 'get_saldo', 'get_carteira', 'get_extrato', 'setup', 'ping']
          };
      }
      
      console.log('‚úÖ Resultado:', JSON.stringify(result).substring(0, 200));
      return ContentService
        .createTextOutput(JSON.stringify(result))
        .setMimeType(ContentService.MimeType.JSON);
        
    } catch (error) {
      console.error('‚ùå Erro no GET:', error);
      return ContentService
        .createTextOutput(JSON.stringify({
          success: false,
          message: 'Erro interno',
          error: error.message
        }))
        .setMimeType(ContentService.MimeType.JSON);
    }
  }
  
  // Se n√£o for API, retorna p√°gina HTML b√°sica
  return HtmlService.createHtmlOutput(`
    <!DOCTYPE html>
    <html>
    <head>
      <title>üéµ SELO MIV - Backend</title>
      <style>
        body { font-family: Arial, sans-serif; padding: 40px; text-align: center; background: #07090c; color: white; }
        h1 { color: #00ff88; margin-bottom: 20px; }
        .card { background: #111418; padding: 30px; border-radius: 15px; max-width: 600px; margin: 0 auto; border: 1px solid #1e2329; }
        code { background: #000; color: #00ff88; padding: 5px 10px; border-radius: 5px; }
        .endpoint { text-align: left; margin: 20px 0; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 10px; }
      </style>
    </head>
    <body>
      <h1>üéµ SELO MIV - Backend</h1>
      <div class="card">
        <h3>‚úÖ API Funcionando</h3>
        <p>Sistema de investimento em m√∫sica</p>
        
        <div class="endpoint">
          <h4>üì° Endpoints Dispon√≠veis:</h4>
          <p><code>GET ?action=test</code> - Testar API</p>
          <p><code>GET ?action=get_musicas</code> - Listar m√∫sicas</p>
          <p><code>GET ?action=login&email=...&password=...</code> - Login</p>
          <p><code>GET ?action=setup</code> - Configurar banco de dados</p>
        </div>
        
        <p><strong>Frontend:</strong> <a href="https://selomivplay.vercel.app" target="_blank">selomivplay.vercel.app</a></p>
        <p><small>${new Date().toLocaleString('pt-BR')}</small></p>
      </div>
    </body>
    </html>
  `).setTitle('SELO MIV - Backend');
}

function doPost(e) {
  console.log('üì® POST Recebido');
  
  // Se for chamada vazia (do Vercel)
  if (!e) {
    console.log('üì≠ POST vazio - retornando status');
    return ContentService
      .createTextOutput(JSON.stringify({
        success: true,
        message: 'MIV API POST endpoint',
        note: 'Para API use GET: ?action=nome',
        timestamp: new Date().toISOString()
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
  
  console.log('üì¶ Dados POST:', JSON.stringify(e).substring(0, 500));
  
  let params = {};
  
  // Pega dados do FormData
  if (e.parameter) {
    params = e.parameter;
    console.log('üìã Par√¢metros URL:', params);
  }
  
  // Pega dados do JSON body
  if (e.postData && e.postData.contents) {
    try {
      const jsonData = JSON.parse(e.postData.contents);
      params = { ...params, ...jsonData };
      console.log('üì¶ JSON Body:', jsonData);
    } catch (error) {
      console.log('‚ö†Ô∏è N√£o √© JSON v√°lido:', error.message);
    }
  }
  
  const action = params.action || params.acao;
  
  if (!action) {
    return ContentService
      .createTextOutput(JSON.stringify({
        success: false,
        message: 'Par√¢metro "action" √© obrigat√≥rio',
        usage: 'Use ?action=test ou envie JSON com {"action": "nome"}'
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
  
  console.log(`üéØ Processando a√ß√£o POST: ${action}`);
  
  try {
    let result;
    
    switch(action) {
      case 'login':
        result = handleLogin(params);
        break;
      case 'register':
        result = handleRegister(params);
        break;
      case 'get_musicas':
        result = getMusicas();
        break;
      case 'get_saldo':
        result = getSaldo(params);
        break;
      case 'get_carteira':
        result = getCarteira(params);
        break;
      case 'get_extrato':
        result = getExtrato(params);
        break;
      case 'get_historico_financeiro':
        result = getHistoricoFinanceiro(params.user_id);
        break;
      case 'get_resumo':
        result = getResumoPortfolio(params);
        break;
      case 'buy':
        result = buyShares(params);
        break;
      case 'uploadMusic':
        result = uploadMusic(params);
        break;
      case 'get_artist_data':
        result = getArtistData(params);
        break;
      case 'confirmar_deposito':
        result = confirmarDepositoPix(params.user_id, params.valor, params.referencia);
        break;
      case 'solicitar_saque':
        result = solicitarSaque(params.user_id, params.valor);
        break;
      case 'confirmar_saque':
        result = confirmarSaque(params.user_id, params.valor, params.referencia);
        break;
      case 'test':
        result = { 
          success: true, 
          message: 'API POST funcionando',
          action: action,
          params: params,
          timestamp: new Date().toISOString()
        };
        break;
      default:
        result = {
          success: false,
          message: `A√ß√£o '${action}' n√£o implementada`
        };
    }
    
    console.log('‚úÖ Resultado POST:', JSON.stringify(result).substring(0, 200));
    return ContentService
      .createTextOutput(JSON.stringify(result))
      .setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    console.error('üí• Erro no POST:', error);
    return ContentService
      .createTextOutput(JSON.stringify({
        success: false,
        message: error.message,
        stack: error.stack
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

// ========== FUN√á√ïES DO BANCO DE DADOS ==========
function getSpreadsheet() {
  return SpreadsheetApp.openById(SPREADSHEET_ID);
}

// ========== FUN√á√ïES DE USU√ÅRIO ==========
function handleLogin(params) {
  console.log('üîê handleLogin chamado:', params);
  
  if (!params || typeof params !== 'object') {
    return { success: false, message: 'Par√¢metros inv√°lidos' };
  }
  
  const email = params.email || params.loginEmail || '';
  const password = params.pass || params.password || params.loginPassword || '';
  
  console.log('Tentando login:', { email: email.substring(0, 10) + '...', password: '***' });
  
  if (!email || !password) {
    return { success: false, message: 'Email e senha s√£o obrigat√≥rios' };
  }
  
  try {
    const ss = getSpreadsheet();
    const sheet = ss.getSheetByName('USUARIOS');
    
    if (!sheet) {
      return { 
        success: false, 
        message: 'Sistema n√£o configurado. Execute ?action=setup primeiro.',
        tip: 'Acesse: ' + ScriptApp.getService().getUrl() + '?action=setup'
      };
    }
    
    const data = sheet.getDataRange().getValues();
    if (data.length <= 1) {
      return { success: false, message: 'Nenhum usu√°rio cadastrado. Execute setup.' };
    }
    
    const headers = data[0];
    const emailIndex = headers.indexOf('EMAIL');
    const senhaIndex = headers.indexOf('SENHA');
    const nomeIndex = headers.indexOf('NOME');
    const tipoIndex = headers.indexOf('TIPO');
    const saldoIndex = headers.indexOf('SALDO');
    const idIndex = headers.indexOf('ID');
    const acessoIndex = headers.indexOf('ACESSO');
    
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      const userEmail = String(row[emailIndex] || '').trim();
      const userSenha = String(row[senhaIndex] || '').trim();
      
      if (userEmail === email && userSenha === password) {
        console.log('‚úÖ Login bem-sucedido para:', email);
        
        const user = {
          id: row[idIndex] || i,
          nome: row[nomeIndex] || '',
          email: userEmail,
          tipo: row[tipoIndex] || 'ouvinte',
          saldo: parseFloat(row[saldoIndex]) || 0,
          acesso: row[acessoIndex] || 'pendente',
          token: 'miv_' + Date.now() + '_' + (row[idIndex] || i)
        };
        
        if (user.acesso !== 'aprovado') {
          return {
            success: false,
            message: 'Conta aguardando aprova√ß√£o administrativa'
          };
        }
        
        return {
          success: true,
          data: user
        };
      }
    }
    
    return { success: false, message: 'Email ou senha incorretos' };
    
  } catch (error) {
    console.error('Erro em handleLogin:', error);
    return { success: false, message: 'Erro interno: ' + error.message };
  }
}

function handleRegister(params) {
  console.log('üìù handleRegister chamado:', params);
  
  if (!params || typeof params !== 'object') {
    return { success: false, message: 'Par√¢metros inv√°lidos' };
  }
  
  const nome = params.nome || params.registerName || '';
  const email = params.email || params.registerEmail || '';
  const password = params.pass || params.password || params.registerPassword || '';
  const tipo = params.tipo || params.registerType || '';
  const workLink = params.workLink || params.registerLink || '';
  
  if (!nome || !email || !password || !tipo) {
    return { success: false, message: 'Preencha todos os campos obrigat√≥rios' };
  }
  
  if (password.length < 6) {
    return { success: false, message: 'Senha deve ter pelo menos 6 caracteres' };
  }
  
  if (tipo === 'artista' && !workLink) {
    return { success: false, message: 'Artistas devem informar link do trabalho' };
  }
  
  try {
    const ss = getSpreadsheet();
    const sheet = ss.getSheetByName('USUARIOS');
    
    if (!sheet) {
      return { success: false, message: 'Sistema n√£o configurado' };
    }
    
    const data = sheet.getDataRange().getValues();
    const headers = data[0];
    const emailIndex = headers.indexOf('EMAIL');
    
    // Verifica se email j√° existe
    for (let i = 1; i < data.length; i++) {
      if (String(data[i][emailIndex]).trim() === email) {
        return { success: false, message: 'Email j√° cadastrado' };
      }
    }
    
    // Gera novo ID
    const lastId = data[data.length - 1][0] || 0;
    const newId = lastId + 1;
    
    // Adiciona novo usu√°rio
    sheet.appendRow([
      newId,
      nome,
      email,
      password,
      tipo,
      workLink,
      0, // saldo inicial
      'pendente', // acesso
      new Date().toISOString() // data_cadastro
    ]);
    
    logEvent('REGISTRO', `Novo usu√°rio: ${nome} (${email}) - Tipo: ${tipo}`);
    
    console.log('‚úÖ Usu√°rio registrado com sucesso:', { id: newId, email });
    
    return {
      success: true,
      message: 'Conta criada com sucesso! Aguarde aprova√ß√£o.',
      data: { id: newId, nome: nome }
    };
    
  } catch (error) {
    console.error('Erro em handleRegister:', error);
    return { success: false, message: 'Erro ao criar conta: ' + error.message };
  }
}

// ========== FUN√á√ïES DE M√öSICAS ==========
function getMusicas() {
  try {
    const ss = getSpreadsheet();
    const sheet = ss.getSheetByName('MUSICAS');
    
    if (!sheet) {
      console.log('üì≠ Sheet MUSICAS n√£o encontrada');
      return { success: true, data: [], message: 'Nenhuma m√∫sica cadastrada' };
    }
    
    const data = sheet.getDataRange().getValues();
    if (data.length <= 1) {
      return { success: true, data: [] };
    }
    
    const headers = data[0];
    
    const musicas = data.slice(1).map((row, index) => {
      const obj = {};
      headers.forEach((header, i) => {
        obj[header.toLowerCase()] = row[i];
      });
      obj.id = obj.id || (index + 1);
      return obj;
    }).filter(m => !m.status || m.status === 'ativo');
    
    console.log(`‚úÖ Retornando ${musicas.length} m√∫sicas`);
    return {
      success: true,
      data: musicas
    };
    
  } catch (error) {
    console.error('Erro em getMusicas:', error);
    return {
      success: false,
      message: 'Erro ao carregar m√∫sicas: ' + error.message,
      data: []
    };
  }
}

function uploadMusic(params) {
  console.log('üé∂ uploadMusic chamado:', params);
  
  if (!params || typeof params !== 'object') {
    return { success: false, message: 'Par√¢metros inv√°lidos' };
  }
  
  const user_id = params.user_id || '';
  const titulo = params.titulo || params.musicTitle || '';
  const artista = params.artista || params.musicArtist || '';
  const genero = params.genero || params.musicGenre || '';
  const link_youtube = params.link_youtube || params.musicYoutube || '';
  const link_capa = params.link_capa || params.musicCover || '';
  const valor_acao = params.valor_acao || params.musicPrice || '10';
  const percentual_disponivel = params.percentual_disponivel || params.musicPercent || '20';
  
  if (!titulo || !genero || !link_youtube) {
    return { success: false, message: 'Preencha t√≠tulo, g√™nero e link do YouTube' };
  }
  
  try {
    const ss = getSpreadsheet();
    const sheet = ss.getSheetByName('MUSICAS');
    
    if (!sheet) {
      return { success: false, message: 'Erro no servidor' };
    }
    
    const data = sheet.getDataRange().getValues();
    const lastId = data[data.length - 1][0] || 0;
    const newId = lastId + 1;
    
    sheet.appendRow([
      newId,
      titulo,
      artista,
      genero,
      link_youtube,
      link_capa || '',
      parseFloat(valor_acao) || 10.00,
      parseFloat(percentual_disponivel) || 20.00,
      0, // acoes_vendidas inicial
      'ativo',
      new Date().toISOString()
    ]);
    
    logEvent('UPLOAD_MUSICA', `Usu√°rio ${user_id} cadastrou m√∫sica: ${titulo}`);
    
    return {
      success: true,
      message: 'M√∫sica cadastrada com sucesso!',
      data: { id: newId, titulo: titulo }
    };
    
  } catch (error) {
    console.error('Erro em uploadMusic:', error);
    return { success: false, message: 'Erro ao cadastrar m√∫sica: ' + error.message };
  }
}

// ========== FUN√á√ïES FINANCEIRAS ==========
function criarSheetTransacoes() {
  try {
    const ss = getSpreadsheet();
    let sheet = ss.getSheetByName('TRANSACOES');

    if (!sheet) {
      sheet = ss.insertSheet('TRANSACOES');
      sheet.appendRow([
        'ID',
        'USER_ID',
        'TIPO',
        'VALOR',
        'SALDO_ANTES',
        'SALDO_DEPOIS',
        'REFERENCIA',
        'STATUS',
        'DATA'
      ]);
      
      sheet.getRange(1, 1, 1, 9).setFontWeight('bold').setBackground('#f0f0f0');
      sheet.setFrozenRows(1);
      sheet.autoResizeColumns(1, 9);
    }
    
    return true;
  } catch (error) {
    console.error('Erro ao criar sheet TRANSACOES:', error);
    return false;
  }
}

function registrarTransacao(userId, tipo, valor, saldoAntes, saldoDepois, referencia, status) {
  try {
    criarSheetTransacoes();
    
    const ss = getSpreadsheet();
    const sheet = ss.getSheetByName('TRANSACOES');
    
    const data = sheet.getDataRange().getValues();
    const lastId = data.length > 1 ? Number(data[data.length - 1][0]) || 0 : 0;

    sheet.appendRow([
      lastId + 1,
      userId,
      tipo,
      valor,
      saldoAntes,
      saldoDepois,
      referencia || '',
      status || 'CONFIRMADO',
      new Date().toISOString()
    ]);
    
    return true;
  } catch (error) {
    console.error('Erro em registrarTransacao:', error);
    return false;
  }
}

function getSaldo(params) {
  console.log('üí∞ getSaldo chamado com:', params);
  
  if (!params || !params.token) {
    return { success: false, message: 'Token n√£o fornecido' };
  }
  
  const ss = getSpreadsheet();
  const sheet = ss.getSheetByName('USUARIOS');
  
  if (!sheet) {
    return { success: false, message: 'Erro no servidor' };
  }
  
  try {
    const data = sheet.getDataRange().getValues();
    const headers = data[0];
    const idIndex = headers.indexOf('ID');
    const saldoIndex = headers.indexOf('SALDO');
    
    // Extrai user_id do token (formato: miv_TIMESTAMP_USERID)
    const tokenParts = params.token.split('_');
    const user_id = tokenParts.length >= 3 ? tokenParts[2] : params.token;
    
    console.log('Buscando saldo para user_id:', user_id);
    
    for (let i = 1; i < data.length; i++) {
      if (String(data[i][idIndex]) === String(user_id)) {
        const saldo = parseFloat(data[i][saldoIndex]) || 0;
        console.log('‚úÖ Saldo encontrado:', saldo);
        return {
          success: true,
          data: { saldo: saldo }
        };
      }
    }
    
    console.log('‚ùå Usu√°rio n√£o encontrado para token');
    return { success: false, message: 'Usu√°rio n√£o encontrado' };
    
  } catch (error) {
    console.error('Erro em getSaldo:', error);
    return { success: false, message: 'Erro ao buscar saldo: ' + error.message };
  }
}

function getResumoPortfolio(params) {
  console.log('üìä getResumoPortfolio chamado com:', params);
  
  if (!params || !params.token) {
    return { success: false, message: 'Token n√£o fornecido' };
  }
  
  try {
    // Obt√©m saldo
    const saldoRes = getSaldo(params);
    if (!saldoRes.success) {
      return saldoRes;
    }
    
    const saldo = saldoRes.data.saldo;
    
    // Extrai user_id do token
    const tokenParts = params.token.split('_');
    const user_id = tokenParts.length >= 3 ? tokenParts[2] : params.token;
    
    // Obt√©m valor da carteira
    const carteiraRes = getCarteira({ user_id: user_id });
    let patrimonio = 0;
    
    if (carteiraRes.success && carteiraRes.data) {
      patrimonio = carteiraRes.data.reduce((total, item) => {
        return total + (parseFloat(item.valor_total) || 0);
      }, 0);
    }
    
    const total = saldo + patrimonio;
    
    console.log('‚úÖ Resumo portfolio:', { saldo, patrimonio, total });
    
    return {
      success: true,
      data: {
        saldo: saldo,
        patrimonio: patrimonio,
        total: total
      }
    };
    
  } catch (error) {
    console.error('Erro em getResumoPortfolio:', error);
    return {
      success: false,
      message: 'Erro ao carregar resumo: ' + error.message,
      data: { saldo: 0, patrimonio: 0, total: 0 }
    };
  }
}

function buyShares(params) {
  console.log('üí≥ buyShares chamado com:', params);
  
  if (!params || !params.user_id || !params.music_id || !params.quantidade || !params.valor_total) {
    return { success: false, message: 'Par√¢metros incompletos' };
  }
  
  const user_id = params.user_id;
  const music_id = params.music_id;
  const quantidadeNum = parseInt(params.quantidade) || 0;
  const valorTotalNum = parseFloat(params.valor_total) || 0;
  
  if (quantidadeNum <= 0) {
    return { success: false, message: 'Quantidade inv√°lida' };
  }
  
  if (valorTotalNum <= 0) {
    return { success: false, message: 'Valor inv√°lido' };
  }
  
  const ss = getSpreadsheet();
  
  try {
    // 1. Verifica saldo do usu√°rio
    const usersSheet = ss.getSheetByName('USUARIOS');
    const usersData = usersSheet.getDataRange().getValues();
    const userHeaders = usersData[0];
    
    let userRow = -1;
    let userSaldo = 0;
    let userNome = '';
    
    for (let i = 1; i < usersData.length; i++) {
      if (String(usersData[i][userHeaders.indexOf('ID')]) === String(user_id)) {
        userRow = i + 1;
        userSaldo = parseFloat(usersData[i][userHeaders.indexOf('SALDO')]) || 0;
        userNome = usersData[i][userHeaders.indexOf('NOME')] || '';
        break;
      }
    }
    
    if (userRow === -1) {
      return { success: false, message: 'Usu√°rio n√£o encontrado' };
    }
    
    if (userSaldo < valorTotalNum) {
      return {
        success: false,
        message: `Saldo insuficiente. Dispon√≠vel: R$ ${userSaldo.toFixed(2)}`
      };
    }
    
    // 2. Verifica disponibilidade da m√∫sica
    const musicSheet = ss.getSheetByName('MUSICAS');
    const musicData = musicSheet.getDataRange().getValues();
    const musicHeaders = musicData[0];
    
    let musicRow = -1;
    let musicObj = {};
    
    for (let i = 1; i < musicData.length; i++) {
      if (String(musicData[i][musicHeaders.indexOf('ID')]) === String(music_id)) {
        musicRow = i + 1;
        musicHeaders.forEach((header, index) => {
          musicObj[header.toLowerCase()] = musicData[i][index];
        });
        break;
      }
    }
    
    if (musicRow === -1) {
      return { success: false, message: 'M√∫sica n√£o encontrada' };
    }
    
    const percentualDisponivel = parseFloat(musicObj.percentual_disponivel) || 0;
    const acoesVendidas = parseFloat(musicObj.acoes_vendidas) || 0;
    const totalAcoes = (percentualDisponivel / 0.01);
    const acoesDisponiveis = totalAcoes - acoesVendidas;
    
    if (quantidadeNum > acoesDisponiveis) {
      return {
        success: false,
        message: `Apenas ${acoesDisponiveis} a√ß√µes dispon√≠veis`
      };
    }
    
    // 3. Processa a compra
    const novoSaldo = userSaldo - valorTotalNum;
    usersSheet.getRange(userRow, userHeaders.indexOf('SALDO') + 1).setValue(novoSaldo);
    
    const novasAcoesVendidas = acoesVendidas + quantidadeNum;
    musicSheet.getRange(musicRow, musicHeaders.indexOf('ACOES_VENDIDAS') + 1)
      .setValue(novasAcoesVendidas);
    
    // 4. Registro financeiro LEDGER
    registrarTransacao(
      user_id,
      'COMPRA_ACOES',
      -valorTotalNum,
      userSaldo,
      novoSaldo,
      'COMPRA_MUSICA_' + music_id,
      'CONFIRMADO'
    );
    
    // 5. Adiciona √† carteira
    const carteiraSheet = ss.getSheetByName('CARTEIRA');
    const carteiraData = carteiraSheet.getDataRange().getValues();
    const lastCarteiraId = carteiraData.length > 1 ? carteiraData[carteiraData.length - 1][0] || 0 : 0;
    const novoCarteiraId = lastCarteiraId + 1;
    
    const valorPorAcao = valorTotalNum / quantidadeNum;
    
    carteiraSheet.appendRow([
      novoCarteiraId,
      user_id,
      music_id,
      quantidadeNum,
      valorPorAcao,
      valorTotalNum,
      new Date().toISOString()
    ]);
    
    // 6. Adiciona ao extrato
    const extratoSheet = ss.getSheetByName('EXTRATO');
    if (extratoSheet) {
      const extratoData = extratoSheet.getDataRange().getValues();
      const lastExtratoId = extratoData.length > 1 ? extratoData[extratoData.length - 1][0] || 0 : 0;
      const novoExtratoId = lastExtratoId + 1;
      
      extratoSheet.appendRow([
        novoExtratoId,
        user_id,
        'COMPRA_ACOES',
        `Compra de ${quantidadeNum} a√ß√£o(√µes) de "${musicObj.titulo}" - ${musicObj.artista}`,
        -valorTotalNum,
        new Date().toISOString()
      ]);
    }
    
    // 7. Log
    logEvent('COMPRA', `Usu√°rio ${userNome} (${user_id}) comprou ${quantidadeNum} a√ß√µes da m√∫sica ${music_id}`);
    
    console.log('‚úÖ Compra realizada com sucesso:', {
      user_id,
      novo_saldo: novoSaldo,
      saldo_anterior: userSaldo
    });
    
    return {
      success: true,
      message: 'Compra realizada com sucesso!',
      data: {
        novo_saldo: novoSaldo,
        saldo_anterior: userSaldo
      }
    };
    
  } catch (error) {
    console.error('Erro em buyShares:', error);
    return { success: false, message: 'Erro ao processar compra: ' + error.message };
  }
}

function confirmarDepositoPix(userId, valor, referenciaMP) {
  console.log('üì• confirmarDepositoPix chamado:', { userId, valor, referenciaMP });
  
  const ss = getSpreadsheet();
  const usersSheet = ss.getSheetByName('USUARIOS');
  const data = usersSheet.getDataRange().getValues();
  const headers = data[0];

  const colId = headers.indexOf('ID');
  const colSaldo = headers.indexOf('SALDO');

  for (let i = 1; i < data.length; i++) {
    if (String(data[i][colId]) === String(userId)) {
      const saldoAntes = Number(data[i][colSaldo]) || 0;
      const saldoDepois = saldoAntes + Number(valor);

      usersSheet.getRange(i + 1, colSaldo + 1).setValue(saldoDepois);

      registrarTransacao(
        userId,
        'DEPOSITO_CONFIRMADO',
        Number(valor),
        saldoAntes,
        saldoDepois,
        referenciaMP,
        'CONFIRMADO'
      );

      // Adiciona ao extrato
      const extratoSheet = ss.getSheetByName('EXTRATO');
      if (extratoSheet) {
        const extratoData = extratoSheet.getDataRange().getValues();
        const lastExtratoId = extratoData.length > 1 ? extratoData[extratoData.length - 1][0] || 0 : 0;
        
        extratoSheet.appendRow([
          lastExtratoId + 1,
          userId,
          'DEPOSITO',
          `Dep√≥sito via PIX - ${referenciaMP}`,
          Number(valor),
          new Date().toISOString()
        ]);
      }

      return { success: true, message: 'Dep√≥sito confirmado!' };
    }
  }

  return { success: false, error: 'Usu√°rio n√£o encontrado' };
}

function solicitarSaque(userId, valor) {
  console.log('üì§ solicitarSaque chamado:', { userId, valor });
  
  const ss = getSpreadsheet();
  const usersSheet = ss.getSheetByName('USUARIOS');
  const data = usersSheet.getDataRange().getValues();
  const headers = data[0];

  const colId = headers.indexOf('ID');
  const colSaldo = headers.indexOf('SALDO');

  for (let i = 1; i < data.length; i++) {
    if (String(data[i][colId]) === String(userId)) {
      const saldoAtual = Number(data[i][colSaldo]) || 0;

      if (saldoAtual < valor) {
        return { success: false, error: 'Saldo insuficiente' };
      }

      registrarTransacao(
        userId,
        'SAQUE_SOLICITADO',
        -valor,
        saldoAtual,
        saldoAtual,
        '',
        'PENDENTE'
      );

      return { success: true, message: 'Saque solicitado com sucesso!' };
    }
  }

  return { success: false, error: 'Usu√°rio n√£o encontrado' };
}

function confirmarSaque(userId, valor, referenciaMP) {
  console.log('‚úÖ confirmarSaque chamado:', { userId, valor, referenciaMP });
  
  const ss = getSpreadsheet();
  const usersSheet = ss.getSheetByName('USUARIOS');
  const data = usersSheet.getDataRange().getValues();
  const headers = data[0];

  const colId = headers.indexOf('ID');
  const colSaldo = headers.indexOf('SALDO');

  for (let i = 1; i < data.length; i++) {
    if (String(data[i][colId]) === String(userId)) {
      const saldoAntes = Number(data[i][colSaldo]) || 0;
      const saldoDepois = saldoAntes - Number(valor);

      usersSheet.getRange(i + 1, colSaldo + 1).setValue(saldoDepois);

      registrarTransacao(
        userId,
        'SAQUE_PAGO',
        -valor,
        saldoAntes,
        saldoDepois,
        referenciaMP,
        'CONFIRMADO'
      );

      // Adiciona ao extrato
      const extratoSheet = ss.getSheetByName('EXTRATO');
      if (extratoSheet) {
        const extratoData = extratoSheet.getDataRange().getValues();
        const lastExtratoId = extratoData.length > 1 ? extratoData[extratoData.length - 1][0] || 0 : 0;
        
        extratoSheet.appendRow([
          lastExtratoId + 1,
          userId,
          'SAQUE',
          `Saque realizado - ${referenciaMP}`,
          -Number(valor),
          new Date().toISOString()
        ]);
      }

      return { success: true, message: 'Saque confirmado!' };
    }
  }

  return { success: false, error: 'Usu√°rio n√£o encontrado' };
}

function getHistoricoFinanceiro(userId) {
  console.log('üìã getHistoricoFinanceiro chamado:', userId);
  
  const ss = getSpreadsheet();
  const sheet = ss.getSheetByName('TRANSACOES');
  
  if (!sheet) {
    return { success: true, data: [], message: 'Nenhuma transa√ß√£o encontrada' };
  }
  
  const data = sheet.getDataRange().getValues();
  const headers = data[0];
  
  const historico = data.slice(1)
    .filter(row => row[headers.indexOf('USER_ID')].toString() === String(userId))
    .map(row => {
      const obj = {};
      headers.forEach((header, index) => {
        obj[header.toLowerCase()] = row[index];
      });
      return obj;
    })
    .sort((a, b) => new Date(b.data) - new Date(a.data));
  
  return {
    success: true,
    data: historico
  };
}

// ========== FUN√á√ïES DE PORTF√ìLIO E EXTRATO ==========
function getCarteira(params) {
  console.log('üíº getCarteira chamado com:', params);
  
  if (!params || !params.user_id) {
    return { success: true, data: [] };
  }
  
  const ss = getSpreadsheet();
  const sheet = ss.getSheetByName('CARTEIRA');
  
  if (!sheet) {
    return { success: true, data: [] };
  }
  
  const data = sheet.getDataRange().getValues();
  const headers = data[0];
  
  const carteira = data.slice(1)
    .filter(row => row[headers.indexOf('USER_ID')].toString() === String(params.user_id))
    .map(row => {
      const obj = {};
      headers.forEach((header, index) => {
        obj[header.toLowerCase()] = row[index];
      });
      return obj;
    });
  
  console.log(`‚úÖ Retornando ${carteira.length} itens da carteira`);
  return {
    success: true,
    data: carteira
  };
}

function getExtrato(params) {
  console.log('üßæ getExtrato chamado com:', params);
  
  if (!params || !params.user_id) {
    return { success: true, data: [] };
  }
  
  const ss = getSpreadsheet();
  const sheet = ss.getSheetByName('EXTRATO');
  
  if (!sheet) {
    return { success: true, data: [] };
  }
  
  const data = sheet.getDataRange().getValues();
  const headers = data[0];
  
  const extrato = data.slice(1)
    .filter(row => row[headers.indexOf('USER_ID')].toString() === String(params.user_id))
    .map(row => {
      const obj = {};
      headers.forEach((header, index) => {
        obj[header.toLowerCase()] = row[index];
      });
      return obj;
    });
  
  console.log(`‚úÖ Retornando ${extrato.length} itens do extrato`);
  return {
    success: true,
    data: extrato
  };
}

// ========== FUN√á√ïES DE ARTISTA ==========
function getArtistData(params) {
  console.log('üé§ getArtistData chamado com:', params);
  
  if (!params || !params.user_id) {
    return { success: false, message: 'ID do usu√°rio n√£o fornecido' };
  }
  
  const ss = getSpreadsheet();
  
  // Primeiro obt√©m o nome do artista
  const usersSheet = ss.getSheetByName('USUARIOS');
  const usersData = usersSheet.getDataRange().getValues();
  const userHeaders = usersData[0];
  
  let artistaNome = '';
  let artistaId = '';
  for (let i = 1; i < usersData.length; i++) {
    if (String(usersData[i][userHeaders.indexOf('ID')]) === String(params.user_id)) {
      artistaNome = usersData[i][userHeaders.indexOf('NOME')] || '';
      artistaId = usersData[i][userHeaders.indexOf('ID')] || '';
      break;
    }
  }
  
  if (!artistaNome) {
    return { success: false, message: 'Artista n√£o encontrado' };
  }
  
  // Obt√©m m√∫sicas do artista
  const musicasSheet = ss.getSheetByName('MUSICAS');
  const musicasData = musicasSheet.getDataRange().getValues();
  const musicasHeaders = musicasData[0];
  
  const artistMusics = musicasData.slice(1)
    .filter(row => row[musicasHeaders.indexOf('ARTISTA')] === artistaNome)
    .map(row => {
      const obj = {};
      musicasHeaders.forEach((header, index) => {
        obj[header.toLowerCase()] = row[index];
      });
      
      // Calcula estat√≠sticas
      const percentualDisponivel = parseFloat(obj.percentual_disponivel) || 0;
      const acoesVendidas = parseFloat(obj.acoes_vendidas) || 0;
      const valorAcao = parseFloat(obj.valor_acao) || 0;
      const totalAcoes = (percentualDisponivel / 0.01);
      obj.percentual_vendido = totalAcoes > 0 ? (acoesVendidas / totalAcoes * 100) : 0;
      obj.arrecadacao_total = acoesVendidas * valorAcao;
      obj.acoes_disponiveis = totalAcoes - acoesVendidas;
      
      return obj;
    });
  
  // Calcula estat√≠sticas gerais
  const totalMusicas = artistMusics.length;
  const totalRoyalties = artistMusics.reduce((sum, music) => sum + (music.arrecadacao_total || 0), 0);
  const totalAcoesVendidas = artistMusics.reduce((sum, music) => sum + (parseFloat(music.acoes_vendidas) || 0), 0);
  
  console.log(`‚úÖ Dados do artista ${artistaNome}:`, {
    totalMusicas,
    totalRoyalties,
    totalAcoesVendidas
  });
  
  return {
    success: true,
    data: {
      artista_id: artistaId,
      artista: artistaNome,
      total_musicas: totalMusicas,
      total_royalties: totalRoyalties,
      total_acoes_vendidas: totalAcoesVendidas,
      musicas: artistMusics
    }
  };
}

// ========== FUN√á√ÉO DE LOG ==========
function logEvent(tipo, descricao) {
  try {
    const ss = getSpreadsheet();
    let sheet = ss.getSheetByName('LOG');
    
    if (!sheet) {
      sheet = ss.insertSheet('LOG');
      sheet.appendRow(['ID', 'TIPO', 'DESCRICAO', 'DATA']);
    }
    
    const data = sheet.getDataRange().getValues();
    const lastId = data.length > 1 ? data[data.length - 1][0] || 0 : 0;
    const newId = lastId + 1;
    
    sheet.appendRow([
      newId,
      tipo,
      descricao,
      new Date().toISOString()
    ]);
    
    console.log(`üìù LOG [${tipo}]: ${descricao}`);
  } catch (error) {
    console.error('Erro ao registrar log:', error);
  }
}

// ========== FUN√á√ïES DE TESTE E DEPURA√á√ÉO ==========
function testAPI() {
  return {
    success: true,
    message: 'API est√° funcionando!',
    timestamp: new Date().toISOString(),
    sheets: ['USUARIOS', 'MUSICAS', 'CARTEIRA', 'EXTRATO', 'TRANSACOES', 'LOG']
  };
}

function testLogin() {
  const testParams = {
    email: 'admin@miv.com',
    password: 'admin123'
  };
  
  return handleLogin(testParams);
}

function testSetup() {
  try {
    const ss = getSpreadsheet();
    const sheets = ss.getSheets();
    const sheetNames = sheets.map(s => s.getName());
    
    return {
      success: true,
      sheets: sheetNames,
      count: sheetNames.length
    };
  } catch (error) {
    return {
      success: false,
      error: error.message
    };
  }
}

// ========== FUN√á√ÉO PRINCIPAL DE SETUP ==========
function setupSpreadsheet() {
  console.log('üîß Iniciando setup da planilha...');
  
  try {
    const ss = getSpreadsheet();
    
    // Remove sheets antigos
    const sheetsToRemove = ['Sheet1', 'Sheet2', 'Sheet3', 'Planilha1'];
    sheetsToRemove.forEach(sheetName => {
      const sheet = ss.getSheetByName(sheetName);
      if (sheet && sheetName !== 'TRANSACOES' && sheetName !== 'LOG') {
        ss.deleteSheet(sheet);
      }
    });
    
    // Sheets necess√°rios com dados de exemplo
    const sheetsConfig = [
      {
        name: 'USUARIOS',
        headers: ['ID', 'NOME', 'EMAIL', 'SENHA', 'TIPO', 'WORKLINK', 'SALDO', 'ACESSO', 'DATA_CADASTRO'],
        sampleData: [
          [1, 'Administrador', 'admin@miv.com', 'admin123', 'admin', '', 10000, 'aprovado', new Date().toISOString()],
          [2, 'Elzo Henschell', 'elzo@artista.com', 'elzo123', 'artista', 'https://youtube.com/elzo', 5000, 'aprovado', new Date().toISOString()],
          [3, 'Investidor Teste', 'investidor@teste.com', 'teste123', 'ouvinte', '', 2000, 'aprovado', new Date().toISOString()]
        ]
      },
      {
        name: 'MUSICAS',
        headers: ['ID', 'TITULO', 'ARTISTA', 'GENERO', 'LINK_YOUTUBE', 'LINK_CAPA', 'VALOR_ACAO', 'PERCENTUAL_DISPONIVEL', 'ACOES_VENDIDAS', 'STATUS', 'DATA_CADASTRO'],
        sampleData: [
          [1, 'EVA', 'Elzo Henschell', 'ROCK', 'https://www.youtube.com/watch?v=bFqLIyxuiMM', 'https://i.ytimg.com/vi/bFqLIyxuiMM/hqdefault.jpg', 15.50, 25, 75, 'ativo', new Date().toISOString()],
          [2, 'O M√°ximo', 'Elzo Henschell', 'ROCK', 'https://youtu.be/utoRQzolfqs', 'https://i9.ytimg.com/vi_webp/utoRQzolfqs/mqdefault.webp', 22.00, 40, 60, 'ativo', new Date().toISOString()],
          [3, 'Som ON', 'Selo MIV', 'INSTRUMENTAL', 'https://youtu.be/O4vSvOLtkuM', 'https://via.placeholder.com/300x300/111418/00ff88?text=MIV', 18.75, 35, 65, 'ativo', new Date().toISOString()]
        ]
      },
      {
        name: 'CARTEIRA',
        headers: ['ID', 'USER_ID', 'MUSIC_ID', 'QUANTIDADE', 'VALOR_PAGO_POR_ACAO', 'VALOR_TOTAL', 'DATA_COMPRA'],
        sampleData: [
          [1, 3, 1, 5, 15.50, 77.50, new Date().toISOString()],
          [2, 3, 2, 3, 22.00, 66.00, new Date().toISOString()]
        ]
      },
      {
        name: 'EXTRATO',
        headers: ['ID', 'USER_ID', 'TIPO', 'DESCRICAO', 'VALOR', 'DATA'],
        sampleData: [
          [1, 3, 'DEPOSITO', 'Dep√≥sito inicial', 2000, new Date().toISOString()],
          [2, 3, 'COMPRA_ACOES', 'Compra de 5 a√ß√£o(√µes) de "EVA" - Elzo Henschell', -77.50, new Date().toISOString()],
          [3, 3, 'COMPRA_ACOES', 'Compra de 3 a√ß√£o(√µes) de "O M√°ximo" - Elzo Henschell', -66.00, new Date().toISOString()]
        ]
      },
      {
        name: 'TRANSACOES',
        headers: ['ID', 'USER_ID', 'TIPO', 'VALOR', 'SALDO_ANTES', 'SALDO_DEPOIS', 'REFERENCIA', 'STATUS', 'DATA'],
        sampleData: [
          [1, 3, 'DEPOSITO_INICIAL', 2000, 0, 2000, 'SISTEMA', 'CONFIRMADO', new Date().toISOString()],
          [2, 3, 'COMPRA_ACOES', -77.50, 2000, 1922.50, 'COMPRA_MUSICA_1', 'CONFIRMADO', new Date().toISOString()],
          [3, 3, 'COMPRA_ACOES', -66.00, 1922.50, 1856.50, 'COMPRA_MUSICA_2', 'CONFIRMADO', new Date().toISOString()]
        ]
      },
      {
        name: 'LOG',
        headers: ['ID', 'TIPO', 'DESCRICAO', 'DATA'],
        sampleData: [
          [1, 'SISTEMA', 'Setup inicial', new Date().toISOString()]
        ]
      }
    ];
    
    // Cria ou atualiza cada sheet
    sheetsConfig.forEach(config => {
      console.log(`üìä Processando sheet: ${config.name}`);
      
      let sheet = ss.getSheetByName(config.name);
      
      if (!sheet) {
        sheet = ss.insertSheet(config.name);
        console.log(`‚úÖ Sheet ${config.name} criada`);
      } else {
        // Limpa apenas se for menor que 100 linhas (para n√£o perder dados grandes)
        const lastRow = sheet.getLastRow();
        if (lastRow < 100) {
          sheet.clear();
          console.log(`üîÑ Sheet ${config.name} limpa`);
        } else {
          console.log(`üìà Sheet ${config.name} mantida (${lastRow} linhas)`);
        }
      }
      
      // Adiciona headers
      sheet.getRange(1, 1, 1, config.headers.length).setValues([config.headers]);
      
      // Adiciona dados de exemplo se fornecidos
      if (config.sampleData && config.sampleData.length > 0) {
        sheet.getRange(2, 1, config.sampleData.length, config.headers.length).setValues(config.sampleData);
        console.log(`üìù Adicionados ${config.sampleData.length} registros de exemplo`);
      }
      
      // Formata√ß√£o
      sheet.getRange(1, 1, 1, config.headers.length)
        .setFontWeight('bold')
        .setBackground('#f0f0f0')
        .setHorizontalAlignment('center');
      
      sheet.setFrozenRows(1);
      sheet.autoResizeColumns(1, config.headers.length);
      
      // Formata n√∫meros
      if (config.name === 'USUARIOS') {
        sheet.getRange('G:G').setNumberFormat('"R$ "#,##0.00');
      }
      if (config.name === 'MUSICAS') {
        sheet.getRange('G:H').setNumberFormat('0.00');
        sheet.getRange('I:I').setNumberFormat('0');
      }
      if (config.name === 'CARTEIRA') {
        sheet.getRange('D:F').setNumberFormat('0.00');
      }
      if (config.name === 'EXTRATO') {
        sheet.getRange('E:E').setNumberFormat('"R$ "#,##0.00');
      }
      if (config.name === 'TRANSACOES') {
        sheet.getRange('D:F').setNumberFormat('"R$ "#,##0.00');
      }
    });
    
    logEvent('SETUP', 'Planilha configurada com sucesso');
    
    console.log('‚úÖ Setup completo!');
    return {
      success: true,
      message: 'üéâ Planilha MIV configurada com sucesso!',
      timestamp: new Date().toISOString(),
      login_test: {
        email: 'admin@miv.com',
        password: 'admin123',
        url: ScriptApp.getService().getUrl() + '?action=login&email=admin@miv.com&password=admin123'
      }
    };
    
  } catch (error) {
    console.error('‚ùå Erro no setup:', error);
    return {
      success: false,
      message: '‚ùå Erro no setup: ' + error.message,
      error: error.toString()
    };
  }
}

function runSetup() {
  return setupSpreadsheet();
}

// ========== FUN√á√ÉO DE INICIALIZA√á√ÉO SIMPLES ==========
function init() {
  // Verifica se as sheets b√°sicas existem
  const ss = getSpreadsheet();
  const requiredSheets = ['USUARIOS', 'MUSICAS', 'CARTEIRA', 'EXTRATO'];
  const missingSheets = [];
  
  requiredSheets.forEach(sheetName => {
    if (!ss.getSheetByName(sheetName)) {
      missingSheets.push(sheetName);
    }
  });
  
  if (missingSheets.length === 0) {
    return {
      success: true,
      message: 'Sistema j√° inicializado',
      sheets: requiredSheets
    };
  } else {
    // Executa setup autom√°tico
    return runSetup();
  }
}

// Execute esta fun√ß√£o para iniciar o sistema
function iniciarSistema() {
  console.log('üöÄ Iniciando sistema MIV...');
  return init();
}
```

## **2. C√ìDIGO HTML DO FRONTEND (com corre√ß√µes)**

```html
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SELO MIV | Fintech Musical</title>

    <!-- Bootstrap 5.3.0 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;700&display=swap" rel="stylesheet">

    <style>
        /* ========== VARI√ÅVEIS CSS ========== */
        :root {
            --neon-green: #00ff88;
            --miv-blue: #0072ff;
            --bg-dark: #07090c;
            --bg-card: #111418;
            --border: #1e2329;
            --text-light: #f8f9fa;
            --text-muted: #6c757d;
        }

        /* ========== RESET & BASE ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-light);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ========== LOADING SCREEN ========== */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.3s ease;
        }

        .loading-content {
            text-align: center;
        }

        .loading-spinner {
            width: 4rem;
            height: 4rem;
            border: 0.25rem solid rgba(0, 255, 136, 0.3);
            border-top-color: var(--neon-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1.5rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ========== AUTH SCREEN ========== */
        .auth-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #0c0e12 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            z-index: 9998;
            overflow-y: auto;
        }

        .auth-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 1.5rem;
            padding: 2.5rem;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            transform: translateY(0);
            transition: transform 0.3s ease;
        }

        .auth-card:hover {
            transform: translateY(-5px);
        }

        .logo-header {
            text-align: center;
            margin-bottom: 2.5rem;
        }

        .logo-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 80px;
            height: 80px;
            background: rgba(0, 255, 136, 0.1);
            border-radius: 50%;
            margin-bottom: 1.5rem;
            border: 2px solid var(--neon-green);
        }

        .logo-icon i {
            font-size: 2.5rem;
            color: var(--neon-green);
        }

        /* ========== FORMS ========== */
        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-control-custom {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            color: var(--text-light);
            padding: 0.875rem 1rem;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-control-custom:focus {
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--neon-green);
            color: var(--text-light);
            box-shadow: 0 0 0 0.25rem rgba(0, 255, 136, 0.25);
        }

        .form-control-custom::placeholder {
            color: var(--text-muted);
        }

        .btn-miv {
            background: linear-gradient(135deg, var(--neon-green) 0%, #00cc6a 100%);
            border: none;
            border-radius: 0.75rem;
            color: #000;
            font-weight: 700;
            padding: 1rem 1.5rem;
            font-size: 1rem;
            transition: all 0.3s ease;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            width: 100%;
        }

        .btn-miv:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 255, 136, 0.3);
        }

        .btn-miv:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .auth-link {
            color: var(--neon-green);
            text-decoration: none;
            font-weight: 600;
            transition: opacity 0.3s ease;
        }

        .auth-link:hover {
            opacity: 0.8;
            text-decoration: underline;
        }

        /* ========== MAIN APP ========== */
        .main-app {
            display: none;
            min-height: 100vh;
            padding-bottom: 5rem;
        }

        /* Header */
        .app-header {
            background: linear-gradient(180deg, rgba(0, 255, 136, 0.1) 0%, rgba(7, 9, 12, 0.8) 100%);
            backdrop-filter: blur(10px);
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .saldo-display h6 {
            color: var(--text-muted);
            font-size: 0.75rem;
            margin-bottom: 0.25rem;
        }

        .saldo-display h4 {
            color: var(--neon-green);
            font-weight: 700;
            margin-bottom: 0;
        }

        .user-badge {
            background: var(--neon-green);
            color: #000;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 700;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            top: 0;
            left: -300px;
            width: 300px;
            height: 100vh;
            background: #000;
            border-right: 1px solid var(--border);
            z-index: 1100;
            transition: left 0.3s ease;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .sidebar.open {
            left: 0;
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-close {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.25rem;
        }

        .nav-menu {
            list-style: none;
            padding: 0;
        }

        .nav-item {
            margin-bottom: 0.5rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.875rem 1rem;
            color: var(--text-muted);
            text-decoration: none;
            border-radius: 0.75rem;
            transition: all 0.3s ease;
        }

        .nav-link:hover,
        .nav-link.active {
            background: rgba(0, 255, 136, 0.1);
            color: var(--neon-green);
        }

        .nav-link i {
            font-size: 1.25rem;
        }

        /* Content Sections */
        .section {
            display: none;
            padding: 1.5rem;
            animation: fadeIn 0.3s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .section-title {
            color: var(--text-light);
            font-weight: 700;
            margin-bottom: 0;
        }

        /* Music Cards */
        .music-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .music-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 1rem;
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .music-card:hover {
            transform: translateY(-5px);
            border-color: var(--neon-green);
            box-shadow: 0 10px 20px rgba(0, 255, 136, 0.1);
        }

        .music-cover {
            width: 100%;
            height: 180px;
            object-fit: cover;
        }

        .music-info {
            padding: 1rem;
        }

        .music-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: var(--text-light);
        }

        .music-artist {
            color: var(--text-muted);
            font-size: 0.875rem;
            margin-bottom: 0.75rem;
        }

        .music-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .music-price {
            color: var(--neon-green);
            font-weight: 700;
            font-size: 1.125rem;
        }

        .music-percent {
            background: rgba(0, 123, 255, 0.1);
            color: #007bff;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* Player - Estilo Spotify */
        .player-bar {
            position: fixed;
            bottom: 5rem;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            padding: 1rem;
            z-index: 1000;
            transition: all 0.3s ease;
            display: none;
        }

        .player-bar.expanded {
            bottom: 0;
            height: 100vh;
            background: rgba(17, 20, 24, 0.98);
            backdrop-filter: blur(20px);
        }

        .player-content {
            max-width: 1200px;
            margin: 0 auto;
        }

        .video-container {
            width: 100%;
            aspect-ratio: 16/9;
            background: #000;
            border-radius: 1rem;
            overflow: hidden;
            margin-bottom: 1.5rem;
            display: none;
        }

        .player-bar.expanded .video-container {
            display: block;
        }

        .player-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
            cursor: pointer;
        }

        .player-album-art {
            width: 60px;
            height: 60px;
            border-radius: 0.75rem;
            object-fit: cover;
        }

        .player-text {
            flex: 1;
        }

        .player-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .player-artist {
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .player-price {
            color: var(--neon-green);
            font-weight: 700;
        }

        .progress-container {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            margin: 1rem 0;
            cursor: pointer;
        }

        .progress-bar {
            height: 100%;
            background: var(--neon-green);
            border-radius: 3px;
            width: 0%;
            transition: width 0.1s linear;
        }

        .player-time {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .player-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .control-btn {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 0.5rem;
        }

        .control-btn:hover {
            color: var(--neon-green);
            transform: scale(1.1);
        }

        .play-btn {
            font-size: 2.5rem;
        }

        #queueContainer {
            max-height: 40vh;
            overflow-y: auto;
        }

        #queueList .list-group-item {
            background: transparent;
            border: none;
            color: var(--text-light);
            cursor: pointer;
        }

        #queueList .list-group-item.active {
            background: rgba(0, 255, 136, 0.2);
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #000;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            padding: 0.75rem 0;
            z-index: 1001;
        }

        .nav-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            padding: 0.5rem;
            cursor: pointer;
            transition: color 0.3s ease;
            flex: 1;
        }

        .nav-btn:hover,
        .nav-btn.active {
            color: var(--neon-green);
        }

        .nav-btn i {
            font-size: 1.25rem;
        }

        .nav-btn span {
            font-size: 0.75rem;
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 1rem;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 1rem;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            color: var(--text-light);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.25rem;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        /* Toast */
        .toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 9999;
        }

        .toast {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast.success {
            border-left: 4px solid var(--neon-green);
        }

        .toast.error {
            border-left: 4px solid #ff4444;
        }

        .toast-icon {
            font-size: 1.25rem;
        }

        .toast.success .toast-icon {
            color: var(--neon-green);
        }

        .toast.error .toast-icon {
            color: #ff4444;
        }

        /* Portfolio Stats */
        .portfolio-summary {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.1) 0%, rgba(7, 9, 12, 0.8) 100%);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
            text-align: center;
        }

        .portfolio-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--neon-green);
            margin: 0.5rem 0;
        }

        /* Artist Stats */
        .artist-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: center;
        }

        .stat-icon {
            font-size: 2rem;
            color: var(--neon-green);
            margin-bottom: 1rem;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-light);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
        }

        .empty-icon {
            font-size: 3rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
        }

        /* Ledger Table */
        .ledger-table {
            width: 100%;
            border-collapse: collapse;
        }

        .ledger-table th {
            padding: 1rem;
            text-align: left;
            border-bottom: 2px solid var(--border);
            color: var(--text-muted);
            font-weight: 600;
        }

        .ledger-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .ledger-table tbody tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        /* Finance Dashboard */
        .finance-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .transaction-item:last-child {
            border-bottom: none;
        }

        .transaction-type {
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .transaction-type.deposit {
            background: rgba(0, 255, 136, 0.1);
            color: var(--neon-green);
        }

        .transaction-type.withdraw {
            background: rgba(255, 68, 68, 0.1);
            color: #ff4444;
        }

        .transaction-type.purchase {
            background: rgba(0, 123, 255, 0.1);
            color: #007bff;
        }

        /* ========== CORRE√á√ÉO DE IMAGENS ========== */
        .music-cover[src*="via.placeholder.com"],
        .music-cover:not([src]),
        #playerAlbumArt[src*="via.placeholder.com"] {
            background: linear-gradient(135deg, #111418 0%, #0a0d12 100%);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .music-cover[src*="via.placeholder.com"]::after,
        .music-cover:not([src])::after {
            content: '‚ô´ MIV';
            color: #00ff88;
            font-weight: bold;
            font-size: 16px;
        }

        #playerAlbumArt[src*="via.placeholder.com"]::after {
            content: 'M';
            color: #00ff88;
            font-weight: bold;
            font-size: 24px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .music-grid {
                grid-template-columns: 1fr;
            }
            
            .artist-stats {
                grid-template-columns: 1fr;
            }
            
            .header-content {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h4 class="text-success mb-2">Conectando ao SELO MIV</h4>
            <p class="text-muted" id="loadingMessage">Inicializando sistema...</p>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Authentication Screen -->
    <div id="authScreen" class="auth-screen">
        <div class="auth-card">
            <div class="logo-header">
                <div class="logo-icon">
                    <i class="bi bi-shield-lock"></i>
                </div>
                <h2 class="text-white mb-2">SELO MIV</h2>
                <p class="text-muted">Plataforma de Investimento em M√∫sica</p>
            </div>

            <!-- Login Form -->
            <div id="loginForm">
                <div id="loginMessage" class="alert d-none"></div>

                <div class="form-group">
                    <label for="loginEmail" class="text-muted mb-2 d-block">E-mail</label>
                    <input type="email" id="loginEmail" class="form-control-custom" placeholder="E-mail" required>
                </div>

                <div class="form-group">
                    <label for="loginPassword" class="text-muted mb-2 d-block">Senha</label>
                    <input type="password" id="loginPassword" class="form-control-custom" placeholder="Senha" required>
                </div>

                <button class="btn-miv mb-3" onclick="handleLogin()">
                    <i class="bi bi-box-arrow-in-right"></i>
                    Entrar
                </button>

                <p class="text-center text-muted">
                    Novo por aqui?
                    <a href="javascript:void(0)" class="auth-link" onclick="showRegisterForm()">
                        Criar conta
                    </a>
                </p>

                <div class="text-center mt-3">
                    <small class="text-muted">
                        <i class="bi bi-info-circle me-1"></i>
                        Use: admin@miv.com / admin123
                    </small>
                </div>
            </div>

            <!-- Register Form -->
            <div id="registerForm" style="display: none;">
                <div id="registerMessage" class="alert d-none"></div>

                <div class="form-group">
                    <label for="registerName" class="text-muted mb-2 d-block">Nome completo *</label>
                    <input type="text" id="registerName" class="form-control-custom" placeholder="Nome completo" required>
                </div>

                <div class="form-group">
                    <label for="registerEmail" class="text-muted mb-2 d-block">E-mail *</label>
                    <input type="email" id="registerEmail" class="form-control-custom" placeholder="E-mail" required>
                </div>

                <div class="form-group">
                    <label for="registerPassword" class="text-muted mb-2 d-block">Senha (m√≠nimo 6 caracteres) *</label>
                    <input type="password" id="registerPassword" class="form-control-custom" placeholder="Senha (m√≠nimo 6 caracteres)" required minlength="6">
                </div>

                <div class="form-group">
                    <label for="registerType" class="text-muted mb-2 d-block">Perfil *</label>
                    <select id="registerType" class="form-control-custom" onchange="toggleArtistField()">
                        <option value="">Selecione seu perfil...</option>
                        <option value="ouvinte">üéß Ouvinte/Investidor</option>
                        <option value="artista">üé∏ Artista</option>
                    </select>
                </div>

                <div class="form-group" id="artistLinkField" style="display: none;">
                    <label for="registerLink" class="text-muted mb-2 d-block">Link do seu trabalho (YouTube, Spotify, etc.)</label>
                    <input type="url" id="registerLink" class="form-control-custom" placeholder="Link do seu trabalho (YouTube, Spotify, etc.)">
                    <small class="text-muted">Para artistas: informe um link do seu portf√≥lio</small>
                </div>

                <button class="btn-miv mb-3" onclick="handleRegister()">
                    <i class="bi bi-person-plus"></i>
                    Solicitar Cadastro
                </button>

                <p class="text-center text-muted">
                    J√° tem conta?
                    <a href="javascript:void(0)" class="auth-link" onclick="showLoginForm()">
                        Fazer login
                    </a>
                </p>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="main-app">
        <!-- Sidebar -->
        <div id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h4 class="text-white mb-0">üéµ MIV PRO</h4>
                <button class="sidebar-close" onclick="toggleSidebar()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>

            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="#" class="nav-link active" onclick="changeSection('marketplace')">
                        <i class="bi bi-house"></i>
                        <span>Marketplace</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="changeSection('portfolio')">
                        <i class="bi bi-briefcase"></i>
                        <span>Portf√≥lio</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="changeSection('ledger')">
                        <i class="bi bi-receipt"></i>
                        <span>Extrato</span>
                    </a>
                </li>
                <li class="nav-item" id="artistNavItem" style="display: none;">
                    <a href="#" class="nav-link" onclick="changeSection('artist')">
                        <i class="bi bi-mic"></i>
                        <span>Painel Artista</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="https://link.mercadopago.com.br/selomiv" target="_blank" class="nav-link">
                        <i class="bi bi-plus-circle text-success"></i>
                        <span class="text-success">Adicionar Saldo</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link text-danger" onclick="logout()">
                        <i class="bi bi-box-arrow-right"></i>
                        <span>Sair</span>
                    </a>
                </li>
            </ul>
        </div>

        <!-- Main Header -->
        <header class="app-header">
            <div class="header-content">
                <div class="d-flex align-items-center">
                    <button class="btn text-white me-3" onclick="toggleSidebar()">
                        <i class="bi bi-list fs-3"></i>
                    </button>
                    <div class="saldo-display">
                        <h6>CR√âDITO DISPON√çVEL</h6>
                        <h4 id="currentBalance">R$ 0,00</h4>
                    </div>
                </div>
                <div class="user-badge" id="userBadge">Ouvinte</div>
            </div>
        </header>

        <!-- Main Content -->
        <main>
            <!-- Marketplace Section -->
            <section id="marketplaceSection" class="section active">
                <div class="section-header">
                    <h2 class="section-title">üéµ Marketplace</h2>
                    <div>
                        <small class="text-muted">Taxa 0% em compras</small>
                    </div>
                </div>
                <div id="marketplaceContent" class="music-grid">
                    <!-- Music cards will be loaded here -->
                </div>
            </section>

            <!-- Portfolio Section -->
            <section id="portfolioSection" class="section">
                <div class="portfolio-summary">
                    <h6 class="text-muted">VALOR TOTAL DA CARTEIRA</h6>
                    <div class="portfolio-value" id="portfolioValue">R$ 0,00</div>
                    <small class="text-muted">Atualizado em tempo real</small>
                </div>

                <div class="section-header">
                    <h2 class="section-title">üìä Meus Ativos</h2>
                    <span class="badge bg-secondary" id="assetsCount">0 ativos</span>
                </div>

                <div id="portfolioContent">
                    <!-- Portfolio assets will be loaded here -->
                </div>
            </section>

            <!-- Ledger Section -->
            <section id="ledgerSection" class="section">
                <div class="section-header">
                    <h2 class="section-title">üìã Hist√≥rico Financeiro</h2>
                    <button class="btn btn-sm btn-outline-success" onclick="loadLedger()">
                        <i class="bi bi-arrow-clockwise"></i> Atualizar
                    </button>
                </div>

                <div id="ledgerContent" class="finance-card">
                    <!-- Financial transactions will be loaded here -->
                </div>
            </section>

            <!-- Artist Panel Section -->
            <section id="artistSection" class="section">
                <div class="section-header">
                    <h2 class="section-title">üé§ Painel Artista</h2>
                    <button class="btn-miv btn-sm" onclick="openAddMusicModal()">
                        <i class="bi bi-plus-circle"></i> Nova M√∫sica
                    </button>
                </div>

                <div class="artist-stats">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="bi bi-music-note-beamed"></i>
                        </div>
                        <div class="stat-value" id="artistMusicCount">0</div>
                        <div class="stat-label">M√∫sicas Cadastradas</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="bi bi-cash-coin"></i>
                        </div>
                        <div class="stat-value" id="artistRoyalties">R$ 0,00</div>
                        <div class="stat-label">Royalties Acumulados</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="bi bi-bar-chart"></i>
                        </div>
                        <div class="stat-value" id="artistSharesSold">0</div>
                        <div class="stat-label">A√ß√µes Vendidas</div>
                    </div>
                </div>

                <h5 class="mb-3">Minhas M√∫sicas</h5>
                <div id="artistMusicContent" class="music-grid">
                    <!-- Artist's music will be loaded here -->
                </div>
            </section>
        </main>

        <!-- Music Player (Spotify-like) -->
        <div id="playerBar" class="player-bar">
            <div class="player-content">
                <div class="video-container" id="videoContainer">
                    <div id="youtubePlayer"></div>
                </div>

                <div class="player-info" onclick="togglePlayerExpansion()">
                    <img id="playerAlbumArt" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iIzExMTQxOCIvPjxyZWN0IHg9IjEwIiB5PSIxMCIgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiBmaWxsPSIjMDBmZjg4IiBvcGFjaXR5PSIwLjIiIHJ4PSI1Ii8+PHBhdGggZD0iTTIwLDIwIEw0MCwzMCBMMjAsNDAgWiIgZmlsbD0iIzAwZmY4OCIvPjx0ZXh0IHg9IjMwIiB5PSI1MCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iIzAwZmY4OCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEwIiBmb250LXdlaWdodD0iYm9sZCI+TUlWPC90ZXh0Pjwvc3ZnPg==" 
                         class="player-album-art" 
                         alt="Album Art">
                    <div class="player-text">
                        <div class="player-title" id="playerTitle">T√≠tulo da M√∫sica</div>
                        <div class="player-artist" id="playerArtist">Artista</div>
                        <div class="player-price" id="playerPrice">R$ 0,00 por a√ß√£o</div>
                    </div>
                    <button class="btn-miv btn-sm" onclick="event.stopPropagation(); openInvestModal(state.currentTrackIndex)">
                        <i class="bi bi-currency-dollar"></i> Investir
                    </button>
                </div>

                <div class="progress-container" onclick="seekMusic(event)">
                    <div class="progress-bar" id="musicProgress"></div>
                </div>

                <div class="player-time d-flex justify-content-between mt-1">
                    <span id="currentTime">0:00</span>
                    <span id="durationTime">0:00</span>
                </div>

                <div class="player-controls mt-2">
                    <button class="control-btn" onclick="toggleShuffle()">
                        <i class="bi bi-shuffle" id="shuffleIcon"></i>
                    </button>
                    <button class="control-btn" onclick="playPrevious()">
                        <i class="bi bi-skip-start-fill"></i>
                    </button>
                    <button class="control-btn play-btn" id="playButton" onclick="togglePlay()">
                        <i class="bi bi-play-circle-fill"></i>
                    </button>
                    <button class="control-btn" onclick="playNext()">
                        <i class="bi bi-skip-end-fill"></i>
                    </button>
                    <button class="control-btn" onclick="toggleRepeat()">
                        <i class="bi bi-repeat" id="repeatIcon"></i>
                    </button>
                    <input type="range" id="volumeSlider" min="0" max="100" value="100" class="ms-3" oninput="setVolume(this.value)" style="width: 100px;">
                </div>

                <div id="queueContainer" class="mt-3" style="display:none;">
                    <h6>Pr√≥ximas na fila</h6>
                    <ul id="queueList" class="list-group list-group-flush"></ul>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <button class="nav-btn active" onclick="changeSection('marketplace', this)">
                <i class="bi bi-house"></i>
                <span>Market</span>
            </button>
            <button class="nav-btn" onclick="changeSection('portfolio', this)">
                <i class="bi bi-briefcase"></i>
                <span>Carteira</span>
            </button>
            <button class="nav-btn" onclick="changeSection('ledger', this)">
                <i class="bi bi-receipt"></i>
                <span>Extrato</span>
            </button>
        </nav>
    </div>

    <!-- Invest Modal -->
    <div id="investModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-currency-dollar me-2"></i>
                    Investir em M√∫sica
                </h5>
                <button class="modal-close" onclick="closeModal('investModal')">
                    <i class="bi bi-x"></i>
                </button>
            </div>
            <div class="modal-body">
                <h6 id="investTrackTitle" class="mb-2">T√≠tulo da M√∫sica</h6>
                <p class="text-muted mb-4" id="investTrackArtist">Artista</p>

                <div class="form-group">
                    <label for="investQuantity" class="text-muted mb-2 d-block">Quantidade de A√ß√µes</label>
                    <input type="number" id="investQuantity" class="form-control-custom"
                           value="1" min="1" step="1" oninput="updateInvestmentTotal()">
                </div>

                <div class="d-flex justify-content-between mb-3">
                    <span class="text-muted">Valor por a√ß√£o:</span>
                    <span class="text-success fw-bold" id="investUnitPrice">R$ 0,00</span>
                </div>

                <div class="d-flex justify-content-between mb-4">
                    <span class="text-muted">Valor total:</span>
                    <span class="text-success fw-bold fs-4" id="investTotalPrice">R$ 0,00</span>
                </div>

                <div class="alert alert-info bg-dark border-info mb-3">
                    <i class="bi bi-info-circle me-2"></i>
                    Cada a√ß√£o representa 0.01% de participa√ß√£o nos royalties
                </div>

                <div class="alert alert-warning bg-dark border-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Saldo dispon√≠vel: <span id="investAvailableBalance" class="fw-bold">R$ 0,00</span>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('investModal')">Cancelar</button>
                <button class="btn-miv" id="confirmInvestBtn" onclick="confirmInvestment()">
                    Confirmar Investimento
                </button>
            </div>
        </div>
    </div>

    <!-- Add Music Modal -->
    <div id="addMusicModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-music-note-beamed me-2"></i>
                    Cadastrar Nova M√∫sica
                </h5>
                <button class="modal-close" onclick="closeModal('addMusicModal')">
                    <i class="bi bi-x"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="musicTitle" class="text-muted mb-2 d-block required">T√≠tulo da M√∫sica *</label>
                    <input type="text" id="musicTitle" class="form-control-custom" placeholder="Digite o t√≠tulo da m√∫sica" required>
                </div>

                <div class="form-group">
                    <label for="musicGenre" class="text-muted mb-2 d-block required">G√™nero Musical *</label>
                    <select id="musicGenre" class="form-control-custom" required>
                        <option value="">Selecione um g√™nero</option>
                        <option value="POP">üéµ POP</option>
                        <option value="HIPHOP_RAP">üé∏ HIP HOP / RAP</option>
                        <option value="ROCK">ü§ò ROCK</option>
                        <option value="ELETRONICA">‚ö° ELETR√îNICA</option>
                        <option value="MPB">üé∂ MPB</option>
                        <option value="SERTANEJO">üé∫ SERTANEJO</option>
                        <option value="FUNK">üíÉ FUNK</option>
                        <option value="OUTRO">üéº OUTRO</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="musicYoutube" class="text-muted mb-2 d-block required">Link do YouTube *</label>
                    <input type="url" id="musicYoutube" class="form-control-custom" placeholder="https://youtube.com/watch?v=..." required>
                </div>

                <div class="form-group">
                    <label for="musicCover" class="text-muted mb-2 d-block">Link da Capa (opcional)</label>
                    <input type="url" id="musicCover" class="form-control-custom" placeholder="https://exemplo.com/capa.jpg">
                </div>

                <div class="form-group">
                    <label for="musicPrice" class="text-muted mb-2 d-block required">Valor por A√ß√£o *</label>
                    <input type="number" id="musicPrice" class="form-control-custom" value="10.00" min="1" step="0.01" required>
                </div>

                <div class="form-group">
                    <label for="musicPercent" class="text-muted mb-2 d-block required">Percentual Dispon√≠vel *</label>
                    <div class="input-group">
                        <input type="number" id="musicPercent" class="form-control-custom" value="20" min="1" max="100" required>
                        <span class="input-group-text bg-dark text-white border-secondary">%</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addMusicModal')">Cancelar</button>
                <button class="btn-miv" onclick="registerMusic()">
                    <i class="bi bi-save me-2"></i>
                    Cadastrar M√∫sica
                </button>
            </div>
        </div>
    </div>

    <!-- Finance Modal -->
    <div id="financeModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-cash-coin me-2"></i>
                    Transa√ß√µes Financeiras
                </h5>
                <button class="modal-close" onclick="closeModal('financeModal')">
                    <i class="bi bi-x"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="tabs mb-4">
                    <button class="btn btn-outline-success me-2 active" onclick="showFinanceTab('deposit')">
                        <i class="bi bi-arrow-down-circle"></i> Depositar
                    </button>
                    <button class="btn btn-outline-danger" onclick="showFinanceTab('withdraw')">
                        <i class="bi bi-arrow-up-circle"></i> Sacar
                    </button>
                </div>

                <!-- Deposit Tab -->
                <div id="depositTab">
                    <div class="alert alert-info bg-dark border-info mb-3">
                        <i class="bi bi-info-circle me-2"></i>
                        Fa√ßa um PIX para a chave abaixo e depois confirme o dep√≥sito
                    </div>
                    
                    <div class="form-group">
                        <label for="depositAmount" class="text-muted mb-2 d-block">Valor do Dep√≥sito (R$)</label>
                        <input type="number" id="depositAmount" class="form-control-custom" value="50" min="10" step="0.01">
                    </div>

                    <div class="form-group">
                        <label for="pixKey" class="text-muted mb-2 d-block">Chave PIX (CNPJ)</label>
                        <div class="input-group">
                            <input type="text" id="pixKey" class="form-control-custom" value="12.345.678/0001-90" readonly>
                            <button class="btn btn-outline-success" onclick="copyToClipboard('pixKey')">
                                <i class="bi bi-copy"></i>
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="depositReference" class="text-muted mb-2 d-block">C√≥digo da Transa√ß√£o</label>
                        <input type="text" id="depositReference" class="form-control-custom" placeholder="Copie do comprovante">
                    </div>
                </div>

                <!-- Withdraw Tab -->
                <div id="withdrawTab" style="display: none;">
                    <div class="alert alert-warning bg-dark border-warning mb-3">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Saques s√£o processados em at√© 48h √∫teis
                    </div>
                    
                    <div class="form-group">
                        <label for="withdrawAmount" class="text-muted mb-2 d-block">Valor do Saque (R$)</label>
                        <input type="number" id="withdrawAmount" class="form-control-custom" value="50" min="20" step="0.01">
                    </div>

                    <div class="form-group">
                        <label for="withdrawPixKey" class="text-muted mb-2 d-block">Chave PIX para Receber</label>
                        <input type="text" id="withdrawPixKey" class="form-control-custom" placeholder="CPF, Email, Telefone ou Chave Aleat√≥ria">
                    </div>

                    <div class="form-group">
                        <label for="withdrawPixType" class="text-muted mb-2 d-block">Tipo de Chave</label>
                        <select id="withdrawPixType" class="form-control-custom">
                            <option value="cpf">CPF</option>
                            <option value="email">Email</option>
                            <option value="phone">Telefone</option>
                            <option value="random">Chave Aleat√≥ria</option>
                        </select>
                    </div>
                </div>

                <div class="alert alert-success bg-dark border-success mt-3">
                    <i class="bi bi-wallet2 me-2"></i>
                    Saldo dispon√≠vel: <span id="modalAvailableBalance" class="fw-bold">R$ 0,00</span>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('financeModal')">Cancelar</button>
                <button class="btn-miv" id="confirmFinanceBtn" onclick="processFinanceTransaction()">
                    <i class="bi bi-check-circle me-2"></i>
                    Confirmar
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
               // ========== CONFIGURA√á√ÉO ==========
        const CONFIG = {
            API_URL: 'https://script.google.com/macros/s/AKfycby14fXBzZOMBJGzNPVhmKVGg0EEo2Ju6miRe8-kpk1iN9YKWR4CsI9t11-BJQj_M0o/exec',
            YT_API_KEY: 'AIzaSyB3g82a5n2U4FzUZcM-GF7m-4r1i2L3v4Q' // Substitua pela sua chave YouTube se necess√°rio
        };

        // ========== ESTADO GLOBAL ==========
        const state = {
            currentUser: null,
            currentToken: null,
            userBalance: 0,
            portfolioValue: 0,
            playlist: [],
            currentTrackIndex: -1,
            youtubePlayer: null,
            isPlaying: false,
            isPlayerExpanded: false,
            currentInvestTrack: null,
            shuffle: false,
            repeat: false,
            volume: 100,
            progressInterval: null
        };

        // ========== INICIALIZA√á√ÉO ==========
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Enter key listeners for forms
            document.getElementById('loginPassword')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') handleLogin();
            });
            
            document.getElementById('registerPassword')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') handleRegister();
            });
            
            document.getElementById('investQuantity')?.addEventListener('input', updateInvestmentTotal);
            
            // Escape key to close modals
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeAllModals();
                }
            });
        }

        function closeAllModals() {
            const modals = ['investModal', 'addMusicModal', 'financeModal'];
            modals.forEach(modalId => {
                closeModal(modalId);
            });
        }

        // ========== AUTENTICA√á√ÉO ==========
        async function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value.trim();

            if (!email || !password) {
                showToast('Preencha email e senha', 'error');
                return;
            }

            showLoading('Autenticando...');

            try {
                // ‚úÖ Use GET para login
                const url = `${CONFIG.API_URL}?action=login&email=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}`;
                
                const response = await fetch(url);
                const result = await response.json();
                
                hideLoading();

                if (result.success) {
                    state.currentUser = result.data;
                    state.currentToken = result.data.token || result.data.id;
                    
                    // Salva no localStorage
                    localStorage.setItem('miv_user', JSON.stringify(state.currentUser));
                    localStorage.setItem('miv_token', state.currentToken);
                    
                    showToast(`Bem-vindo, ${result.data.nome}!`);
                    initializeApp();
                } else {
                    showToast(result.message || 'Erro no login', 'error');
                }
            } catch (error) {
                hideLoading();
                console.error('Erro no login:', error);
                showToast('Erro de conex√£o com o servidor', 'error');
            }
        }

        async function handleRegister() {
            const name = document.getElementById('registerName').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value.trim();
            const type = document.getElementById('registerType').value;
            const workLink = document.getElementById('registerLink')?.value.trim() || '';

            if (!name || !email || !password || !type) {
                showToast('Preencha todos os campos obrigat√≥rios', 'error');
                return;
            }

            if (password.length < 6) {
                showToast('Senha deve ter pelo menos 6 caracteres', 'error');
                return;
            }

            if (type === 'artista' && !workLink) {
                showToast('Artistas devem informar link do trabalho', 'error');
                return;
            }

            showLoading('Criando conta...');

            try {
                const params = new URLSearchParams({
                    action: 'register',
                    nome: name,
                    email: email,
                    password: password,
                    tipo: type,
                    workLink: workLink
                });

                const response = await fetch(CONFIG.API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: params.toString()
                });

                const result = await response.json();
                hideLoading();

                if (result.success) {
                    showToast('Conta criada! Aguarde aprova√ß√£o.', 'success');
                    showLoginForm();
                    // Limpa formul√°rio
                    document.getElementById('registerName').value = '';
                    document.getElementById('registerEmail').value = '';
                    document.getElementById('registerPassword').value = '';
                    document.getElementById('registerType').value = '';
                    document.getElementById('registerLink').value = '';
                } else {
                    showToast(result.message || 'Erro ao criar conta', 'error');
                }
            } catch (error) {
                hideLoading();
                console.error('Erro no registro:', error);
                showToast('Erro de conex√£o', 'error');
            }
        }

        function showLoginForm() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
        }

        function showRegisterForm() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
        }

        function toggleArtistField() {
            const type = document.getElementById('registerType').value;
            const field = document.getElementById('artistLinkField');
            field.style.display = type === 'artista' ? 'block' : 'none';
        }

        function checkAuth() {
            const savedUser = localStorage.getItem('miv_user');
            const savedToken = localStorage.getItem('miv_token');
            
            if (savedUser && savedToken) {
                try {
                    state.currentUser = JSON.parse(savedUser);
                    state.currentToken = savedToken;
                    initializeApp();
                } catch (e) {
                    showAuthScreen();
                }
            } else {
                showAuthScreen();
            }
        }

        function showAuthScreen() {
            document.getElementById('authScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('loadingScreen').style.display = 'none';
        }

        function showApp() {
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
        }

        async function initializeApp() {
            showLoading('Carregando dados...');
            showApp();
            
            try {
                // Atualiza UI do usu√°rio
                updateUserUI();
                
                // Carrega dados iniciais
                await Promise.all([
                    loadBalance(),
                    loadMarketplace(),
                    loadPortfolio(),
                    loadArtistData()
                ]);
                
                // Configura navega√ß√£o
                setupNavigation();
                
                hideLoading();
                
                // Mostra boas-vindas
                setTimeout(() => {
                    showToast(`Bem-vindo de volta, ${state.currentUser.nome}!`);
                }, 500);
                
            } catch (error) {
                console.error('Erro na inicializa√ß√£o:', error);
                hideLoading();
                showToast('Erro ao carregar dados do app', 'error');
            }
        }

        function updateUserUI() {
            if (!state.currentUser) return;
            
            // Atualiza badge do usu√°rio
            const badge = document.getElementById('userBadge');
            if (badge) {
                badge.textContent = state.currentUser.tipo === 'artista' ? 'üé§ Artista' : 
                                  state.currentUser.tipo === 'admin' ? 'üëë Admin' : 'üéß Ouvinte';
                badge.className = state.currentUser.tipo === 'artista' ? 'user-badge bg-info' :
                                 state.currentUser.tipo === 'admin' ? 'user-badge bg-warning' :
                                 'user-badge bg-secondary';
            }
            
            // Mostra/oculta item do artista
            const artistNav = document.getElementById('artistNavItem');
            if (artistNav) {
                artistNav.style.display = state.currentUser.tipo === 'artista' ? 'block' : 'none';
            }
        }

        function logout() {
            if (confirm('Deseja realmente sair?')) {
                localStorage.removeItem('miv_user');
                localStorage.removeItem('miv_token');
                state.currentUser = null;
                state.currentToken = null;
                state.playlist = [];
                state.currentTrackIndex = -1;
                
                if (state.youtubePlayer) {
                    state.youtubePlayer.stopVideo();
                    state.youtubePlayer.destroy();
                    state.youtubePlayer = null;
                }
                
                showAuthScreen();
                showToast('Voc√™ saiu da conta');
            }
        }

        // ========== DADOS FINANCEIROS ==========
        async function loadBalance() {
            if (!state.currentToken) return;
            
            try {
                const url = `${CONFIG.API_URL}?action=get_saldo&token=${encodeURIComponent(state.currentToken)}`;
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    state.userBalance = parseFloat(result.data.saldo) || 0;
                    updateBalanceUI();
                }
            } catch (error) {
                console.error('Erro ao carregar saldo:', error);
            }
        }

        async function loadPortfolio() {
            if (!state.currentUser) return;
            
            try {
                const url = `${CONFIG.API_URL}?action=get_resumo&token=${encodeURIComponent(state.currentToken)}`;
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    state.portfolioValue = parseFloat(result.data.patrimonio) || 0;
                    updatePortfolioUI();
                }
            } catch (error) {
                console.error('Erro ao carregar portf√≥lio:', error);
            }
        }

        async function loadArtistData() {
            if (!state.currentUser || state.currentUser.tipo !== 'artista') return;
            
            try {
                const url = `${CONFIG.API_URL}?action=get_artist_data&user_id=${state.currentUser.id}`;
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    updateArtistUI(result.data);
                }
            } catch (error) {
                console.error('Erro ao carregar dados do artista:', error);
            }
        }

        function updateBalanceUI() {
            const balanceElement = document.getElementById('currentBalance');
            const modalBalance = document.getElementById('modalAvailableBalance');
            const investBalance = document.getElementById('investAvailableBalance');
            
            if (balanceElement) balanceElement.textContent = formatCurrency(state.userBalance);
            if (modalBalance) modalBalance.textContent = formatCurrency(state.userBalance);
            if (investBalance) investBalance.textContent = formatCurrency(state.userBalance);
        }

        function updatePortfolioUI() {
            const portfolioElement = document.getElementById('portfolioValue');
            if (portfolioElement) {
                portfolioElement.textContent = formatCurrency(state.portfolioValue);
            }
        }

        function updateArtistUI(artistData) {
            // Atualiza estat√≠sticas do artista
            const musicCount = document.getElementById('artistMusicCount');
            const royalties = document.getElementById('artistRoyalties');
            const sharesSold = document.getElementById('artistSharesSold');
            
            if (musicCount) musicCount.textContent = artistData.total_musicas || 0;
            if (royalties) royalties.textContent = formatCurrency(artistData.total_royalties || 0);
            if (sharesSold) sharesSold.textContent = artistData.total_acoes_vendidas || 0;
            
            // Carrega m√∫sicas do artista
            loadArtistMusics(artistData.musicas || []);
        }

        // ========== MARKETPLACE ==========
        async function loadMarketplace() {
            try {
                const url = `${CONFIG.API_URL}?action=get_musicas`;
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    state.playlist = result.data || [];
                    renderMarketplace(state.playlist);
                } else {
                    showEmptyState('marketplaceContent', 'Nenhuma m√∫sica dispon√≠vel no momento.');
                }
            } catch (error) {
                console.error('Erro ao carregar marketplace:', error);
                showEmptyState('marketplaceContent', 'Erro ao carregar m√∫sicas.');
            }
        }

        function renderMarketplace(musicas) {
            const container = document.getElementById('marketplaceContent');
            if (!container) return;
            
            if (!musicas || musicas.length === 0) {
                showEmptyState('marketplaceContent', 'Nenhuma m√∫sica dispon√≠vel no momento.');
                return;
            }
            
            container.innerHTML = '';
            
            musicas.forEach((musica, index) => {
                const card = createMusicCard(musica, index);
                container.appendChild(card);
            });
        }

        function createMusicCard(musica, index) {
            const card = document.createElement('div');
            card.className = 'music-card';
            card.innerHTML = `
                <img src="${musica.link_capa || 'https://via.placeholder.com/300x300/111418/00ff88?text=MIV'}" 
                     class="music-cover" 
                     alt="${musica.titulo}"
                     onerror="this.src='https://via.placeholder.com/300x300/111418/00ff88?text=MIV'">
                <div class="music-info">
                    <h5 class="music-title">${musica.titulo}</h5>
                    <p class="music-artist">${musica.artista || 'Artista Desconhecido'}</p>
                    <div class="music-meta">
                        <span class="music-price">R$ ${parseFloat(musica.valor_acao || 0).toFixed(2)}</span>
                        <span class="badge bg-primary">${musica.percentual_disponivel || 0}% disp.</span>
                    </div>
                    <div class="d-grid gap-2">
                        <button class="btn btn-sm btn-outline-success" onclick="playTrack(${index})">
                            <i class="bi bi-play-fill"></i> Ouvir
                        </button>
                        <button class="btn btn-sm btn-miv" onclick="openInvestModal(${index})">
                            <i class="bi bi-currency-dollar"></i> Investir
                        </button>
                    </div>
                </div>
            `;
            return card;
        }

        function showEmptyState(elementId, message) {
            const container = document.getElementById(elementId);
            if (!container) return;
            
            container.innerHTML = `
                <div class="empty-state col-12">
                    <div class="empty-icon">
                        <i class="bi bi-music-note-beamed"></i>
                    </div>
                    <h5 class="text-muted">${message}</h5>
                </div>
            `;
        }

        // ========== PLAYER DE M√öSICA ==========
        function playTrack(index) {
            if (index < 0 || index >= state.playlist.length) return;
            
            state.currentTrackIndex = index;
            const track = state.playlist[index];
            
            // Atualiza UI do player
            document.getElementById('playerTitle').textContent = track.titulo;
            document.getElementById('playerArtist').textContent = track.artista || 'Artista Desconhecido';
            document.getElementById('playerPrice').textContent = `R$ ${parseFloat(track.valor_acao || 0).toFixed(2)} por a√ß√£o`;
            
            const albumArt = document.getElementById('playerAlbumArt');
            albumArt.src = track.link_capa || 'https://via.placeholder.com/60x60/111418/00ff88?text=MIV';
            albumArt.onerror = function() {
                this.src = 'https://via.placeholder.com/60x60/111418/00ff88?text=MIV';
            };
            
            // Mostra player
            document.getElementById('playerBar').style.display = 'block';
            
            // Carrega v√≠deo do YouTube
            loadYouTubeVideo(track.link_youtube);
            
            // Expande player se necess√°rio
            if (!state.isPlayerExpanded) {
                togglePlayerExpansion();
            }
        }

        function loadYouTubeVideo(url) {
            try {
                // Extrai ID do v√≠deo do YouTube
                const videoId = extractYouTubeId(url);
                if (!videoId) {
                    showToast('Link do YouTube inv√°lido', 'error');
                    return;
                }
                
                // Se j√° existe um player, destr√≥i
                if (state.youtubePlayer) {
                    state.youtubePlayer.destroy();
                }
                
                // Cria novo player
                state.youtubePlayer = new YT.Player('youtubePlayer', {
                    height: '100%',
                    width: '100%',
                    videoId: videoId,
                    playerVars: {
                        'autoplay': 1,
                        'controls': 1,
                        'rel': 0,
                        'showinfo': 0,
                        'modestbranding': 1
                    },
                    events: {
                        'onReady': onPlayerReady,
                        'onStateChange': onPlayerStateChange
                    }
                });
            } catch (error) {
                console.error('Erro ao carregar v√≠deo:', error);
                showToast('Erro ao carregar v√≠deo', 'error');
            }
        }

        function extractYouTubeId(url) {
            if (!url) return null;
            
            const patterns = [
                /(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&\n?#]+)/,
                /youtube\.com\/embed\/([^&\n?#]+)/,
                /youtube\.com\/v\/([^&\n?#]+)/
            ];
            
            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match && match[1]) {
                    return match[1];
                }
            }
            
            return null;
        }

        function onPlayerReady(event) {
            event.target.playVideo();
            state.isPlaying = true;
            updatePlayButton();
            startProgressTracker();
        }

        function onPlayerStateChange(event) {
            // -1 (n√£o iniciado), 0 (terminado), 1 (reproduzindo), 2 (pausado), 3 (buffering), 5 (em fila)
            switch (event.data) {
                case YT.PlayerState.PLAYING:
                    state.isPlaying = true;
                    updatePlayButton();
                    break;
                case YT.PlayerState.PAUSED:
                    state.isPlaying = false;
                    updatePlayButton();
                    break;
                case YT.PlayerState.ENDED:
                    if (state.repeat) {
                        event.target.playVideo();
                    } else {
                        playNext();
                    }
                    break;
            }
        }

        function startProgressTracker() {
            stopProgressTracker();
            
            state.progressInterval = setInterval(() => {
                if (state.youtubePlayer && state.youtubePlayer.getCurrentTime) {
                    const current = state.youtubePlayer.getCurrentTime();
                    const duration = state.youtubePlayer.getDuration();
                    
                    if (duration > 0) {
                        const progress = (current / duration) * 100;
                        document.getElementById('musicProgress').style.width = `${progress}%`;
                        document.getElementById('currentTime').textContent = formatTime(current);
                        document.getElementById('durationTime').textContent = formatTime(duration);
                    }
                }
            }, 1000);
        }

        function stopProgressTracker() {
            if (state.progressInterval) {
                clearInterval(state.progressInterval);
                state.progressInterval = null;
            }
        }

        function togglePlay() {
            if (!state.youtubePlayer) return;
            
            if (state.isPlaying) {
                state.youtubePlayer.pauseVideo();
            } else {
                state.youtubePlayer.playVideo();
            }
        }

        function updatePlayButton() {
            const button = document.getElementById('playButton');
            if (!button) return;
            
            const icon = button.querySelector('i');
            if (icon) {
                icon.className = state.isPlaying ? 'bi bi-pause-circle-fill' : 'bi bi-play-circle-fill';
            }
        }

        function playNext() {
            if (state.shuffle) {
                // Toca aleat√≥rio
                const newIndex = Math.floor(Math.random() * state.playlist.length);
                playTrack(newIndex);
            } else {
                // Toca pr√≥xima
                const nextIndex = (state.currentTrackIndex + 1) % state.playlist.length;
                playTrack(nextIndex);
            }
        }

        function playPrevious() {
            const prevIndex = state.currentTrackIndex <= 0 ? state.playlist.length - 1 : state.currentTrackIndex - 1;
            playTrack(prevIndex);
        }

        function toggleShuffle() {
            state.shuffle = !state.shuffle;
            const icon = document.getElementById('shuffleIcon');
            if (icon) {
                icon.style.color = state.shuffle ? '#00ff88' : '';
            }
        }

        function toggleRepeat() {
            state.repeat = !state.repeat;
            const icon = document.getElementById('repeatIcon');
            if (icon) {
                icon.style.color = state.repeat ? '#00ff88' : '';
            }
        }

        function setVolume(value) {
            state.volume = value;
            if (state.youtubePlayer) {
                state.youtubePlayer.setVolume(value);
            }
        }

        function seekMusic(event) {
            if (!state.youtubePlayer) return;
            
            const rect = event.target.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const width = rect.width;
            const percentage = x / width;
            
            const duration = state.youtubePlayer.getDuration();
            const newTime = duration * percentage;
            
            state.youtubePlayer.seekTo(newTime);
        }

        function togglePlayerExpansion() {
            state.isPlayerExpanded = !state.isPlayerExpanded;
            const player = document.getElementById('playerBar');
            
            if (state.isPlayerExpanded) {
                player.classList.add('expanded');
            } else {
                player.classList.remove('expanded');
            }
        }

        // ========== INVESTIMENTOS ==========
        function openInvestModal(trackIndex) {
            if (trackIndex < 0 || trackIndex >= state.playlist.length) {
                showToast('M√∫sica n√£o encontrada', 'error');
                return;
            }
            
            state.currentInvestTrack = state.playlist[trackIndex];
            
            // Preenche modal
            document.getElementById('investTrackTitle').textContent = state.currentInvestTrack.titulo;
            document.getElementById('investTrackArtist').textContent = state.currentInvestTrack.artista || 'Artista Desconhecido';
            document.getElementById('investUnitPrice').textContent = formatCurrency(state.currentInvestTrack.valor_acao || 0);
            
            // Atualiza saldo dispon√≠vel
            document.getElementById('investAvailableBalance').textContent = formatCurrency(state.userBalance);
            
            // Reseta quantidade
            document.getElementById('investQuantity').value = 1;
            updateInvestmentTotal();
            
            // Mostra modal
            showModal('investModal');
        }

        function updateInvestmentTotal() {
            if (!state.currentInvestTrack) return;
            
            const quantity = parseInt(document.getElementById('investQuantity').value) || 1;
            const unitPrice = parseFloat(state.currentInvestTrack.valor_acao) || 0;
            const total = quantity * unitPrice;
            
            document.getElementById('investTotalPrice').textContent = formatCurrency(total);
            
            // Valida saldo
            const button = document.getElementById('confirmInvestBtn');
            if (button) {
                button.disabled = total > state.userBalance;
                button.innerHTML = total > state.userBalance ? 
                    '<i class="bi bi-exclamation-triangle me-2"></i>Saldo Insuficiente' :
                    '<i class="bi bi-check-circle me-2"></i>Confirmar Investimento';
            }
        }

        async function confirmInvestment() {
            if (!state.currentInvestTrack || !state.currentUser) {
                showToast('Erro: dados incompletos', 'error');
                return;
            }
            
            const quantity = parseInt(document.getElementById('investQuantity').value) || 1;
            const unitPrice = parseFloat(state.currentInvestTrack.valor_acao) || 0;
            const total = quantity * unitPrice;
            
            if (total > state.userBalance) {
                showToast('Saldo insuficiente!', 'error');
                return;
            }
            
            if (quantity <= 0) {
                showToast('Quantidade inv√°lida!', 'error');
                return;
            }
            
            if (!confirm(`Investir R$ ${total.toFixed(2)} em ${quantity} a√ß√£o(√µes) de "${state.currentInvestTrack.titulo}"?`)) {
                return;
            }
            
            showLoading('Processando investimento...');
            
            try {
                const params = new URLSearchParams({
                    action: 'buy',
                    user_id: state.currentUser.id,
                    music_id: state.currentInvestTrack.id,
                    quantidade: quantity,
                    valor_total: total
                });
                
                const response = await fetch(CONFIG.API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: params.toString()
                });
                
                const result = await response.json();
                hideLoading();
                
                if (result.success) {
                    showToast(`Investimento realizado com sucesso!`, 'success');
                    closeModal('investModal');
                    
                    // Atualiza saldo
                    state.userBalance = result.data.novo_saldo || state.userBalance - total;
                    updateBalanceUI();
                    
                    // Atualiza portf√≥lio
                    loadPortfolio();
                    
                } else {
                    showToast(result.message || 'Erro ao realizar investimento', 'error');
                }
            } catch (error) {
                hideLoading();
                console.error('Erro no investimento:', error);
                showToast('Erro de conex√£o', 'error');
            }
        }

        // ========== PAINEL DO ARTISTA ==========
        function openAddMusicModal() {
            // Limpa formul√°rio
            document.getElementById('musicTitle').value = '';
            document.getElementById('musicGenre').value = '';
            document.getElementById('musicYoutube').value = '';
            document.getElementById('musicCover').value = '';
            document.getElementById('musicPrice').value = '10.00';
            document.getElementById('musicPercent').value = '20';
            
            showModal('addMusicModal');
        }

        async function registerMusic() {
            if (!state.currentUser || state.currentUser.tipo !== 'artista') {
                showToast('Apenas artistas podem cadastrar m√∫sicas', 'error');
                return;
            }
            
            const title = document.getElementById('musicTitle').value.trim();
            const genre = document.getElementById('musicGenre').value;
            const youtube = document.getElementById('musicYoutube').value.trim();
            const cover = document.getElementById('musicCover').value.trim();
            const price = document.getElementById('musicPrice').value;
            const percent = document.getElementById('musicPercent').value;
            
            // Valida√ß√£o
            if (!title || !genre || !youtube) {
                showToast('Preencha t√≠tulo, g√™nero e link do YouTube', 'error');
                return;
            }
            
            if (!isValidYouTubeUrl(youtube)) {
                showToast('Insira um link v√°lido do YouTube', 'error');
                return;
            }
            
            const priceNum = parseFloat(price);
            const percentNum = parseInt(percent);
            
            if (priceNum <= 0) {
                showToast('Valor por a√ß√£o deve ser positivo', 'error');
                return;
            }
            
            if (percentNum < 1 || percentNum > 100) {
                showToast('Percentual deve ser entre 1% e 100%', 'error');
                return;
            }
            
            showLoading('Cadastrando m√∫sica...');
            
            try {
                const params = new URLSearchParams({
                    action: 'uploadMusic',
                    user_id: state.currentUser.id,
                    titulo: title,
                    artista: state.currentUser.nome,
                    genero: genre,
                    link_youtube: youtube,
                    link_capa: cover,
                    valor_acao: priceNum,
                    percentual_disponivel: percentNum
                });
                
                const response = await fetch(CONFIG.API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: params.toString()
                });
                
                const result = await response.json();
                hideLoading();
                
                if (result.success) {
                    showToast('M√∫sica cadastrada com sucesso!', 'success');
                    closeModal('addMusicModal');
                    
                    // Recarrega dados
                    loadMarketplace();
                    loadArtistData();
                    
                } else {
                    showToast(result.message || 'Erro ao cadastrar m√∫sica', 'error');
                }
            } catch (error) {
                hideLoading();
                console.error('Erro ao cadastrar m√∫sica:', error);
                showToast('Erro de conex√£o', 'error');
            }
        }

        function isValidYouTubeUrl(url) {
            return extractYouTubeId(url) !== null;
        }

        function loadArtistMusics(musicas) {
            const container = document.getElementById('artistMusicContent');
            if (!container) return;
            
            if (!musicas || musicas.length === 0) {
                container.innerHTML = `
                    <div class="empty-state col-12">
                        <div class="empty-icon">
                            <i class="bi bi-music-note-beamed"></i>
                        </div>
                        <h5 class="text-muted">Nenhuma m√∫sica cadastrada</h5>
                        <button class="btn btn-miv mt-3" onclick="openAddMusicModal()">
                            <i class="bi bi-plus-circle me-2"></i>
                            Cadastrar Primeira M√∫sica
                        </button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            musicas.forEach((musica, index) => {
                const card = createArtistMusicCard(musica, index);
                container.appendChild(card);
            });
        }

        function createArtistMusicCard(musica, index) {
            const card = document.createElement('div');
            card.className = 'music-card';
            
            const percentSold = musica.percentual_vendido || 0;
            const totalRaised = musica.arrecadacao_total || 0;
            const sharesAvailable = musica.acoes_disponiveis || 0;
            
            card.innerHTML = `
                <img src="${musica.link_capa || 'https://via.placeholder.com/300x300/111418/00ff88?text=MIV'}" 
                     class="music-cover" 
                     alt="${musica.titulo}"
                     onerror="this.src='https://via.placeholder.com/300x300/111418/00ff88?text=MIV'">
                <div class="music-info">
                    <h5 class="music-title">${musica.titulo}</h5>
                    <p class="music-artist">${musica.genero || 'G√™nero n√£o informado'}</p>
                    
                    <div class="progress mb-2" style="height: 10px;">
                        <div class="progress-bar bg-success" style="width: ${percentSold}%"></div>
                    </div>
                    <small class="text-muted d-block mb-2">${percentSold.toFixed(1)}% vendido (R$ ${totalRaised.toFixed(2)})</small>
                    
                    <div class="row text-center mb-2">
                        <div class="col-6">
                            <small class="text-muted">Valor/a√ß√£o</small>
                            <div class="fw-bold text-success">R$ ${parseFloat(musica.valor_acao || 0).toFixed(2)}</div>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Dispon√≠veis</small>
                            <div class="fw-bold">${sharesAvailable}</div>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button class="btn btn-sm btn-outline-primary" onclick="playTrackFromGlobal(${musica.id})">
                            <i class="bi bi-play-fill"></i> Ouvir
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="editMusic('${musica.id}')">
                            <i class="bi bi-pencil"></i> Editar
                        </button>
                    </div>
                </div>
            `;
            return card;
        }

        function playTrackFromGlobal(musicId) {
            const index = state.playlist.findIndex(m => m.id == musicId);
            if (index !== -1) {
                playTrack(index);
            }
        }

        function editMusic(musicId) {
            showToast('Funcionalidade em desenvolvimento', 'info');
        }

        // ========== EXTRATO FINANCEIRO ==========
        async function loadLedger() {
            if (!state.currentUser) return;
            
            showLoading('Carregando extrato...');
            
            try {
                const url = `${CONFIG.API_URL}?action=get_extrato&user_id=${state.currentUser.id}`;
                const response = await fetch(url);
                const result = await response.json();
                
                hideLoading();
                
                if (result.success) {
                    renderLedger(result.data || []);
                } else {
                    showEmptyState('ledgerContent', 'Nenhuma transa√ß√£o encontrada.');
                }
            } catch (error) {
                hideLoading();
                console.error('Erro ao carregar extrato:', error);
                showEmptyState('ledgerContent', 'Erro ao carregar extrato.');
            }
        }

        function renderLedger(transactions) {
            const container = document.getElementById('ledgerContent');
            if (!container) return;
            
            if (!transactions || transactions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="bi bi-receipt"></i>
                        </div>
                        <h5 class="text-muted">Nenhuma transa√ß√£o encontrada</h5>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="table-responsive"><table class="ledger-table">';
            html += `
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Descri√ß√£o</th>
                        <th>Tipo</th>
                        <th class="text-end">Valor</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            transactions.forEach(trans => {
                const typeClass = trans.valor > 0 ? 'transaction-type deposit' : 
                                 trans.tipo?.includes('SAQUE') ? 'transaction-type withdraw' : 
                                 'transaction-type purchase';
                
                const typeLabel = trans.valor > 0 ? 'DEP√ìSITO' : 
                                 trans.tipo?.includes('SAQUE') ? 'SAQUE' : 
                                 'INVESTIMENTO';
                
                html += `
                    <tr>
                        <td>${formatDate(trans.data)}</td>
                        <td>${trans.descricao || 'Transa√ß√£o'}</td>
                        <td><span class="${typeClass}">${typeLabel}</span></td>
                        <td class="text-end ${trans.valor > 0 ? 'text-success' : 'text-danger'} fw-bold">
                            ${trans.valor > 0 ? '+' : ''}${formatCurrency(trans.valor)}
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // ========== TRANSA√á√ïES FINANCEIRAS ==========
        function openFinanceModal() {
            showModal('financeModal');
            showFinanceTab('deposit');
        }

        function showFinanceTab(tab) {
            // Atualiza bot√µes
            document.querySelectorAll('#financeModal .tabs button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (tab === 'deposit') {
                document.querySelector('#financeModal .tabs button:nth-child(1)').classList.add('active');
                document.getElementById('depositTab').style.display = 'block';
                document.getElementById('withdrawTab').style.display = 'none';
                document.getElementById('confirmFinanceBtn').innerHTML = '<i class="bi bi-check-circle me-2"></i>Confirmar Dep√≥sito';
            } else {
                document.querySelector('#financeModal .tabs button:nth-child(2)').classList.add('active');
                document.getElementById('depositTab').style.display = 'none';
                document.getElementById('withdrawTab').style.display = 'block';
                document.getElementById('confirmFinanceBtn').innerHTML = '<i class="bi bi-check-circle me-2"></i>Solicitar Saque';
            }
            
            // Atualiza saldo
            document.getElementById('modalAvailableBalance').textContent = formatCurrency(state.userBalance);
        }

        async function processFinanceTransaction() {
            const depositTabActive = document.getElementById('depositTab').style.display !== 'none';
            
            if (depositTabActive) {
                await processDeposit();
            } else {
                await processWithdraw();
            }
        }

        async function processDeposit() {
            const amount = parseFloat(document.getElementById('depositAmount').value);
            const reference = document.getElementById('depositReference').value.trim();
            
            if (!amount || amount < 10) {
                showToast('Valor m√≠nimo: R$ 10,00', 'error');
                return;
            }
            
            if (!reference) {
                showToast('Informe o c√≥digo da transa√ß√£o PIX', 'error');
                return;
            }
            
            if (!confirm(`Confirmar dep√≥sito de ${formatCurrency(amount)}?`)) {
                return;
            }
            
            showLoading('Confirmando dep√≥sito...');
            
            try {
                const params = new URLSearchParams({
                    action: 'confirmar_deposito',
                    user_id: state.currentUser.id,
                    valor: amount,
                    referencia: reference
                });
                
                const response = await fetch(CONFIG.API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: params.toString()
                });
                
                const result = await response.json();
                hideLoading();
                
                if (result.success) {
                    showToast('Dep√≥sito confirmado!', 'success');
                    closeModal('financeModal');
                    
                    // Atualiza saldo
                    state.userBalance += amount;
                    updateBalanceUI();
                    
                    // Atualiza extrato
                    loadLedger();
                    
                } else {
                    showToast(result.message || 'Erro ao confirmar dep√≥sito', 'error');
                }
            } catch (error) {
                hideLoading();
                console.error('Erro no dep√≥sito:', error);
                showToast('Erro de conex√£o', 'error');
            }
        }

        async function processWithdraw() {
            const amount = parseFloat(document.getElementById('withdrawAmount').value);
            const pixKey = document.getElementById('withdrawPixKey').value.trim();
            const pixType = document.getElementById('withdrawPixType').value;
            
            if (!amount || amount < 20) {
                showToast('Valor m√≠nimo para saque: R$ 20,00', 'error');
                return;
            }
            
            if (amount > state.userBalance) {
                showToast('Saldo insuficiente para saque', 'error');
                return;
            }
            
            if (!pixKey) {
                showToast('Informe a chave PIX para recebimento', 'error');
                return;
            }
            
            if (!confirm(`Solicitar saque de ${formatCurrency(amount)} para ${pixKey}?`)) {
                return;
            }
            
            showLoading('Solicitando saque...');
            
            try {
                const params = new URLSearchParams({
                    action: 'solicitar_saque',
                    user_id: state.currentUser.id,
                    valor: amount
                });
                
                const response = await fetch(CONFIG.API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: params.toString()
                });
                
                const result = await response.json();
                hideLoading();
                
                if (result.success) {
                    showToast('Saque solicitado! Processamento em at√© 48h.', 'success');
                    closeModal('financeModal');
                    
                    // Limpa formul√°rio
                    document.getElementById('withdrawAmount').value = '50';
                    document.getElementById('withdrawPixKey').value = '';
                    
                } else {
                    showToast(result.message || 'Erro ao solicitar saque', 'error');
                }
            } catch (error) {
                hideLoading();
                console.error('Erro no saque:', error);
                showToast('Erro de conex√£o', 'error');
            }
        }

        // ========== NAVEGA√á√ÉO ==========
        function setupNavigation() {
            changeSection('marketplace');
        }

        function changeSection(sectionId, button = null) {
            // Esconde todas as se√ß√µes
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active de todos os bot√µes
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Ativa se√ß√£o selecionada
            const section = document.getElementById(sectionId + 'Section');
            if (section) {
                section.classList.add('active');
                
                // Se foi clicado no menu lateral, fecha sidebar
                if (window.innerWidth <= 768) {
                    toggleSidebar(false);
                }
                
                // Atualiza dados da se√ß√£o
                switch(sectionId) {
                    case 'marketplace':
                        loadMarketplace();
                        break;
                    case 'portfolio':
                        loadPortfolio();
                        break;
                    case 'ledger':
                        loadLedger();
                        break;
                    case 'artist':
                        loadArtistData();
                        break;
                }
            }
            
            // Ativa bot√£o correspondente
            if (button) {
                button.classList.add('active');
            }
            
            // Ativa link correspondente no sidebar
            const sidebarLink = document.querySelector(`.nav-link[onclick*="${sectionId}"]`);
            if (sidebarLink) {
                sidebarLink.classList.add('active');
            }
        }

        function toggleSidebar(forceClose = null) {
            const sidebar = document.getElementById('sidebar');
            if (forceClose === false || (sidebar.classList.contains('open') && forceClose === null)) {
                sidebar.classList.remove('open');
            } else {
                sidebar.classList.add('open');
            }
        }

        // Carrega API do YouTube
        function loadYouTubeAPI() {
            const tag = document.createElement('script');
            tag.src = 'https://www.youtube.com/iframe_api';
            const firstScriptTag = document.getElementsByTagName('script')[0];
            firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
        }

        // Callback global para YouTube API
        window.onYouTubeIframeAPIReady = function() {
            console.log('YouTube API carregada');
        };

        // Inicializa API do YouTube
        loadYouTubeAPI();
    </script>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
