<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Selo MIV - Plataforma de Investimento em M√∫sica</title>
    <style>
        /* ESTILOS B√ÅSICOS */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Arial, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0a192f 0%, #1a1a2e 100%);
            color: #ffffff;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* TOAST NOTIFICATIONS */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            z-index: 1000;
            max-width: 400px;
            animation: slideIn 0.3s ease;
        }
        
        .toast.success { background: #10b981; }
        .toast.error { background: #ef4444; }
        .toast.info { background: #3b82f6; }
        .toast.warning { background: #f59e0b; }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* LOADING */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #00ff88;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* HEADER */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #00ff88;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .balance {
            background: rgba(0, 255, 136, 0.1);
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
        }
        
        /* NAVEGA√á√ÉO */
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            overflow-x: auto;
            padding-bottom: 10px;
        }
        
        .nav-tab {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            white-space: nowrap;
        }
        
        .nav-tab.active {
            background: #00ff88;
            color: #0a192f;
        }
        
        /* CONTE√öDO */
        .content-section {
            display: none;
            padding: 20px 0;
        }
        
        .content-section.active {
            display: block;
        }
        
        /* CARD DE M√öSICA */
        .music-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .music-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            overflow: hidden;
            transition: transform 0.3s ease;
        }
        
        .music-card:hover {
            transform: translateY(-5px);
        }
        
        .music-cover {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }
        
        .music-info {
            padding: 15px;
        }
        
        .music-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .music-artist {
            color: #888;
            margin-bottom: 10px;
        }
        
        .music-price {
            color: #00ff88;
            font-weight: bold;
            font-size: 20px;
        }
        
        /* FORMUL√ÅRIOS */
        .auth-form {
            max-width: 400px;
            margin: 50px auto;
            background: rgba(255, 255, 255, 0.05);
            padding: 30px;
            border-radius: 12px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 5px;
            color: #aaa;
        }
        
        .form-input {
            width: 100%;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            font-size: 16px;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #00ff88;
        }
        
        .btn {
            background: #00ff88;
            color: #0a192f;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.3s ease;
            width: 100%;
            font-size: 16px;
        }
        
        .btn:hover {
            opacity: 0.9;
        }
        
        .btn-secondary {
            background: transparent;
            color: #00ff88;
            border: 1px solid #00ff88;
        }
        
        /* PLAYER */
        #playerSection {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        #youtubePlayer {
            width: 100%;
            height: 400px;
            border-radius: 8px;
        }
        
        /* MODAIS */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1001;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: #1a1a2e;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        /* TABELAS */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        th {
            background: rgba(255, 255, 255, 0.05);
            color: #00ff88;
        }
        
        /* RESPONSIVO */
        @media (max-width: 768px) {
            .music-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
            
            .nav-tabs {
                flex-wrap: wrap;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <!-- LOADING OVERLAY -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="spinner"></div>
        <p id="loadingMessage" style="margin-top: 15px;"></p>
    </div>

    <!-- TOAST CONTAINER -->
    <div id="toastContainer"></div>

    <!-- CONTAINER PRINCIPAL -->
    <div class="container">
        <!-- HEADER (VIS√çVEL AP√ìS LOGIN) -->
        <div id="headerSection" class="header" style="display: none;">
            <div class="logo">üéµ SELO MIV</div>
            <div class="user-info">
                <div class="balance">Saldo: <span id="currentBalance">R$ 0,00</span></div>
                <button onclick="handleLogout()" class="btn btn-secondary">Sair</button>
            </div>
        </div>

        <!-- TELAS DE CONTE√öDO -->
        <div id="loginSection" class="auth-form">
            <h2 style="text-align: center; margin-bottom: 30px; color: #00ff88;">Login</h2>
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" id="loginEmail" class="form-input" placeholder="seu@email.com">
            </div>
            <div class="form-group">
                <label class="form-label">Senha</label>
                <input type="password" id="loginPassword" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <button onclick="handleLogin()" class="btn">Entrar</button>
            <p style="text-align: center; margin-top: 20px;">
                N√£o tem conta? <a href="#" onclick="showRegisterForm()" style="color: #00ff88;">Cadastre-se</a>
            </p>
        </div>

        <div id="registerSection" class="auth-form" style="display: none;">
            <h2 style="text-align: center; margin-bottom: 30px; color: #00ff88;">Cadastro</h2>
            <div class="form-group">
                <label class="form-label">Nome Completo</label>
                <input type="text" id="registerName" class="form-input" placeholder="Seu nome">
            </div>
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" id="registerEmail" class="form-input" placeholder="seu@email.com">
            </div>
            <div class="form-group">
                <label class="form-label">Senha (m√≠nimo 6 caracteres)</label>
                <input type="password" id="registerPassword" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <div class="form-group">
                <label class="form-label">Tipo de Usu√°rio</label>
                <select id="registerType" class="form-input" onchange="toggleArtistLink()">
                    <option value="">Selecione...</option>
                    <option value="ouvinte">Ouvinte/Investidor</option>
                    <option value="artista">Artista</option>
                    <option value="admin">Administrador</option>
                </select>
            </div>
            <div class="form-group" id="artistLinkGroup" style="display: none;">
                <label class="form-label">Link do seu trabalho (YouTube/SoundCloud)</label>
                <input type="url" id="registerLink" class="form-input" placeholder="https://...">
            </div>
            <button onclick="handleRegister()" class="btn">Cadastrar</button>
            <p style="text-align: center; margin-top: 20px;">
                J√° tem conta? <a href="#" onclick="showLoginForm()" style="color: #00ff88;">Fa√ßa login</a>
            </p>
        </div>

        <!-- CONTE√öDO PRINCIPAL DO APP -->
        <div id="appContent" style="display: none;">
            <!-- PLAYER -->
            <div id="playerSection" style="display: none;">
                <h2 style="margin-bottom: 15px;">üéß Player</h2>
                <div id="youtubePlayer"></div>
            </div>

            <!-- NAVEGA√á√ÉO -->
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showSection('marketplace')">üéµ Marketplace</button>
                <button class="nav-tab" onclick="showSection('portfolio')">üìä Meus Investimentos</button>
                <button class="nav-tab" onclick="showSection('ledger')">üìã Extrato</button>
                <button class="nav-tab" id="artistTab" onclick="showSection('artist')" style="display: none;">üé§ √Årea do Artista</button>
                <button class="nav-tab" onclick="showSection('addMusic')" id="addMusicTab" style="display: none;">‚ûï Cadastrar M√∫sica</button>
            </div>

            <!-- SE√á√ïES DE CONTE√öDO -->
            <div id="marketplaceSection" class="content-section active">
                <h2>üéµ M√∫sicas Dispon√≠veis para Investimento</h2>
                <div class="music-grid" id="marketplaceGrid">
                    <!-- M√∫sicas ser√£o carregadas aqui -->
                </div>
            </div>

            <div id="portfolioSection" class="content-section">
                <h2>üìä Meus Investimentos</h2>
                <div class="table-container">
                    <table id="portfolioTable">
                        <thead>
                            <tr>
                                <th>M√∫sica</th>
                                <th>Artista</th>
                                <th>A√ß√µes</th>
                                <th>Valor Pago</th>
                                <th>Valor Atual</th>
                                <th>Lucro/Preju√≠zo</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Dados ser√£o carregados aqui -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="ledgerSection" class="content-section">
                <h2>üìã Hist√≥rico de Transa√ß√µes</h2>
                <div class="table-container">
                    <table id="ledgerTable">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Tipo</th>
                                <th>Descri√ß√£o</th>
                                <th>Valor</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Dados ser√£o carregados aqui -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="artistSection" class="content-section">
                <h2>üé§ √Årea do Artista</h2>
                <div id="artistStats">
                    <!-- Estat√≠sticas ser√£o carregadas aqui -->
                </div>
                <div id="artistMusics">
                    <!-- M√∫sicas do artista ser√£o carregadas aqui -->
                </div>
            </div>

            <div id="addMusicSection" class="content-section">
                <h2>‚ûï Cadastrar Nova M√∫sica</h2>
                <div class="auth-form" style="max-width: 600px;">
                    <div class="form-group">
                        <label class="form-label">T√≠tulo da M√∫sica *</label>
                        <input type="text" id="musicTitle" class="form-input" placeholder="Nome da m√∫sica">
                    </div>
                    <div class="form-group">
                        <label class="form-label">G√™nero *</label>
                        <select id="musicGenre" class="form-input">
                            <option value="">Selecione...</option>
                            <option value="POP">POP</option>
                            <option value="ROCK">ROCK</option>
                            <option value="HIPHOP">HIP HOP/RAP</option>
                            <option value="FUNK">FUNK</option>
                            <option value="SERTANEJO">SERTANEJO</option>
                            <option value="ELETRONICA">ELETR√îNICA</option>
                            <option value="MPB">MPB</option>
                            <option value="SAMBA">SAMBA</option>
                            <option value="PAGODE">PAGODE</option>
                            <option value="OUTRO">OUTRO</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Link do YouTube *</label>
                        <input type="url" id="musicYoutube" class="form-input" placeholder="https://www.youtube.com/watch?v=...">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Link da Capa (opcional)</label>
                        <input type="url" id="musicCover" class="form-input" placeholder="https://...">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Valor por A√ß√£o (R$) *</label>
                        <input type="number" id="musicPrice" class="form-input" min="1" step="0.01" value="10.00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Percentual Dispon√≠vel para Venda (%) *</label>
                        <input type="number" id="musicPercent" class="form-input" min="1" max="100" value="20">
                    </div>
                    <button onclick="registerMusic()" class="btn">Cadastrar M√∫sica</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL DE INVESTIMENTO -->
    <div id="investModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px;">üí∞ Investir em <span id="investMusicTitle"></span></h2>
            <div class="form-group">
                <label class="form-label">Valor por A√ß√£o: <span id="investPrice"></span></label>
            </div>
            <div class="form-group">
                <label class="form-label">Saldo Dispon√≠vel: <span id="investBalance"></span></label>
            </div>
            <div class="form-group">
                <label class="form-label">Quantidade de A√ß√µes *</label>
                <input type="number" id="investQuantity" class="form-input" min="1" value="1">
            </div>
            <div class="form-group">
                <label class="form-label">Valor Total: <span id="investTotal"></span></label>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 30px;">
                <button onclick="closeModal('investModal')" class="btn btn-secondary" style="flex: 1;">Cancelar</button>
                <button onclick="confirmInvestment()" class="btn" style="flex: 1;" id="confirmInvestBtn">Confirmar Investimento</button>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
    // ============================================
    // CONFIGURA√á√ïES GERAIS
    // ============================================
    const CONFIG = {
        API_URL: "https://script.google.com/macros/s/AKfycbwff3HqZztRq52nHP3s2qT9trrFpKBwIQ1WgY2OOnbVbgWRB4oUyt3DTpbR_hmbVJCE/exec",
        VERSION: "1.6.2",
        APP_NAME: "Selo MIV"
    };

    // ============================================
    // ESTADO GLOBAL DA APLICA√á√ÉO
    // ============================================
    const state = {
        currentUser: null,
        currentToken: null,
        userBalance: 0,
        playlist: [],
        portfolioAssets: [],
        ledgerData: [],
        artistData: {},
        youtubePlayer: null,
        currentInvestTrack: null
    };

    // ============================================
    // FUN√á√ïES DE UTILIDADE
    // ============================================
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        document.getElementById('toastContainer').appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 5000);
    }

    function showLoading(message = 'Carregando...') {
        document.getElementById('loadingOverlay').style.display = 'flex';
        document.getElementById('loadingMessage').textContent = message;
    }

    function hideLoading() {
        document.getElementById('loadingOverlay').style.display = 'none';
    }

    function formatCurrency(value) {
        return new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: 'BRL'
        }).format(value);
    }

    function extractYouTubeId(url) {
        if (!url) return null;
        const regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
        const match = url.match(regExp);
        return (match && match[7].length === 11) ? match[7] : null;
    }

    function showSection(sectionId) {
        // Remove active class de todas as tabs
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Remove active class de todas as sections
        document.querySelectorAll('.content-section').forEach(section => {
            section.classList.remove('active');
        });
        
        // Adiciona active na tab clicada
        event.target.classList.add('active');
        
        // Mostra a section correspondente
        document.getElementById(`${sectionId}Section`).classList.add('active');
    }

    function toggleArtistLink() {
        const type = document.getElementById('registerType').value;
        const linkGroup = document.getElementById('artistLinkGroup');
        linkGroup.style.display = type === 'artista' ? 'block' : 'none';
    }

    function showLoginForm() {
        document.getElementById('loginSection').style.display = 'block';
        document.getElementById('registerSection').style.display = 'none';
    }

    function showRegisterForm() {
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('registerSection').style.display = 'block';
    }

    function showModal(modalId) {
        document.getElementById(modalId).classList.add('active');
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('active');
    }

    // ============================================
    // 2.1 - handleLogin() - FUN√á√ÉO CORRIGIDA COMPLETA
    // ============================================
    async function handleLogin() {
        const email = document.getElementById('loginEmail').value.trim().toLowerCase();
        const password = document.getElementById('loginPassword').value.trim();
        
        if (!email || !password) {
            showToast('Preencha todos os campos', 'error');
            return;
        }

        showLoading('Autenticando...');

        try {
            // Bypass hardcoded para admin - use apenas para testes
            if (email === 'admin@miv.com' && password === 'admin123') {
                console.log('Usando credenciais de teste');
                state.currentUser = {
                    id: 1,
                    nome: 'Administrador',
                    email: 'admin@miv.com',
                    tipo: 'admin',
                    acesso: 'aprovado',
                    saldo: 1000
                };
                state.currentToken = 'admin_token_123';
                
                localStorage.setItem('miv_user', JSON.stringify(state.currentUser));
                localStorage.setItem('miv_token', state.currentToken);
                
                showToast('Login realizado com sucesso!', 'success');
                
                // Limpa campos
                document.getElementById('loginEmail').value = '';
                document.getElementById('loginPassword').value = '';
                
                initializeApp();
                return;
            }

            // Conex√£o real com a API via POST
            const formData = new URLSearchParams();
            formData.append('acao', 'login');
            formData.append('email', email);
            formData.append('password', password);

            console.log('Enviando login POST para:', CONFIG.API_URL);
            console.log('Payload:', formData.toString());

            const response = await fetch(CONFIG.API_URL, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'Accept': 'application/json'
                },
                body: formData
            });

            const data = await response.json();
            console.log('Resposta login POST:', data);

            if (data.success && data.data) {
                state.currentUser = data.data;
                state.currentToken = data.data.token || data.data.id;

                localStorage.setItem('miv_user', JSON.stringify(state.currentUser));
                localStorage.setItem('miv_token', state.currentToken);

                showToast('Login realizado com sucesso!', 'success');
                
                // Limpa campos
                document.getElementById('loginEmail').value = '';
                document.getElementById('loginPassword').value = '';
                
                initializeApp();
            } else {
                showToast(data.message || 'Credenciais inv√°lidas', 'error');
            }
        } catch (error) {
            console.error('Login error:', error);
            showToast('Erro de conex√£o com o servidor', 'error');
        } finally {
            hideLoading();
        }
    }

    // ============================================
    // 2.8 - handleRegister() - FUN√á√ÉO CORRIGIDA
    // ============================================
    async function handleRegister() {
        const name = document.getElementById('registerName').value.trim();
        const email = document.getElementById('registerEmail').value.trim().toLowerCase();
        const password = document.getElementById('registerPassword').value.trim();
        const type = document.getElementById('registerType').value;
        const link = document.getElementById('registerLink')?.value.trim() || '';

        // Valida√ß√µes
        if (!name || !email || !password || !type) {
            showToast('Preencha todos os campos obrigat√≥rios', 'error');
            return;
        }

        if (password.length < 6) {
            showToast('A senha deve ter no m√≠nimo 6 caracteres', 'error');
            return;
        }

        if (type === 'artista' && !link) {
            showToast('Artistas devem informar link do trabalho', 'error');
            return;
        }

        showLoading('Criando conta...');

        try {
            const formData = new URLSearchParams();
            formData.append('acao', 'register');
            formData.append('nome', name);
            formData.append('email', email);
            formData.append('password', password);
            formData.append('tipo', type);
            formData.append('workLink', link);

            console.log('Enviando registro:', CONFIG.API_URL);
            console.log('Payload:', formData.toString());

            const response = await fetch(CONFIG.API_URL, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'Accept': 'application/json'
                },
                body: formData
            });

            const data = await response.json();
            console.log('Resposta registro:', data);

            if (data.success) {
                showToast('Conta criada com sucesso! Aguarde aprova√ß√£o do administrador.', 'success');
                showLoginForm();
                // Limpa campos
                document.getElementById('registerName').value = '';
                document.getElementById('registerEmail').value = '';
                document.getElementById('registerPassword').value = '';
                document.getElementById('registerType').value = '';
                if (document.getElementById('registerLink')) {
                    document.getElementById('registerLink').value = '';
                }
            } else {
                showToast(data.message || 'Erro ao criar conta', 'error');
            }
        } catch (error) {
            console.error('Register error:', error);
            showToast('Erro de conex√£o com o servidor', 'error');
        } finally {
            hideLoading();
        }
    }

    // ============================================
    // 2.2 - initYouTubePlayer() - FUN√á√ÉO CORRIGIDA
    // ============================================
    function initYouTubePlayer(videoUrl) {
        if (!window.YT || !window.YT.Player) {
            showToast('YouTube Player n√£o carregado', 'error');
            return;
        }
        
        const videoId = extractYouTubeId(videoUrl);
        if (!videoId) {
            showToast('Link do YouTube inv√°lido', 'error');
            return;
        }
        
        // Destr√≥i player anterior se existir
        if (state.youtubePlayer) {
            try {
                state.youtubePlayer.destroy();
            } catch (e) {
                console.error('Erro ao destruir player anterior:', e);
            }
        }
        
        // Cria novo player com youtube-nocookie para evitar cookies
        try {
            state.youtubePlayer = new YT.Player('youtubePlayer', {
                height: '100%',
                width: '100%',
                videoId: videoId,
                host: 'https://www.youtube-nocookie.com',  // ‚Üê RESOLVE ERROS DE COOKIES
                playerVars: {
                    'autoplay': 1,
                    'controls': 0,
                    'disablekb': 1,
                    'modestbranding': 1,
                    'showinfo': 0,
                    'rel': 0,
                    'fs': 0,
                    'playsinline': 1
                },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange,
                    'onError': function(event) {
                        console.error('YouTube Player Error:', event.data);
                        showToast('Erro no player de v√≠deo', 'error');
                    }
                }
            });
            
            console.log('YouTube Player criado com host nocookie');
        } catch (error) {
            console.error('Erro ao criar YouTube player:', error);
            showToast('Erro ao iniciar player', 'error');
        }
    }

    function onPlayerReady(event) {
        console.log('YouTube Player pronto');
    }

    function onPlayerStateChange(event) {
        // L√≥gica para controle do player
        console.log('Estado do player:', event.data);
    }

    // ============================================
    // 2.3 - loadBalance() - FUN√á√ÉO CORRIGIDA
    // ============================================
    async function loadBalance() {
        if (!state.currentToken) return;
        
        try {
            const params = new URLSearchParams({
                acao: 'get_saldo',  // ‚Üê CORRIGIDO: acao em vez de action
                token: state.currentToken
            });
            
            console.log('Buscando saldo:', `${CONFIG.API_URL}?${params.toString()}`);
            
            const response = await fetch(`${CONFIG.API_URL}?${params.toString()}`);
            const data = await response.json();
            
            console.log('Resposta saldo:', data);
            
            if (data.success && data.data) {
                state.userBalance = parseFloat(data.data.saldo) || 0;
                const balanceElement = document.getElementById('currentBalance');
                if (balanceElement) {
                    balanceElement.textContent = formatCurrency(state.userBalance);
                }
            } else {
                // Usa saldo do localStorage como fallback
                state.userBalance = state.currentUser.saldo || 0;
                const balanceElement = document.getElementById('currentBalance');
                if (balanceElement) {
                    balanceElement.textContent = formatCurrency(state.userBalance);
                }
            }
        } catch (error) {
            console.error('Error loading balance:', error);
            state.userBalance = state.currentUser.saldo || 0;
            const balanceElement = document.getElementById('currentBalance');
            if (balanceElement) {
                balanceElement.textContent = formatCurrency(state.userBalance);
            }
        }
    }

    // ============================================
    // 2.4 - loadMarketplace() - FUN√á√ÉO CORRIGIDA
    // ============================================
    async function loadMarketplace() {
        try {
            console.log('Carregando marketplace...');
            
            // Primeiro tenta carregar da API
            const params = new URLSearchParams({
                acao: 'get_musicas',  // ‚Üê CORRIGIDO: acao em vez de action
                token: state.currentToken
            });
            
            console.log('Buscando m√∫sicas:', `${CONFIG.API_URL}?${params.toString()}`);
            
            const response = await fetch(`${CONFIG.API_URL}?${params.toString()}`);
            const data = await response.json();
            
            console.log('M√∫sicas da API:', data);
            
            if (data.success && data.data) {
                console.log('M√∫sicas carregadas da API:', data.data.length);
                state.playlist = data.data.filter(music => 
                    music && (music.status || '').toLowerCase() === 'ativo'
                ) || [];
            } else {
                console.log('API n√£o retornou dados, usando dados de exemplo');
                state.playlist = getSampleMusic();
            }
            
            renderMarketplace();
        } catch (error) {
            console.error('Error loading marketplace:', error);
            state.playlist = getSampleMusic();
            renderMarketplace();
            showToast('Usando dados de exemplo', 'info');
        }
    }

    function renderMarketplace() {
        const grid = document.getElementById('marketplaceGrid');
        if (!grid) return;
        
        grid.innerHTML = '';
        
        if (state.playlist.length === 0) {
            grid.innerHTML = '<p style="text-align: center; padding: 40px;">Nenhuma m√∫sica dispon√≠vel no momento.</p>';
            return;
        }
        
        state.playlist.forEach(music => {
            const card = document.createElement('div');
            card.className = 'music-card';
            card.innerHTML = `
                <img src="${music.link_capa || 'https://via.placeholder.com/300x300/111418/00ff88?text=MIV'}" 
                     alt="${music.titulo}" class="music-cover">
                <div class="music-info">
                    <div class="music-title">${music.titulo}</div>
                    <div class="music-artist">${music.artista || 'Artista'}</div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                        <div class="music-price">${formatCurrency(music.valor_acao || 10)}</div>
                        <button onclick="openInvestModal('${music.id}')" class="btn" style="padding: 8px 15px;">Investir</button>
                    </div>
                </div>
            `;
            grid.appendChild(card);
        });
    }

    function getSampleMusic() {
        return [
            {
                id: 'MUS001',
                titulo: 'M√∫sica Exemplo 1',
                artista: 'Artista Teste',
                genero: 'POP',
                link_youtube: 'https://www.youtube.com/watch?v=dQw4w9WgXcQ',
                link_capa: 'https://via.placeholder.com/300x300/111418/00ff88?text=MIV',
                valor_acao: 10.00,
                percentual_disponivel: 50,
                status: 'ativo'
            },
            {
                id: 'MUS002',
                titulo: 'M√∫sica Exemplo 2',
                artista: 'Outro Artista',
                genero: 'ROCK',
                link_youtube: 'https://www.youtube.com/watch?v=9bZkp7q19f0',
                link_capa: 'https://via.placeholder.com/300x300/111418/00ff88?text=MIV',
                valor_acao: 15.00,
                percentual_disponivel: 30,
                status: 'ativo'
            }
        ];
    }

    // ============================================
    // 2.5 - loadPortfolio() - FUN√á√ÉO CORRIGIDA
    // ============================================
    async function loadPortfolio() {
        if (!state.currentToken) return;
        
        try {
            const params = new URLSearchParams({
                acao: 'get_carteira',  // ‚Üê CORRIGIDO: acao em vez de action
                token: state.currentToken
            });
            
            console.log('Buscando carteira:', `${CONFIG.API_URL}?${params.toString()}`);
            
            const response = await fetch(`${CONFIG.API_URL}?${params.toString()}`);
            const data = await response.json();
            
            console.log('Resposta carteira:', data);
            
            if (data.success && data.data) {
                state.portfolioAssets = data.data || [];
            } else {
                state.portfolioAssets = [];
            }
            
            renderPortfolio();
        } catch (error) {
            console.error('Error loading portfolio:', error);
            state.portfolioAssets = [];
            renderPortfolio();
        }
    }

    function renderPortfolio() {
        const tableBody = document.querySelector('#portfolioTable tbody');
        if (!tableBody) return;
        
        tableBody.innerHTML = '';
        
        if (state.portfolioAssets.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center; padding: 30px;">
                        Voc√™ ainda n√£o possui investimentos.
                    </td>
                </tr>
            `;
            return;
        }
        
        state.portfolioAssets.forEach(asset => {
            const row = document.createElement('tr');
            const variacao = asset.percentual_variacao || 0;
            const cor = variacao >= 0 ? '#00ff88' : '#ef4444';
            
            row.innerHTML = `
                <td>${asset.titulo_musica || 'M√∫sica'}</td>
                <td>${asset.artista || 'Artista'}</td>
                <td>${asset.quantidade_acoes || 0}</td>
                <td>${formatCurrency(asset.valor_total_investido || 0)}</td>
                <td>${formatCurrency(asset.valor_atual_total || 0)}</td>
                <td style="color: ${cor}">
                    ${formatCurrency(asset.lucro_prejuizo || 0)} (${variacao.toFixed(2)}%)
                </td>
            `;
            tableBody.appendChild(row);
        });
    }

    // ============================================
    // 2.6 - loadLedger() - FUN√á√ÉO CORRIGIDA
    // ============================================
    async function loadLedger() {
        if (!state.currentToken) return;
        
        try {
            const params = new URLSearchParams({
                acao: 'get_extrato',  // ‚Üê CORRIGIDO: acao em vez de action
                token: state.currentToken
            });
            
            console.log('Buscando extrato:', `${CONFIG.API_URL}?${params.toString()}`);
            
            const response = await fetch(`${CONFIG.API_URL}?${params.toString()}`);
            const data = await response.json();
            
            console.log('Resposta extrato:', data);
            
            if (data.success && data.data) {
                state.ledgerData = data.data || [];
            } else {
                state.ledgerData = [];
            }
            
            renderLedger();
        } catch (error) {
            console.error('Error loading ledger:', error);
            state.ledgerData = [];
            renderLedger();
        }
    }

    function renderLedger() {
        const tableBody = document.querySelector('#ledgerTable tbody');
        if (!tableBody) return;
        
        tableBody.innerHTML = '';
        
        if (state.ledgerData.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="4" style="text-align: center; padding: 30px;">
                        Nenhuma transa√ß√£o registrada.
                    </td>
                </tr>
            `;
            return;
        }
        
        state.ledgerData.forEach(trans => {
            const row = document.createElement('tr');
            const data = new Date(trans.data || Date.now());
            const valor = trans.valor || 0;
            const cor = valor >= 0 ? '#00ff88' : '#ef4444';
            
            row.innerHTML = `
                <td>${data.toLocaleDateString('pt-BR')}</td>
                <td>${trans.tipo || 'Transa√ß√£o'}</td>
                <td>${trans.descricao || 'Sem descri√ß√£o'}</td>
                <td style="color: ${cor}">${formatCurrency(valor)}</td>
            `;
            tableBody.appendChild(row);
        });
    }

    // ============================================
    // 2.7 - loadArtistData() - FUN√á√ÉO CORRIGIDA
    // ============================================
    async function loadArtistData() {
        if (!state.currentToken || (state.currentUser.tipo !== 'artista' && state.currentUser.tipo !== 'admin')) return;
        
        try {
            const params = new URLSearchParams({
                acao: 'get_artist_data',  // ‚Üê CORRIGIDO: acao em vez de action
                token: state.currentToken
            });
            
            console.log('Buscando dados artista:', `${CONFIG.API_URL}?${params.toString()}`);
            
            const response = await fetch(`${CONFIG.API_URL}?${params.toString()}`);
            const data = await response.json();
            
            console.log('Resposta dados artista:', data);
            
            if (data.success && data.data) {
                state.artistData = data.data || {};
            } else {
                state.artistData = {};
            }
            
            renderArtistData();
        } catch (error) {
            console.error('Error loading artist data:', error);
            state.artistData = {};
            renderArtistData();
        }
    }

    function renderArtistData() {
        const statsDiv = document.getElementById('artistStats');
        const musicsDiv = document.getElementById('artistMusics');
        
        if (!statsDiv || !musicsDiv) return;
        
        // Renderizar estat√≠sticas
        statsDiv.innerHTML = `
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0;">
                <div style="background: rgba(0, 255, 136, 0.1); padding: 20px; border-radius: 8px;">
                    <div style="font-size: 12px; color: #aaa;">Total de M√∫sicas</div>
                    <div style="font-size: 24px; font-weight: bold; color: #00ff88;">${state.artistData.total_musicas || 0}</div>
                </div>
                <div style="background: rgba(0, 255, 136, 0.1); padding: 20px; border-radius: 8px;">
                    <div style="font-size: 12px; color: #aaa;">Total Arrecadado</div>
                    <div style="font-size: 24px; font-weight: bold; color: #00ff88;">${formatCurrency(state.artistData.total_arrecadado || 0)}</div>
                </div>
                <div style="background: rgba(0, 255, 136, 0.1); padding: 20px; border-radius: 8px;">
                    <div style="font-size: 12px; color: #aaa;">Royalties Acumulados</div>
                    <div style="font-size: 24px; font-weight: bold; color: #00ff88;">${formatCurrency(state.artistData.total_royalties || 0)}</div>
                </div>
            </div>
        `;
        
        // Renderizar m√∫sicas do artista
        if (state.artistData.musicas && state.artistData.musicas.length > 0) {
            musicsDiv.innerHTML = '<h3 style="margin: 30px 0 15px 0;">Minhas M√∫sicas</h3>';
            
            state.artistData.musicas.forEach(music => {
                const musicDiv = document.createElement('div');
                musicDiv.style.cssText = `
                    background: rgba(255, 255, 255, 0.05);
                    padding: 15px;
                    border-radius: 8px;
                    margin-bottom: 10px;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                `;
                
                musicDiv.innerHTML = `
                    <div>
                        <div style="font-weight: bold;">${music.titulo}</div>
                        <div style="font-size: 14px; color: #aaa;">
                            ${music.genero} | 
                            ${formatCurrency(music.valor_acao)} por a√ß√£o | 
                            ${music.percentual_vendido || 0}% vendido
                        </div>
                    </div>
                    <div>
                        <div style="text-align: right;">
                            <div style="font-size: 18px; font-weight: bold; color: #00ff88;">${formatCurrency(music.arrecadacao_total || 0)}</div>
                            <div style="font-size: 12px; color: #aaa;">arrecadado</div>
                        </div>
                    </div>
                `;
                
                musicsDiv.appendChild(musicDiv);
            });
        } else {
            musicsDiv.innerHTML = '<p style="text-align: center; padding: 30px;">Nenhuma m√∫sica cadastrada ainda.</p>';
        }
    }

    // ============================================
    // 2.9 - registerMusic() - FUN√á√ÉO CORRIGIDA
    // ============================================
    async function registerMusic() {
        if (!state.currentToken || (state.currentUser.tipo !== 'artista' && state.currentUser.tipo !== 'admin')) {
            showToast('Apenas artistas podem cadastrar m√∫sicas', 'error');
            return;
        }
        
        const title = document.getElementById('musicTitle')?.value.trim() || '';
        const genre = document.getElementById('musicGenre')?.value || '';
        const youtube = document.getElementById('musicYoutube')?.value.trim() || '';
        const cover = document.getElementById('musicCover')?.value.trim() || '';
        const price = parseFloat(document.getElementById('musicPrice')?.value) || 0;
        const percent = parseFloat(document.getElementById('musicPercent')?.value) || 0;
        
        // Valida√ß√µes
        if (!title || !genre || !youtube) {
            showToast('Preencha todos os campos obrigat√≥rios', 'error');
            return;
        }
        
        if (price <= 0) {
            showToast('O valor por a√ß√£o deve ser maior que zero', 'error');
            return;
        }
        
        if (percent <= 0 || percent > 100) {
            showToast('O percentual deve estar entre 1% e 100%', 'error');
            return;
        }
        
        // Valida link do YouTube
        const videoId = extractYouTubeId(youtube);
        if (!videoId) {
            showToast('Link do YouTube inv√°lido', 'error');
            return;
        }
        
        showLoading('Cadastrando m√∫sica...');
        
        try {
            const formData = new URLSearchParams();
            formData.append('acao', 'add_music');
            formData.append('token', state.currentToken);
            formData.append('titulo', title);
            formData.append('genero', genre);
            formData.append('link_youtube', youtube);
            formData.append('link_capa', cover);
            formData.append('valor_acao', price.toString());
            formData.append('percentual_disponivel', percent.toString());
            
            console.log('Cadastrando m√∫sica:', CONFIG.API_URL);
            console.log('Payload:', formData.toString());
            
            const response = await fetch(CONFIG.API_URL, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'Accept': 'application/json'
                },
                body: formData
            });
            
            const data = await response.json();
            console.log('Resposta cadastro m√∫sica:', data);
            
            if (data.success) {
                showToast('M√∫sica cadastrada com sucesso!', 'success');
                
                // Recarrega dados
                await Promise.all([
                    loadArtistData(),
                    loadMarketplace()
                ]);
                
                closeModal('addMusicModal');
                document.getElementById('musicTitle').value = '';
                document.getElementById('musicYoutube').value = '';
                document.getElementById('musicCover').value = '';
                document.getElementById('musicPrice').value = '10.00';
                document.getElementById('musicPercent').value = '20';
            } else {
                showToast(data.message || 'Erro ao cadastrar m√∫sica', 'error');
            }
        } catch (error) {
            console.error('Register music error:', error);
            showToast('Erro de conex√£o ao cadastrar m√∫sica', 'error');
        } finally {
            hideLoading();
        }
    }

    // ============================================
    // 2.10 - confirmInvestment() - FUN√á√ÉO CORRIGIDA
    // ============================================
    async function confirmInvestment() {
        if (!state.currentInvestTrack || !state.currentToken) {
            showToast('Erro ao processar investimento', 'error');
            return;
        }
        
        const quantityInput = document.getElementById('investQuantity');
        const quantity = quantityInput ? parseInt(quantityInput.value) || 1 : 1;
        const totalPrice = quantity * (state.currentInvestTrack.valor_acao || state.currentInvestTrack.VALOR_ACAO || 0);
        
        if (totalPrice > state.userBalance) {
            showToast('Saldo insuficiente para esta compra', 'error');
            return;
        }
        
        if (quantity <= 0) {
            showToast('Quantidade inv√°lida', 'error');
            return;
        }
        
        showLoading('Processando investimento...');
        
        try {
            const formData = new URLSearchParams();
            formData.append('acao', 'invest');
            formData.append('token', state.currentToken);
            formData.append('music_id', state.currentInvestTrack.id || state.currentInvestTrack.ID);
            formData.append('quantidade_acoes', quantity.toString());
            formData.append('valor_total', totalPrice.toString());
            
            console.log('Enviando investimento:', CONFIG.API_URL);
            console.log('Payload:', formData.toString());
            
            const response = await fetch(CONFIG.API_URL, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'Accept': 'application/json'
                },
                body: formData
            });
            
            const data = await response.json();
            console.log('Resposta investimento:', data);
            
            if (data.success) {
                showToast(`Investimento realizado com sucesso! ${quantity} a√ß√£o(√µes) comprada(s).`, 'success');
                
                // Atualiza dados locais
                state.userBalance -= totalPrice;
                const balanceElement = document.getElementById('currentBalance');
                if (balanceElement) {
                    balanceElement.textContent = formatCurrency(state.userBalance);
                }
                
                // Recarrega dados
                await Promise.all([
                    loadPortfolio(),
                    loadLedger(),
                    loadMarketplace()
                ]);
                
                closeModal('investModal');
            } else {
                showToast(data.message || 'Erro ao processar investimento', 'error');
            }
        } catch (error) {
            console.error('Investment error:', error);
            showToast('Erro de conex√£o ao processar investimento', 'error');
        } finally {
            hideLoading();
        }
    }

    // ============================================
    // FUN√á√ïES ADICIONAIS
    // ============================================
    function openInvestModal(musicId) {
        const music = state.playlist.find(m => m.id === musicId);
        if (!music) {
            showToast('M√∫sica n√£o encontrada', 'error');
            return;
        }
        
        state.currentInvestTrack = music;
        
        document.getElementById('investMusicTitle').textContent = music.titulo;
        document.getElementById('investPrice').textContent = formatCurrency(music.valor_acao);
        document.getElementById('investBalance').textContent = formatCurrency(state.userBalance);
        
        // Atualiza valor total quando quantidade muda
        const quantityInput = document.getElementById('investQuantity');
        const updateTotal = () => {
            const quantity = parseInt(quantityInput.value) || 1;
            const total = quantity * music.valor_acao;
            document.getElementById('investTotal').textContent = formatCurrency(total);
            
            // Desabilita bot√£o se saldo insuficiente
            const confirmBtn = document.getElementById('confirmInvestBtn');
            confirmBtn.disabled = total > state.userBalance;
        };
        
        quantityInput.value = 1;
        quantityInput.oninput = updateTotal;
        updateTotal();
        
        showModal('investModal');
    }

    function initializeApp() {
        console.log('Inicializando app...');
        
        // Carrega dados do localStorage
        const savedUser = localStorage.getItem('miv_user');
        const savedToken = localStorage.getItem('miv_token');
        
        if (savedUser && savedToken) {
            state.currentUser = JSON.parse(savedUser);
            state.currentToken = savedToken;
        }
        
        if (state.currentUser && state.currentToken) {
            // Mostra interface do app
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('registerSection').style.display = 'none';
            document.getElementById('headerSection').style.display = 'flex';
            document.getElementById('appContent').style.display = 'block';
            
            // Atualiza interface baseada no tipo de usu√°rio
            if (state.currentUser.tipo === 'artista' || state.currentUser.tipo === 'admin') {
                document.getElementById('artistTab').style.display = 'inline-block';
                document.getElementById('addMusicTab').style.display = 'inline-block';
            }
            
            // Carrega dados iniciais
            Promise.all([
                loadBalance(),
                loadMarketplace(),
                loadPortfolio(),
                loadLedger(),
                loadArtistData()
            ]).then(() => {
                console.log('Todos os dados carregados');
                showToast('Bem-vindo, ' + state.currentUser.nome + '!', 'success');
            }).catch(error => {
                console.error('Erro ao carregar dados:', error);
                showToast('Erro ao carregar dados. Algumas funcionalidades podem n√£o estar dispon√≠veis.', 'warning');
            });
        } else {
            // Mostra tela de login
            showLoginForm();
        }
    }

    function handleLogout() {
        if (confirm('Tem certeza que deseja sair?')) {
            localStorage.removeItem('miv_user');
            localStorage.removeItem('miv_token');
            state.currentUser = null;
            state.currentToken = null;
            
            document.getElementById('appContent').style.display = 'none';
            document.getElementById('headerSection').style.display = 'none';
            showLoginForm();
            
            showToast('Voc√™ saiu do sistema.', 'info');
        }
    }

    // Inicializa a aplica√ß√£o quando a p√°gina carrega
    document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
