<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cadastrar Ouvinte - SELO MIV</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script>
    // URL DA SUA API CORRETA
    const API_URL = "https://script.google.com/macros/s/AKfycbx7PBO6bOZ9tOFugfaFE-QBiZ5jFtFHddvB42mMH4aJG8LUxR9jkXtjJMJ3-x-0n9v2/exec";

    // Fun√ß√£o para cadastrar ouvinte
    async function cadastrarOuvinte() {
      const nome = document.getElementById('nome').value.trim();
      const email = document.getElementById('email').value.trim();

      if (!nome || !email) {
        alert('‚ùå Preencha nome e e-mail.');
        return;
      }

      // Mostrar loading
      const btn = document.querySelector('button');
      const originalText = btn.innerHTML;
      btn.innerHTML = 'Cadastrando...';
      btn.disabled = true;

      try {
        // M√©todo 1: Form URL encoded
        const formData = new URLSearchParams();
        formData.append('acao', 'cadastrar_ouvinte');
        formData.append('nome', nome);
        formData.append('email', email);

        console.log('Enviando dados:', { nome, email });
        
        const res = await fetch(API_URL, {
          method: 'POST',
          mode: 'no-cors', // IMPORTANTE para Apps Script
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: formData.toString()
        });

        // Com no-cors, n√£o podemos ler a resposta normalmente
        // Vamos fazer uma verifica√ß√£o separada
        alert('‚úÖ Cadastro enviado! Verifique na planilha.');

        // Limpar campos
        document.getElementById('nome').value = '';
        document.getElementById('email').value = '';

        // Testar se foi cadastrado
        setTimeout(() => testarCadastro(), 2000);

      } catch (err) {
        console.error('Erro:', err);
        alert('‚ö†Ô∏è Dados enviados. Pode haver delay no processamento.');
      } finally {
        // Restaurar bot√£o
        btn.innerHTML = originalText;
        btn.disabled = false;
      }
    }

    // Fun√ß√£o para testar se o cadastro funcionou
    async function testarCadastro() {
      try {
        const res = await fetch(API_URL + '?acao=listar_artistas');
        const data = await res.json();
        console.log('Teste API:', data);
      } catch (e) {
        console.log('API test response:', e);
      }
    }
  </script>
</head>
<body class="bg-dark text-white">
  <div class="container py-5">
    <h2 class="mb-4">üéß Cadastrar Ouvinte - SELO MIV</h2>
    
    <div class="card bg-secondary text-white mb-4">
      <div class="card-body">
        <p><strong>URL API:</strong> <small id="apiUrl"></small></p>
        <button class="btn btn-sm btn-info mb-2" onclick="testarAPI()">Testar Conex√£o API</button>
        <div id="apiStatus"></div>
      </div>
    </div>

    <div class="card bg-secondary text-white">
      <div class="card-body">
        <div class="mb-3">
          <label for="nome" class="form-label">Nome Completo</label>
          <input type="text" class="form-control bg-dark text-white" id="nome" placeholder="Digite seu nome completo">
        </div>

        <div class="mb-3">
          <label for="email" class="form-label">E-mail</label>
          <input type="email" class="form-control bg-dark text-white" id="email" placeholder="exemplo@email.com">
        </div>

        <button class="btn btn-primary btn-lg w-100" onclick="cadastrarOuvinte()">
          Cadastrar Ouvinte
        </button>
        
        <div class="mt-3 text-center">
          <small>Ap√≥s cadastrar, verifique a planilha "OUVINTES"</small>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Mostrar URL da API
    document.getElementById('apiUrl').textContent = API_URL;
    
    // Fun√ß√£o para testar conex√£o
    async function testarAPI() {
      try {
        const statusDiv = document.getElementById('apiStatus');
        statusDiv.innerHTML = '<div class="spinner-border spinner-border-sm"></div> Testando...';
        
        const res = await fetch(API_URL + '?acao=testar_conexao');
        const data = await res.json();
        
        if (data.success) {
          statusDiv.innerHTML = `<span class="text-success">‚úÖ API Online (${data.data})</span>`;
        } else {
          statusDiv.innerHTML = `<span class="text-warning">‚ö†Ô∏è ${data.message}</span>`;
        }
      } catch (err) {
        document.getElementById('apiStatus').innerHTML = 
          `<span class="text-danger">‚ùå Erro: ${err.message}</span>`;
      }
    }
    
    // Testar ao carregar a p√°gina
    window.onload = testarAPI;
  </script>
</body>
</html>
