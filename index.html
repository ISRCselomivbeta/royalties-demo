<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Selo MIV - Royalties Musicais</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-green: #00ff88;
      --primary-blue: #0072ff;
      --bg-dark: #07090c;
      --text-light: #f8f9fa;
      --card-bg: #111418;
      --shadow: rgba(0, 0, 0, 0.5);
    }
    body {
      background: var(--bg-dark);
      color: var(--text-light);
      font-family: 'Outfit', sans-serif;
      overflow: hidden;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    #loading {
      display: flex;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--bg-dark);
      z-index: 9999;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
    #auth-screen {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: var(--bg-dark);
    }
    .auth-container {
      max-width: 400px;
      background: var(--card-bg);
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 10px 20px var(--shadow);
    }
    #main-app {
      display: none;
      flex: 1;
      overflow: hidden;
    }
    #sidebar {
      background: var(--card-bg);
      padding: 20px;
      border-right: 1px solid rgba(255,255,255,0.1);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    #content {
      flex: 1;
      overflow-y: auto;
      padding: 30px;
    }
    #player-bar {
      background: var(--card-bg);
      padding: 15px;
      border-top: 1px solid rgba(255,255,255,0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: fixed;
      bottom: 0;
      width: 100%;
    }
    #bottom-nav {
      display: none;
      background: var(--card-bg);
      padding: 10px;
      border-top: 1px solid rgba(255,255,255,0.1);
      position: fixed;
      bottom: 0;
      width: 100%;
    }
    .card-music {
      background: var(--card-bg);
      border: none;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 5px 15px var(--shadow);
    }
    .btn-primary {
      background: var(--primary-green);
      border: none;
    }
    .btn-primary:hover {
      background: darken(var(--primary-green), 10%);
    }
    @media (max-width: 768px) {
      #sidebar { display: none; }
      #bottom-nav { display: flex; }
      #content { padding-bottom: 60px; }
    }
  </style>
</head>
<body>

<!-- Loading Screen -->
<div id="loading">
  <div class="spinner-border text-primary-green" role="status"></div>
  <p class="mt-3">Carregando Selo MIV...</p>
</div>

<!-- Auth Screen -->
<div id="auth-screen">
  <div class="auth-container">
    <h2 class="text-center mb-4">Selo MIV</h2>
    <div class="mb-3">
      <input type="text" id="nome" class="form-control" placeholder="Nome" style="display:none;">
    </div>
    <div class="mb-3">
      <input type="email" id="email" class="form-control" placeholder="E-mail">
    </div>
    <div class="mb-3">
      <input type="password" id="senha" class="form-control" placeholder="Senha">
    </div>
    <div class="mb-3" id="tipo-container" style="display:none;">
      <select id="tipo" class="form-control">
        <option value="">Selecione o tipo</option>
        <option value="artista">Artista</option>
        <option value="investidor">Investidor</option>
      </select>
    </div>
    <button class="btn btn-primary w-100" onclick="logarOuCadastrar()">Entrar</button>
    <p class="text-center mt-3">
      <a href="#" onclick="toggleCadastro()" id="toggle-link">Não tem conta? Cadastre-se</a>
    </p>
  </div>
</div>

<!-- Main App -->
<div id="main-app" class="d-flex">
  <!-- Sidebar -->
  <nav id="sidebar" class="d-none d-md-flex">
    <div>
      <h4>Selo MIV</h4>
      <ul class="list-unstyled">
        <li class="mb-3"><a href="#" onclick="carregarMarketplace()" class="text-light">Marketplace</a></li>
        <li class="mb-3"><a href="#" onclick="carregarCarteira()" class="text-light">Carteira</a></li>
        <li class="mb-3"><a href="#" onclick="carregarPainelArtista()" class="text-light">Painel Artista</a></li>
      </ul>
    </div>
    <div>
      <a href="#" onclick="sair()" class="text-light">Sair</a>
    </div>
  </nav>

  <!-- Content -->
  <main id="content">
    <div id="marketplace">
      <h3>Marketplace</h3>
      <div class="row" id="musicas-list"></div>
    </div>
    <div id="carteira" style="display:none;">
      <h3>Carteira</h3>
      <p>Saldo: R$ <span id="saldo"></span></p>
      <div id="investimentos-list"></div>
    </div>
    <div id="painel-artista" style="display:none;">
      <h3>Painel Artista</h3>
      <p>Seus royalties e músicas aqui.</p>
    </div>
  </main>

  <!-- Bottom Nav for Mobile -->
  <nav id="bottom-nav" class="d-md-none d-flex justify-content-around">
    <a href="#" onclick="carregarMarketplace()"><i class="bi bi-shop"></i></a>
    <a href="#" onclick="carregarCarteira()"><i class="bi bi-wallet"></i></a>
    <a href="#" onclick="carregarPainelArtista()"><i class="bi bi-music-note"></i></a>
    <a href="#" onclick="sair()"><i class="bi bi-box-arrow-right"></i></a>
  </nav>

  <!-- Player Bar -->
  <div id="player-bar" style="display:none;">
    <span id="musica-tocando"></span>
    <div id="player-controls">
      <i class="bi bi-play-fill" onclick="playPause()"></i>
      <i class="bi bi-skip-forward-fill" onclick="next()"></i>
    </div>
  </div>
</div>

<script>
  const API_URL = 'https://script.google.com/macros/s/AKfycbyJHPnRlQkcKTjkoGlhFrgWkplLnPrYWEnbREWtrtihHGM6mCxjK5bUXM83PV1PL0Y/exec';  // Atualizada para implantação real

  window.onload = () => {
    setTimeout(() => {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('auth-screen').style.display = 'flex';
    }, 2000);
  };

  let isCadastro = false;

  function toggleCadastro() {
    isCadastro = !isCadastro;
    document.getElementById('nome').style.display = isCadastro ? 'block' : 'none';
    document.getElementById('tipo-container').style.display = isCadastro ? 'block' : 'none';
    document.getElementById('toggle-link').innerText = isCadastro ? 'Já tem conta? Entrar' : 'Não tem conta? Cadastre-se';
  }

  function logarOuCadastrar() {
    if (isCadastro) {
      cadastrar();
    } else {
      logar();
    }
  }

  async function cadastrar() {
    const nome = document.getElementById('nome').value;
    const email = document.getElementById('email').value;
    const password = document.getElementById('senha').value;
    const tipo = document.getElementById('tipo').value;

    const response = await fetch(API_URL, {
      method: 'POST',
      body: JSON.stringify({action: 'register', nome, email, password, tipo})
    });
    const result = await response.json();
    if (result.success) {
      alert(result.message);
    } else {
      alert(result.error);
    }
  }

  async function logar() {
    const email = document.getElementById('email').value;
    const password = document.getElementById('senha').value;

    const response = await fetch(API_URL, {
      method: 'POST',
      body: JSON.stringify({action: 'login', email, password})
    });
    const result = await response.json();
    if (result.success) {
      localStorage.setItem('user', JSON.stringify(result.user));
      document.getElementById('auth-screen').style.display = 'none';
      document.getElementById('main-app').style.display = 'flex';
      carregarMarketplace();
    } else {
      alert(result.error);
    }
  }

  function sair() {
    localStorage.clear();
    location.reload();
  }

  async function carregarMarketplace() {
    const user = JSON.parse(localStorage.getItem('user'));
    if (!user) return sair();

    const response = await fetch(API_URL, {
      method: 'POST',
      body: JSON.stringify({action: 'getMusicas', userId: user.id})
    });
    const result = await response.json();
    const list = document.getElementById('musicas-list');
    list.innerHTML = '';
    result.musicas.forEach(musica => {
      list.innerHTML += `
        <div class="col-md-4 mb-4">
          <div class="card card-music">
            <div class="card-body">
              <h5>${musica.nome}</h5>
              <p>Artista: ${musica.artistaId}</p>
              <p>Preço por ação: R$ ${musica.precoAcao}</p>
              <p>Ações disponíveis: ${musica.acoesDisponiveis}</p>
              <button class="btn btn-primary" onclick="comprarAcoes('${musica.id}', 1)">Comprar</button>
              <button class="btn btn-secondary" onclick="carregarPlayer('${musica.youtubeUrl}')">Ouvir</button>
            </div>
          </div>
        </div>
      `;
    });
  }

  async function comprarAcoes(musicaId, quantidade) {
    const user = JSON.parse(localStorage.getItem('user'));
    if (!user) return sair();

    const response = await fetch(API_URL, {
      method: 'POST',
      body: JSON.stringify({action: 'buy', userId: user.id, musicaId, quantidade})
    });
    const result = await response.json();
    if (result.success) {
      alert(result.message);
      carregarMarketplace();
    } else {
      alert(result.error);
    }
  }

  async function carregarCarteira() {
    const user = JSON.parse(localStorage.getItem('user'));
    if (!user) return sair();

    const response = await fetch(API_URL, {
      method: 'POST',
      body: JSON.stringify({action: 'getSaldo', userId: user.id})
    });
    const result = await response.json();
    document.getElementById('saldo').innerText = result.saldo;
    // Adicione lógica para listar investimentos se necessário
  }

  function carregarPainelArtista() {
    // Placeholder original – atualize se necessário
    alert('Painel do artista em desenvolvimento');
  }

  function carregarPlayer(youtubeUrl) {
    document.getElementById('player-bar').style.display = 'flex';
    document.getElementById('musica-tocando').innerText = 'Tocando música...';
    // Embed YouTube real para streams
    document.getElementById('player-controls').innerHTML = `
      <iframe width="100%" height="80" src="https://www.youtube.com/embed/${extractVideoId(youtubeUrl)}?autoplay=1" frameborder="0" allowfullscreen></iframe>
    `;
  }

  function extractVideoId(url) {
    var match = url.match(/v=([^&]+)/);
    return match ? match[1] : null;
  }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
