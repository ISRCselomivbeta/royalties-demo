<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>SELO MIV PRO</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body{background:#000;color:#fff;font-family:Arial}
.card{background:#111;border-radius:16px;padding:15px;margin-bottom:10px}
.btn-miv{background:#00ff88;color:#000;border:none}
</style>
</head>
<body>

<div id="login" class="container mt-5">
  <input id="email" class="form-control mb-2" placeholder="Email">
  <input id="senha" type="password" class="form-control mb-2" placeholder="Senha">
  <button class="btn btn-miv w-100" onclick="login()">ENTRAR</button>
</div>

<div id="app" style="display:none" class="container mt-4">
  <h3>Saldo: R$ <span id="saldo">0</span></h3>
  <button class="btn btn-outline-success w-100 mb-3" onclick="cadastrar()">TOKENIZAR</button>
  <div id="market"></div>
</div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxovlwyahoFSQmwDBOMLGgQYpdmkKKI8AB_bJhh3WoI1imw_T1JG5kOY3xfWMEcayI/exec";

let user = null;
let ytPlayer = null;
let musicaAtualId = null;

/* ===== LOGIN ===== */
async function acaoLogin() {
  const email = document.getElementById('l-email').value;
  const pass = document.getElementById('l-pass').value;
  const btn = document.getElementById('btn-login');

  btn.innerText = "CONECTANDO...";

  try {
    const res = await fetch(`${API_URL}?acao=login&usuario=${encodeURIComponent(email)}&senha=${encodeURIComponent(pass)}`);
    const data = await res.json();

    if (!data.success) {
      alert("Usuário ou senha inválidos");
      btn.innerText = "ENTRAR";
      return;
    }

    user = data;
    localStorage.setItem("miv_session", JSON.stringify(data));
    renderApp(data);

  } catch (err) {
    alert("Erro de conexão com o servidor");
    console.error(err);
    btn.innerText = "ENTRAR";
  }
}

/* ===== RENDER ===== */
function renderApp(data) {
  document.getElementById("auth-page").style.display = "none";
  document.getElementById("main-app").style.display = "block";
  document.getElementById("user-saldo").innerText =
    Number(data.saldo).toLocaleString("pt-BR",{minimumFractionDigits:2});
  document.getElementById("user-nome").innerText = data.nome;
  document.getElementById("user-tipo").innerText = data.tipo.toUpperCase();

  if (data.tipo === "artista")
    document.getElementById("area-artista").style.display = "block";

  carregarMercado();
}

/* ===== MERCADO ===== */
async function carregarMercado() {
  const el = document.getElementById("market-list");
  el.innerHTML = "Carregando mercado...";

  try {
    const res = await fetch(`${API_URL}?acao=listar_mercado`);
    const data = await res.json();

    el.innerHTML = data.musicas.map(m => `
      <div class="music-card" onclick="tocarMusica('${m.videoId}','${m.titulo}','${m.artista}','${m.id}')">
        <div class="btn-play-miv"><i class="bi bi-play-fill"></i></div>
        <div class="flex-grow-1">
          <div class="fw-bold">${m.titulo}</div>
          <small class="text-secondary">${m.artista}</small>
        </div>
        <button class="btn btn-sm btn-dark text-success"
          onclick="event.stopPropagation(); comprar('${m.id}',${m.valor})">
          R$ ${m.valor}
        </button>
      </div>
    `).join("");

  } catch (e) {
    el.innerHTML = "Erro ao carregar mercado";
  }
}

/* ===== COMPRA ===== */
function comprar(id, valor) {
  if (!confirm(`Confirmar compra de R$ ${valor}?`)) return;

  fetch(`${API_URL}?acao=negociar_acao&user_id=${user.id}&musica_id=${id}&valor_total=${valor}&quantidade=1`)
    .then(r=>r.json())
    .then(d=>alert("Cota adquirida"));
}

/* ===== PLAYER ===== */
function onYouTubeIframeAPIReady() {
  ytPlayer = new YT.Player('player', {
    height:'0', width:'0',
    events:{
      onStateChange:(e)=>{
        if(e.data===1){
          setTimeout(()=>{
            if(ytPlayer.getPlayerState()===1 && musicaAtualId){
              fetch(`${API_URL}?acao=registrar_play&userId=${user.id}&musicaId=${musicaAtualId}`);
            }
          },30000);
        }
      }
    }
  });
}

function tocarMusica(v,t,a,id){
  musicaAtualId=id;
  document.getElementById("p-title").innerText=t;
  document.getElementById("p-artist").innerText=a;
  ytPlayer.loadVideoById(v);
}

/* ===== AUTOLOGIN ===== */
window.onload=()=>{
  const s = localStorage.getItem("miv_session");
  if(s){
    user = JSON.parse(s);
    renderApp(user);
  }
};
</script>
