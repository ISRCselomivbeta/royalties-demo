<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIV Music Pro | Fintech Musical</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
        /* Seu CSS original mantido integralmente – sem alterações aqui para não poluir */
        /* ... cole todo o seu <style> anterior aqui ... */
    </style>
</head>
<body>
    <!-- Seu HTML original mantido – loading, auth-screen, main-app, modais, player, etc. -->
    <!-- ... cole todo o seu HTML anterior aqui ... -->

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // =============================================
        // CONFIGURAÇÕES GLOBAIS – ALTERE AQUI
        // =============================================
        const SCRIPT_URL = "https://script.google.com/macros/s/SEU_ID_AQUI/exec";  // ← COLOQUE O URL REAL DO DEPLOY!
        const YT_API_KEY = 'SUA_CHAVE_YOUTUBE_AQUI'; // opcional, se usar fallback

        // Variáveis globais
        let player = null;
        let playlist = [];
        let currentIndex = 0;
        let currentUser = null;
        let currentToken = null;
        let userSaldo = 0;
        let valorizou30s = false;
        let investTrackIndex = null;

        let modalInvest = null;
        let modalCadastro = null;

        // =============================================
        // AUTENTICAÇÃO
        // =============================================
        async function handleLogin() {
            const email = document.getElementById('email')?.value?.trim();
            const pass = document.getElementById('pass')?.value?.trim();

            if (!email || !pass) {
                showToast('Preencha email e senha', 'error');
                return showMessage('login-message', 'Preencha todos os campos', 'error');
            }

            showLoading(true, 'Autenticando...');

            try {
                const url = `${SCRIPT_URL}?acao=login&email=${encodeURIComponent(email)}&pass=${encodeURIComponent(pass)}`;
                const res = await fetch(url);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);

                const data = await res.json();

                if (data.success) {
                    currentUser = data.data;
                    currentToken = data.data.token;

                    localStorage.setItem('miv_token', currentToken);
                    localStorage.setItem('miv_user', JSON.stringify(currentUser));

                    showToast('Login realizado!', 'success');
                    startApp();
                } else {
                    showToast(data.message || 'Credenciais inválidas', 'error');
                    showMessage('login-message', data.message || 'Erro no login', 'error');
                }
            } catch (err) {
                console.error('Login falhou:', err);
                showToast('Erro ao conectar ao servidor', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function handleRegister() {
            const nome    = document.getElementById('reg-nome')?.value?.trim();
            const email   = document.getElementById('reg-email')?.value?.trim();
            const pass    = document.getElementById('reg-pass')?.value?.trim();
            const tipo    = document.getElementById('reg-tipo')?.value;
            const link    = document.getElementById('reg-link')?.value?.trim();

            if (!nome || !email || !pass || !tipo) {
                showToast('Campos obrigatórios faltando', 'error');
                return;
            }

            if (tipo === 'artista' && !link) {
                showToast('Artistas precisam informar link de trabalho', 'error');
                return;
            }

            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                showToast('Email inválido', 'error');
                return;
            }

            if (pass.length < 6) {
                showToast('Senha muito curta (mín. 6 caracteres)', 'error');
                return;
            }

            showLoading(true, 'Criando conta...');

            try {
                const payload = {
                    acao: 'registrar_usuario',
                    nome, email, pass, tipo,
                    workLink: link || ''
                };

                const res = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await res.json();

                if (data.success) {
                    showToast('Conta criada! Aguarde aprovação.', 'success');
                    setTimeout(() => toggleReg(false), 2500);
                } else {
                    showToast(data.message || 'Falha no cadastro', 'error');
                }
            } catch (err) {
                console.error('Register error:', err);
                showToast('Erro de rede/servidor', 'error');
            } finally {
                showLoading(false);
            }
        }

        // =============================================
        // INICIALIZAÇÃO DA APLICAÇÃO
        // =============================================
        function startApp() {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';

            const tipo = (currentUser?.tipo || 'ouvinte').toLowerCase();
            const badge = document.getElementById('badge-tipo');
            badge.textContent = tipo.charAt(0).toUpperCase() + tipo.slice(1);

            if (tipo === 'artista' || tipo === 'admin') {
                document.getElementById('artista-link').style.display = 'block';
                badge.className = 'badge rounded-pill bg-info';
            } else {
                badge.className = 'badge rounded-pill bg-secondary';
            }

            modalInvest = new bootstrap.Modal('#investModal');
            modalCadastro = new bootstrap.Modal('#modalCadastroMusica');

            carregarDadosUsuario();
            carregarMusicas();
            initYouTubePlayer();
        }

        // =============================================
        // CARREGAMENTO DE DADOS
        // =============================================
        async function carregarDadosUsuario() {
            if (!currentToken) return;

            try {
                const [saldoRes, resumoRes, carteiraRes] = await Promise.all([
                    fetch(`${SCRIPT_URL}?acao=get_saldo&token=${currentToken}`),
                    fetch(`${SCRIPT_URL}?acao=get_resumo&token=${currentToken}`),
                    fetch(`${SCRIPT_URL}?acao=get_carteira&token=${currentToken}`)
                ]);

                const saldoData = await saldoRes.json();
                if (saldoData.success) {
                    userSaldo = Number(saldoData.data.saldo || 0);
                    document.getElementById('saldo-display').textContent = `R$ ${userSaldo.toFixed(2)}`;
                }

                const resumoData = await resumoRes.json();
                if (resumoData.success) {
                    document.getElementById('valor-ativos').textContent = `R$ ${Number(resumoData.data.patrimonio || 0).toFixed(2)}`;
                }

                const carteiraData = await carteiraRes.json();
                if (carteiraData.success) {
                    renderizarCarteira(carteiraData.data);
                }

                await carregarExtrato();

                if (['artista', 'admin'].includes(currentUser?.tipo)) {
                    await carregarDadosArtista();
                }
            } catch (err) {
                console.error('Erro ao carregar dados do usuário:', err);
                showToast('Falha ao carregar saldo/carteira', 'error');
            }
        }

        // =============================================
        // INVESTIMENTO e CADASTRO (POST)
        // =============================================
        async function confirmarInvestimento() {
            if (!currentToken || !investTrackIndex) return modalInvest.hide();

            const qtd = Number(document.getElementById('invest-quantidade').value) || 1;
            const track = playlist[investTrackIndex];
            const valorUnit = Number(track.VALOR_ACAO || track.price || 10);
            const total = qtd * valorUnit;

            if (total > userSaldo) {
                showToast('Saldo insuficiente', 'error');
                return;
            }

            showLoading(true, 'Processando investimento...');

            try {
                const payload = {
                    acao: 'investir_musica',
                    token: currentToken,
                    musica_id: track.ID || track.ISRC || track.id,
                    musica_nome: track.TITULO || track.title || 'Música',
                    quantidade: qtd,
                    valor_unitario: valorUnit,
                    valor_total: total
                };

                const res = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await res.json();

                if (data.success) {
                    userSaldo = Number(data.data?.saldo_atual || userSaldo - total);
                    document.getElementById('saldo-display').textContent = `R$ ${userSaldo.toFixed(2)}`;

                    showToast('Investimento concluído!', 'success');
                    modalInvest.hide();
                    carregarDadosUsuario();
                    carregarMusicas(); // atualizar disponibilidade
                } else {
                    showToast(data.message || 'Falha no investimento', 'error');
                }
            } catch (err) {
                showToast('Erro de rede', 'error');
            } finally {
                showLoading(false);
            }
        }

        // ... (o resto do seu script continua similar – carregarMusicas, renderizar*, player, etc.)

        // Inicialização
        document.addEventListener('DOMContentLoaded', () => {
            autoLogin();
            // ... seus outros event listeners ...
        });

        async function autoLogin() {
            const token = localStorage.getItem('miv_token');
            const userStr = localStorage.getItem('miv_user');

            if (token && userStr) {
                currentToken = token;
                currentUser = JSON.parse(userStr);

                try {
                    const res = await fetch(`${SCRIPT_URL}?acao=get_saldo&token=${token}`);
                    const data = await res.json();
                    if (data.success) {
                        startApp();
                    } else {
                        localStorage.clear();
                        showToast('Sessão expirada. Faça login novamente.', 'error');
                    }
                } catch {
                    localStorage.clear();
                }
            }
        }
    </script>
</body>
</html>
