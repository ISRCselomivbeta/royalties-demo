<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Selo MIV - Dashboard Oficial</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700;900&display=swap');
        body { background-color: #020617; color: #f8fafc; font-family: 'Inter', sans-serif; }
        .miv-gradient { background: linear-gradient(135deg, #22c55e 0%, #15803d 100%); }
        .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
        .wallet-card { background: linear-gradient(145deg, #1e293b 0%, #0f172a 100%); border: 1px solid #334155; }
        .btn-miv { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .btn-miv:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(34, 197, 94, 0.4); }
    </style>
</head>
<body class="pb-20">

    <nav class="glass sticky top-0 z-50 p-4">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 miv-gradient rounded-xl flex items-center justify-center font-black italic shadow-lg shadow-green-500/20 text-white">MIV</div>
                <span class="text-xl font-black tracking-tighter uppercase italic">Selo <span class="text-green-500 font-black">MIV</span></span>
            </div>
            
            <div class="flex items-center gap-6">
                <div class="hidden md:block text-right">
                    <p class="text-[10px] text-slate-500 uppercase font-bold tracking-widest leading-none mb-1">Saldo Interno (Ledger)</p>
                    <p id="saldo-global" class="text-green-400 font-black text-lg italic">R$ 0,00</p>
                </div>
                <div class="h-10 w-10 rounded-full border-2 border-green-500 p-0.5">
                    <img src="https://ui-avatars.com/api/?name=User&background=0f172a&color=22c55e" class="rounded-full">
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto p-4 space-y-10">

        <section class="grid grid-cols-1 lg:grid-cols-3 gap-6 pt-6">
            <div class="lg:col-span-2 wallet-card p-8 rounded-3xl relative overflow-hidden group">
                <div class="relative z-10">
                    <h2 class="text-sm font-bold text-green-500 uppercase tracking-widest mb-2 italic">Atenção e Investimento</h2>
                    <h1 class="text-4xl font-black mb-6 italic leading-tight uppercase">Transforme sua<br>Audição em Ativos.</h1>
                    <div class="flex flex-wrap gap-4">
                        <a href="https://link.mercadopago.com.br/selomiv" target="_blank" class="btn-miv bg-white text-black px-8 py-3 rounded-full font-black text-sm flex items-center gap-2">
                            <i class="fas fa-plus-circle"></i> ADICIONAR CRÉDITO
                        </a>
                        <button onclick="verRegras()" class="btn-miv bg-slate-800 text-slate-300 px-8 py-3 rounded-full font-bold text-sm border border-slate-700">
                            REGRAS DO SISTEMA
                        </button>
                    </div>
                </div>
                <i class="fas fa-coins absolute -right-10 -bottom-10 text-[200px] text-white/5 -rotate-12"></i>
            </div>

            <div class="glass p-8 rounded-3xl flex flex-col justify-between border-green-500/20">
                <div>
                    <span class="bg-green-500/10 text-green-500 text-[10px] px-3 py-1 rounded-full font-bold uppercase tracking-tighter">Status: Ouvinte</span>
                    <h3 id="user-nome-card" class="text-2xl font-black mt-4 italic uppercase">Elzo Lima</h3>
                    <p class="text-slate-500 text-xs mt-1">E-mail: elzo.lima.mota@gmail.com</p>
                </div>
                <div class="mt-8 pt-6 border-t border-slate-800">
                    <p class="text-[10px] text-slate-500 uppercase font-bold mb-3">Validação de Artista</p>
                    <button class="w-full py-2 rounded-lg bg-slate-800 text-xs font-bold hover:bg-slate-700 transition">SOLICITAR VERIFICAÇÃO</button>
                </div>
            </div>
        </section>

        <section>
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-2xl font-black italic uppercase tracking-tighter flex items-center gap-3">
                    <i class="fas fa-bolt text-green-500"></i> Marketplace de Royalties
                </h2>
                <span class="text-[10px] text-slate-500 uppercase font-bold">Totalmente Auditado</span>
            </div>

            <div id="lista-musicas" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                </div>
        </section>
    </main>

    <div id="player-miv" class="fixed bottom-0 left-0 right-0 glass border-t border-slate-800 p-4 translate-y-full transition-transform duration-500 z-[100]">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div id="player-capa" class="w-14 h-14 rounded-xl bg-slate-800 bg-cover bg-center shadow-lg border border-white/10"></div>
                <div>
                    <h4 id="player-titulo" class="font-black text-sm italic uppercase tracking-tighter">Nenhuma Música</h4>
                    <p class="text-[10px] text-green-500 font-bold uppercase tracking-widest animate-pulse">Sincronizando com o Ledger...</p>
                </div>
            </div>
            
            <div class="flex-1 max-w-xl mx-10">
                <div class="h-1.5 bg-slate-900 rounded-full overflow-hidden border border-white/5">
                    <div id="player-progress" class="h-full miv-gradient transition-all duration-1000 shadow-[0_0_15px_rgba(34,197,94,0.5)]" style="width: 0%"></div>
                </div>
                <div class="flex justify-between mt-2">
                    <span class="text-[8px] text-slate-500 font-bold uppercase tracking-widest italic">Validação de Atenção Requerida</span>
                    <span id="player-timer" class="text-[10px] text-green-500 font-black italic italic">0%</span>
                </div>
            </div>

            <button onclick="cancelarSessao()" class="w-10 h-10 rounded-full bg-slate-800 text-slate-500 hover:text-white transition">
                <i class="fas fa-times text-xs"></i>
            </button>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyTDfv9m7yRwJauGdPnvtbpMq9KTq9lmf8XWVKe9NT4OoaHTBPY2eamuHMfo1OJxSE-/exec";
        
        // Simulação de Usuário conforme sua aba "Usuarios"
        const USER_SESSION = { id: "U1769060182614", nome: "Elzo Lima Mota" };

        async function init() {
            document.getElementById('user-nome-card').innerText = USER_SESSION.nome;
            await carregarMercado();
        }

        async function carregarMercado() {
            const container = document.getElementById('lista-musicas');
            container.innerHTML = "<p class='col-span-full text-center py-20 text-slate-500 animate-pulse uppercase text-xs font-bold tracking-widest'>Acessando Ledger Contábil...</p>";

            try {
                const response = await fetch(`${SCRIPT_URL}?acao=listar_mercado`);
                const musicas = await response.json();
                
                container.innerHTML = "";
                musicas.forEach(m => {
                    const valorAcao = parseFloat(m['VALOR AÇÃO'] || 10).toFixed(2);
                    container.innerHTML += `
                        <div class="glass p-5 rounded-3xl border border-slate-800 hover:border-green-500/50 transition-all duration-500 group shadow-lg">
                            <div class="relative overflow-hidden rounded-2xl mb-5 aspect-square">
                                <img src="${m.LINK_CAPA || 'https://via.placeholder.com/300'}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700">
                                <div class="absolute inset-0 bg-gradient-to-t from-slate-900 via-transparent to-transparent opacity-60"></div>
                                <span class="absolute top-3 left-3 bg-black/60 backdrop-blur-md text-white text-[8px] font-black px-2 py-1 rounded uppercase tracking-widest border border-white/10 italic">
                                    ${m.GÊNERO || 'POP'}
                                </span>
                            </div>
                            
                            <h3 class="font-black text-xl italic uppercase tracking-tighter truncate leading-none mb-1">${m.TITULO || m.NOME}</h3>
                            <p class="text-[9px] text-slate-500 font-bold uppercase tracking-widest mb-6">ISRC: ${m.ISRC}</p>
                            
                            <div class="flex items-end justify-between border-t border-slate-800/50 pt-5">
                                <div>
                                    <p class="text-[8px] text-slate-500 font-bold uppercase tracking-widest mb-1 italic">Preço Cota</p>
                                    <p class="text-green-400 font-black text-lg italic tracking-tight leading-none">R$ ${valorAcao}</p>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="ativarMineracao('${m.ID}', '${m.TITULO || m.NOME}', '${m.LINK_CAPA}')" class="w-10 h-10 rounded-full bg-white text-black flex items-center justify-center hover:bg-green-500 hover:text-white transition shadow-xl">
                                        <i class="fas fa-play text-xs"></i>
                                    </button>
                                    <button onclick="investir('${m.ID}')" class="bg-slate-800 hover:bg-green-600 px-4 py-2 rounded-xl text-[10px] font-black italic transition uppercase tracking-tighter border border-slate-700">Investir</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
            } catch (error) {
                container.innerHTML = "<p class='text-red-500 font-bold text-center col-span-full'>Erro na conexão com o Ledger.</p>";
            }
        }

        // LÓGICA DE GANHO POR AUDIÇÃO (MINERAÇÃO)
        let sessaoAtiva = false;
        let progresso = 0;
        let timerInterval;

        function ativarMineracao(id, titulo, capa) {
            if(sessaoAtiva) return alert("Finalize a sessão anterior para iniciar uma nova.");
            
            const player = document.getElementById('player-miv');
            player.style.transform = "translateY(0)";
            document.getElementById('player-titulo').innerText = titulo;
            document.getElementById('player-capa').style.backgroundImage = `url('${capa || ''}')`;
            
            sessaoAtiva = true;
            progresso = 0;
            
            timerInterval = setInterval(async () => {
                progresso += 5; // Simula 20 segundos de escuta
                document.getElementById('player-progress').style.width = progresso + "%";
                document.getElementById('player-timer').innerText = progresso + "%";
                
                if(progresso >= 100) {
                    clearInterval(timerInterval);
                    await confirmarNoBackend(id);
                    fecharPlayerVisual();
                }
            }, 1000);
        }

        async function confirmarNoBackend(musicaId) {
            // Regra 1 e 4: Frontend apenas envia o comando
            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({
                        acao: 'registrar_play',
                        ouvinteId: USER_SESSION.id,
                        musicaId: musicaId
                    })
                });
                alert("Crédito Auditado! Royalty inserido com sucesso em sua carteira.");
            } catch (e) {
                console.error("Erro no registro contábil.");
            }
        }

        function fecharPlayerVisual() {
            document.getElementById('player-miv').style.transform = "translateY(100%)";
            sessaoAtiva = false;
        }

        function cancelarSessao() {
            if(confirm("Deseja interromper a mineração? Você não ganhará o crédito.")) {
                clearInterval(timerInterval);
                fecharPlayerVisual();
            }
        }

        function verRegras() {
            alert("Regras MIV:\n1. Saldo interno é crédito via Ledger.\n2. Retiradas sujeitas a comissão.\n3. Ganhos por play requerem 20s de atenção.");
        }

        function investir(id) {
            window.open("https://link.mercadopago.com.br/selomiv", "_blank");
        }

        window.onload = init;
    </script>
</body>
</html>
