const SPREADSHEET_ID = '1NOc5RHVoWdfdMDur55C5R25FAsAcqQtk5PHVmFlViV0';
const PLAYLIST_URL = 'https://www.youtube.com/watch?v=sNRWCkk1o9w&list=PLvteL0_9cu8oE_N4Qfz5JJucTTkY2czcN';

function doGet(e) { return processarRequisicao(e); }
function doPost(e) { return processarRequisicao(e); }

function processarRequisicao(e) {
  const p = e.parameter;
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  
  try {
    // --- LOGIN COM TRAVA DE STATUS ---
    if (p.acao === 'login') {
      const aba = ss.getSheetByName('Usuarios');
      const dados = aba.getDataRange().getValues();
      for (let i = 1; i < dados.length; i++) {
        if (String(dados[i][1]).toLowerCase() === String(p.usuario).toLowerCase() && String(dados[i][2]) === String(p.senha)) {
          if (dados[i][9] !== "ATIVO") { // Coluna J (Status)
             return gerarSaida({ success: false, msg: "Por favor, ative seu e-mail primeiro." });
          }
          return gerarSaida({ 
            success: true, 
            id: dados[i][0], 
            nome: dados[i][4], 
            tipo: dados[i][3],
            saldo: somarSaldo(ss, dados[i][0])
          });
        }
      }
      return gerarSaida({ success: false, msg: "Usuário ou senha incorretos." });
    }

    // --- CADASTRO COM ENVIO DE E-MAIL ---
    if (p.acao === 'cadastro') {
      const aba = ss.getSheetByName('Usuarios');
      const id = (p.tipo === 'artista' ? "ART" : "U") + Date.now();
      aba.appendRow([id, p.email, p.senha, p.tipo, p.nome, new Date(), "", "", "", "PENDENTE"]);

      const linkAtivacao = p.url_base + "?acao=confirmar&id=" + id;
      MailApp.sendEmail({
        to: p.email,
        subject: "Ative sua conta - MIV PRO",
        htmlBody: `<h2>Bem-vindo, ${p.nome}!</h2><p>Clique no botão para ativar seu acesso:</p>
                   <a href="${linkAtivacao}" style="background:#00ff88; color:black; padding:12px 20px; text-decoration:none; border-radius:8px; font-weight:bold;">ATIVAR AGORA</a>`
      });
      return gerarSaida({ success: true });
    }

    // --- CONFIRMAR E-MAIL ---
    if (p.acao === 'confirmar') {
      const aba = ss.getSheetByName('Usuarios');
      const dados = aba.getDataRange().getValues();
      for (let i = 1; i < dados.length; i++) {
        if (dados[i][0] === p.id) {
          aba.getRange(i + 1, 10).setValue("ATIVO");
          return ContentService.createTextOutput("<h1>MIV PRO: Conta Ativada!</h1><p>Pode fechar e fazer login.</p>").setMimeType(ContentService.MimeType.TEXT_HTML);
        }
      }
    }

    // --- LISTAR MERCADO (DA PLAYLIST) ---
    if (p.acao === 'listar_mercado') {
      const abaMus = ss.getSheetByName('MÚSICAS');
      const dados = abaMus.getDataRange().getValues();
      let lista = [];
      for (let i = 1; i < dados.length; i++) {
        if(dados[i][7] === "ATIVO") {
          lista.push({ id: dados[i][0], titulo: dados[i][4], artista: dados[i][9], valor: dados[i][13] || 10 });
        }
      }
      return gerarSaida({ success: true, musicas: lista });
    }

  } catch (e) { return gerarSaida({ success: false, error: e.toString() }); }
}

function gerarSaida(obj) {
  return ContentService.createTextOutput(JSON.stringify(obj)).setMimeType(ContentService.MimeType.JSON);
}

function somarSaldo(ss, userId) {
  const aba = ss.getSheetByName('SALDOS');
  const dados = aba.getDataRange().getValues();
  let total = 0;
  for (let i = 1; i < dados.length; i++) {
    if (String(dados[i][1]) === String(userId)) total += parseFloat(dados[i][3] || 0);
  }
  return total;
}
