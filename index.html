<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="SELO MIV - Plataforma de Investimento em M√∫sica">
  <meta name="theme-color" content="#00ff88">
  <title>SELO MIV | Fintech Musical</title>

  <!-- Bootstrap 5.3.0 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --neon-green: #00ff88;
      --miv-blue: #0072ff;
      --bg-dark: #07090c;
      --bg-card: #111418;
      --border: #1e2329;
      --text-light: #f8f9fa;
      --text-muted: #6c757d;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Outfit', sans-serif;
      background-color: var(--bg-dark);
      color: var(--text-light);
      min-height: 100vh;
      overflow-x: hidden;
    }
    .loading-screen {
      position: fixed;
      inset: 0;
      background: var(--bg-dark);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.3s ease;
    }
    .loading-content {
      text-align: center;
    }
    .loading-spinner {
      width: 4rem;
      height: 4rem;
      border: 0.25rem solid rgba(0, 255, 136, 0.3);
      border-top-color: var(--neon-green);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1.5rem;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .auth-screen {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, var(--bg-dark) 0%, #0c0e12 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      z-index: 9998;
      overflow-y: auto;
    }
    .auth-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 1.5rem;
      padding: 2.5rem;
      width: 100%;
      max-width: 420px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
      transform: translateY(0);
      transition: transform 0.3s ease;
    }
    .auth-card:hover {
      transform: translateY(-5px);
    }
    .logo-header {
      text-align: center;
      margin-bottom: 2.5rem;
    }
    .logo-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 80px;
      height: 80px;
      background: rgba(0, 255, 136, 0.1);
      border-radius: 50%;
      margin-bottom: 1.5rem;
      border: 2px solid var(--neon-green);
    }
    .logo-icon i {
      font-size: 2.5rem;
      color: var(--neon-green);
    }
    .form-group {
      margin-bottom: 1.25rem;
    }
    .form-control-custom {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border);
      border-radius: 0.75rem;
      color: var(--text-light);
      padding: 0.875rem 1rem;
      font-size: 1rem;
      transition: all 0.3s ease;
    }
    .form-control-custom:focus {
      background: rgba(255, 255, 255, 0.08);
      border-color: var(--neon-green);
      color: var(--text-light);
      box-shadow: 0 0 0 0.25rem rgba(0, 255, 136, 0.25);
    }
    .form-control-custom::placeholder {
      color: var(--text-muted);
    }
    .btn-miv {
      background: linear-gradient(135deg, var(--neon-green) 0%, #00cc6a 100%);
      border: none;
      border-radius: 0.75rem;
      color: #000;
      font-weight: 700;
      padding: 1rem 1.5rem;
      font-size: 1rem;
      transition: all 0.3s ease;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      width: 100%;
    }
    .btn-miv:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(0, 255, 136, 0.3);
    }
    .btn-miv:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    .auth-link {
      color: var(--neon-green);
      text-decoration: none;
      font-weight: 600;
      transition: opacity 0.3s ease;
    }
    .auth-link:hover {
      opacity: 0.8;
      text-decoration: underline;
    }
    .main-app {
      display: none;
      min-height: 100vh;
      padding-bottom: 5rem;
    }
    .app-header {
      background: linear-gradient(180deg, rgba(0, 255, 136, 0.1) 0%, rgba(7, 9, 12, 0.8) 100%);
      backdrop-filter: blur(10px);
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    .header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .saldo-display h6 {
      color: var(--text-muted);
      font-size: 0.75rem;
      margin-bottom: 0.25rem;
    }
    .saldo-display h4 {
      color: var(--neon-green);
      font-weight: 700;
      margin-bottom: 0;
    }
    .user-badge {
      background: var(--neon-green);
      color: #000;
      padding: 0.25rem 0.75rem;
      border-radius: 1rem;
      font-size: 0.75rem;
      font-weight: 700;
    }
    .sidebar {
      position: fixed;
      top: 0;
      left: -300px;
      width: 300px;
      height: 100vh;
      background: #000;
      border-right: 1px solid var(--border);
      z-index: 1100;
      transition: left 0.3s ease;
      overflow-y: auto;
      padding: 1.5rem;
    }
    .sidebar.open {
      left: 0;
    }
    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border);
    }
    .sidebar-close {
      background: none;
      border: none;
      color: var(--text-light);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0.25rem;
    }
    .nav-menu {
      list-style: none;
      padding: 0;
    }
    .nav-item {
      margin-bottom: 0.5rem;
    }
    .nav-link {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.875rem 1rem;
      color: var(--text-muted);
      text-decoration: none;
      border-radius: 0.75rem;
      transition: all 0.3s ease;
    }
    .nav-link:hover, .nav-link.active {
      background: rgba(0, 255, 136, 0.1);
      color: var(--neon-green);
    }
    .nav-link i {
      font-size: 1.25rem;
    }
    .section {
      display: none;
      padding: 1.5rem;
      animation: fadeIn 0.3s ease;
    }
    .section.active {
      display: block;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    .section-title {
      color: var(--text-light);
      font-weight: 700;
      margin-bottom: 0;
    }
    .music-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    .music-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 1rem;
      overflow: hidden;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    .music-card:hover {
      transform: translateY(-5px);
      border-color: var(--neon-green);
      box-shadow: 0 10px 20px rgba(0, 255, 136, 0.1);
    }
    .music-cover {
      width: 100%;
      height: 180px;
      object-fit: cover;
    }
    .music-info {
      padding: 1rem;
    }
    .music-title {
      font-weight: 600;
      margin-bottom: 0.25rem;
      color: var(--text-light);
    }
    .music-artist {
      color: var(--text-muted);
      font-size: 0.875rem;
      margin-bottom: 0.75rem;
    }
    .music-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    .music-price {
      color: var(--neon-green);
      font-weight: 700;
      font-size: 1.125rem;
    }
    .music-percent {
      background: rgba(0, 123, 255, 0.1);
      color: #007bff;
      padding: 0.25rem 0.75rem;
      border-radius: 1rem;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .player-bar {
      position: fixed;
      bottom: 5rem;
      left: 0;
      right: 0;
      background: var(--bg-card);
      border-top: 1px solid var(--border);
      padding: 1rem;
      z-index: 1000;
      transition: all 0.3s ease;
      display: none;
    }
    .player-bar.expanded {
      bottom: 0;
      height: 100vh;
      background: rgba(17, 20, 24, 0.98);
      backdrop-filter: blur(20px);
    }
    .player-content {
      max-width: 1200px;
      margin: 0 auto;
    }
    .video-container {
      width: 100%;
      aspect-ratio: 16/9;
      background: #000;
      border-radius: 1rem;
      overflow: hidden;
      margin-bottom: 1.5rem;
      display: none;
    }
    .player-bar.expanded .video-container {
      display: block;
    }
    .player-info {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    .player-album-art {
      width: 60px;
      height: 60px;
      border-radius: 0.75rem;
      object-fit: cover;
    }
    .player-text {
      flex: 1;
    }
    .player-title {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    .player-artist {
      color: var(--text-muted);
      font-size: 0.875rem;
    }
    .player-price {
      color: var(--neon-green);
      font-weight: 700;
    }
    .progress-container {
      height: 6px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
      margin: 1rem 0;
      cursor: pointer;
    }
    .progress-bar {
      height: 100%;
      background: var(--neon-green);
      border-radius: 3px;
      width: 0%;
      transition: width 0.3s ease;
    }
    .player-controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 2rem;
      margin-top: 1rem;
    }
    .control-btn {
      background: none;
      border: none;
      color: var(--text-light);
      font-size: 1.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
      padding: 0.5rem;
    }
    .control-btn:hover {
      color: var(--neon-green);
      transform: scale(1.1);
    }
    .play-btn {
      font-size: 2.5rem;
    }
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #000;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: space-around;
      padding: 0.75rem 0;
      z-index: 1001;
    }
    .nav-btn {
      background: none;
      border: none;
      color: var(--text-muted);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.25rem;
      padding: 0.5rem;
      cursor: pointer;
      transition: color 0.3s ease;
      flex: 1;
    }
    .nav-btn:hover, .nav-btn.active {
      color: var(--neon-green);
    }
    .nav-btn i {
      font-size: 1.25rem;
    }
    .nav-btn span {
      font-size: 0.75rem;
    }
    .portfolio-summary {
      background: linear-gradient(135deg, rgba(0, 255, 136, 0.1) 0%, rgba(0, 123, 255, 0.1) 100%);
      border: 1px solid var(--border);
      border-radius: 1rem;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      text-align: center;
    }
    .portfolio-value {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--neon-green);
      margin: 0.5rem 0;
    }
    .ledger-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    .ledger-table th {
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-muted);
      font-weight: 600;
      text-align: left;
      padding: 1rem;
      border-bottom: 1px solid var(--border);
    }
    .ledger-table td {
      padding: 1rem;
      border-bottom: 1px solid var(--border);
    }
    .ledger-table tr:hover {
      background: rgba(255, 255, 255, 0.02);
    }
    .artist-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 1rem;
      padding: 1.5rem;
      text-align: center;
    }
    .stat-icon {
      font-size: 2rem;
      color: var(--neon-green);
      margin-bottom: 1rem;
    }
    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--text-light);
      margin: 0.5rem 0;
    }
    .stat-label {
      color: var(--text-muted);
      font-size: 0.875rem;
    }
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1200;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    .modal-overlay.show {
      opacity: 1;
      visibility: visible;
    }
    .modal-content {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 1rem;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      transform: translateY(20px);
      transition: transform 0.3s ease;
    }
    .modal-overlay.show .modal-content {
      transform: translateY(0);
    }
    .modal-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-title {
      color: var(--text-light);
      font-weight: 700;
      margin-bottom: 0;
    }
    .modal-close {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0.25rem;
    }
    .modal-body {
      padding: 1.5rem;
    }
    .modal-footer {
      padding: 1.5rem;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 1rem;
    }
    .toast-container {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 1300;
      max-width: 350px;
    }
    .toast {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 0.75rem;
      padding: 1rem;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      transform: translateX(100%);
      opacity: 0;
      transition: all 0.3s ease;
    }
    .toast.show {
      transform: translateX(0);
      opacity: 1;
    }
    .toast.success {
      border-color: var(--neon-green);
      background: rgba(0, 255, 136, 0.1);
    }
    .toast.error {
      border-color: #ff3232;
      background: rgba(255, 50, 50, 0.1);
    }
    .toast-icon {
      font-size: 1.25rem;
    }
    .toast.success .toast-icon {
      color: var(--neon-green);
    }
    .toast.error .toast-icon {
      color: #ff3232;
    }
    .toast-message {
      flex: 1;
      color: var(--text-light);
    }
    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: var(--text-muted);
    }
    .empty-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }
    @media (max-width: 768px) {
      .auth-card { padding: 1.5rem; }
      .music-grid { grid-template-columns: 1fr; }
      .artist-stats { grid-template-columns: 1fr; }
      .section { padding: 1rem; }
    }
    .music-card {
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .music-card:hover {
      transform: scale(1.02);
      box-shadow: 0 0 15px rgba(0, 255, 136, 0.3);
    }
    .btn-miv {
      transition: background 0.3s ease;
    }
    .btn-miv:active {
      background: linear-gradient(135deg, #00cc6a 0%, var(--neon-green) 100%);
    }
    .music-percent {
      position: relative;
    }
    .music-percent::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-dark);
      color: var(--text-light);
      padding: 0.25rem 0.5rem;
      border-radius: 0.5rem;
      white-space: nowrap;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
    }
    .music-percent:hover::after {
      opacity: 1;
    }
    .player-bar.expanded {
      backdrop-filter: blur(15px);
      background: rgba(7,9,12,0.95);
    }
    .progress-bar {
      background: linear-gradient(to right, var(--neon-green) 0%, #00cc6a 100%);
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
  </style>
</head>
<body>

<!-- Loading Screen -->
<div id="loadingScreen" class="loading-screen">
  <div class="loading-content">
    <div class="loading-spinner"></div>
    <h4 class="text-success mb-2">Conectando ao SELO MIV</h4>
    <p class="text-muted" id="loadingMessage">Autenticando...</p>
  </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- Authentication Screen -->
<div id="authScreen" class="auth-screen">
  <div class="auth-card">
    <div class="logo-header">
      <div class="logo-icon">
        <i class="bi bi-shield-lock"></i>
      </div>
      <h2 class="text-white mb-2">SELO MIV</h2>
      <p class="text-muted">Plataforma de Investimento em M√∫sica</p>
    </div>

    <!-- Login Form -->
    <div id="loginForm">
      <div id="loginMessage" class="alert d-none"></div>
      <div class="form-group">
        <input type="email" id="loginEmail" class="form-control-custom" placeholder="E-mail" required>
      </div>
      <div class="form-group">
        <input type="password" id="loginPassword" class="form-control-custom" placeholder="Senha" required>
      </div>
      <button class="btn-miv mb-3" onclick="handleLogin()">
        <i class="bi bi-box-arrow-in-right"></i> Entrar
      </button>
      <p class="text-center text-muted">
        Novo por aqui? <a href="javascript:void(0)" class="auth-link" onclick="showRegisterForm()">Criar conta</a>
      </p>
      <div class="text-center mt-3">
        <small class="text-muted">
          <i class="bi bi-info-circle me-1"></i> Use: admin@miv.com / admin123
        </small>
      </div>
    </div>

    <!-- Register Form -->
    <div id="registerForm" style="display: none;">
      <div id="registerMessage" class="alert d-none"></div>
      <div class="form-group">
        <input type="text" id="registerName" class="form-control-custom" placeholder="Nome completo" required>
      </div>
      <div class="form-group">
        <input type="email" id="registerEmail" class="form-control-custom" placeholder="E-mail" required>
      </div>
      <div class="form-group">
        <input type="password" id="registerPassword" class="form-control-custom" placeholder="Senha (m√≠nimo 6 caracteres)" required minlength="6">
      </div>
      <div class="form-group">
        <select id="registerType" class="form-control-custom" onchange="toggleArtistField()">
          <option value="">Selecione seu perfil...</option>
          <option value="ouvinte">üéß Ouvinte/Investidor</option>
          <option value="artista">üé§ Artista</option>
        </select>
      </div>
      <div class="form-group" id="artistLinkField" style="display: none;">
        <input type="url" id="registerLink" class="form-control-custom" placeholder="Link do seu trabalho (YouTube, Spotify, etc.)">
        <small class="text-muted">Para artistas: informe um link do seu portf√≥lio</small>
      </div>
      <button class="btn-miv mb-3" onclick="handleRegister()">
        <i class="bi bi-person-plus"></i> Solicitar Cadastro
      </button>
      <p class="text-center text-muted">
        J√° tem conta? <a href="javascript:void(0)" class="auth-link" onclick="showLoginForm()">Fazer login</a>
      </p>
    </div>
  </div>
</div>

<!-- Main Application -->
<div id="mainApp" class="main-app">
  <!-- Sidebar -->
  <div id="sidebar" class="sidebar">
    <div class="sidebar-header">
      <h4 class="text-white mb-0">üéµ MIV PRO</h4>
      <button class="sidebar-close" onclick="toggleSidebar()">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
    <ul class="nav-menu">
      <li class="nav-item">
        <a href="#" class="nav-link active" onclick="changeSection('marketplace')">
          <i class="bi bi-house"></i> <span>Marketplace</span>
        </a>
      </li>
      <li class="nav-item">
        <a href="#" class="nav-link" onclick="changeSection('portfolio')">
          <i class="bi bi-briefcase"></i> <span>Portf√≥lio</span>
        </a>
      </li>
      <li class="nav-item">
        <a href="#" class="nav-link" onclick="changeSection('ledger')">
          <i class="bi bi-receipt"></i> <span>Extrato</span>
        </a>
      </li>
      <li class="nav-item" id="artistNavItem" style="display: none;">
        <a href="#" class="nav-link" onclick="changeSection('artist')">
          <i class="bi bi-mic"></i> <span>Painel Artista</span>
        </a>
      </li>
      <li class="nav-item">
        <a href="https://link.mercadopago.com.br/selomiv" target="_blank" class="nav-link">
          <i class="bi bi-plus-circle text-success"></i> <span class="text-success">Adicionar Saldo</span>
        </a>
      </li>
      <li class="nav-item">
        <a href="#" class="nav-link text-danger" onclick="logout()">
          <i class="bi bi-box-arrow-right"></i> <span>Sair</span>
        </a>
      </li>
    </ul>
  </div>

  <!-- Main Header -->
  <header class="app-header">
    <div class="header-content">
      <div class="d-flex align-items-center">
        <button class="btn text-white me-3" onclick="toggleSidebar()">
          <i class="bi bi-list fs-3"></i>
        </button>
        <div class="saldo-display">
          <h6>CR√âDITO DISPON√çVEL</h6>
          <h4 id="currentBalance">R$ 0,00</h4>
        </div>
      </div>
      <div class="user-badge" id="userBadge">Ouvinte</div>
    </div>
  </header>

  <!-- Main Content -->
  <main>
    <!-- Marketplace Section -->
    <section id="marketplaceSection" class="section active">
      <div class="section-header">
        <h2 class="section-title">üéµ Marketplace</h2>
        <div>
          <small class="text-muted">Taxa 0% em compras</small>
        </div>
      </div>
      <div id="marketplaceContent" class="music-grid">
        <!-- Music cards will be loaded here -->
      </div>
    </section>

    <!-- Portfolio Section -->
    <section id="portfolioSection" class="section">
      <div class="portfolio-summary">
        <h6 class="text-muted">VALOR TOTAL DA CARTEIRA</h6>
        <div class="portfolio-value" id="portfolioValue">R$ 0,00</div>
        <small class="text-muted">Atualizado em tempo real</small>
      </div>
      <div class="section-header">
        <h2 class="section-title">üìä Meus Ativos</h2>
        <span class="badge bg-secondary" id="assetsCount">0 ativos</span>
      </div>
      <div id="portfolioContent">
        <!-- Portfolio assets will be loaded here -->
      </div>
    </section>

    <!-- Ledger Section -->
    <section id="ledgerSection" class="section">
      <div class="section-header">
        <h2 class="section-title">üìã Hist√≥rico de Transa√ß√µes</h2>
        <button class="btn btn-sm btn-outline-success" onclick="loadLedger()">
          <i class="bi bi-arrow-clockwise"></i> Atualizar
        </button>
      </div>
      <div class="table-responsive">
        <table class="ledger-table">
          <thead>
            <tr>
              <th>Data</th>
              <th>Descri√ß√£o</th>
              <th class="text-end">Valor</th>
            </tr>
          </thead>
          <tbody id="ledgerContent">
            <tr>
              <td colspan="3" class="text-center text-muted py-4">
                <i class="bi bi-receipt fs-4 d-block mb-2"></i>
                Nenhuma transa√ß√£o encontrada
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Artist Panel Section -->
    <section id="artistSection" class="section">
      <div class="section-header">
        <h2 class="section-title">üé§ Painel Artista</h2>
        <button class="btn-miv btn-sm" onclick="openAddMusicModal()">
          <i class="bi bi-plus-circle"></i> Nova M√∫sica
        </button>
      </div>
      <div class="artist-stats">
        <div class="stat-card">
          <div class="stat-icon">
            <i class="bi bi-music-note-beamed"></i>
          </div>
          <div class="stat-value" id="artistMusicCount">0</div>
          <div class="stat-label">M√∫sicas Cadastradas</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">
            <i class="bi bi-cash-coin"></i>
          </div>
          <div class="stat-value" id="artistRoyalties">R$ 0,00</div>
          <div class="stat-label">Royalties Acumulados</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">
            <i class="bi bi-bar-chart"></i>
          </div>
          <div class="stat-value" id="artistSharesSold">0</div>
          <div class="stat-label">A√ß√µes Vendidas</div>
        </div>
      </div>
      <h5 class="mb-3">Minhas M√∫sicas</h5>
      <div id="artistMusicContent" class="music-grid">
        <!-- Artist's music will be loaded here -->
      </div>
    </section>
  </main>

  <!-- Music Player -->
  <div id="playerBar" class="player-bar">
    <div class="player-content">
      <div class="video-container" id="videoContainer">
        <div id="youtubePlayer"></div>
      </div>
      <div class="player-info" onclick="togglePlayerExpansion()">
        <img src="https://via.placeholder.com/60x60/111418/00ff88?text=MIV" class="player-album-art" alt="Album Art" id="playerAlbumArt">
        <div class="player-text">
          <div class="player-title" id="playerTitle">T√≠tulo da M√∫sica</div>
          <div class="player-artist" id="playerArtist">Artista</div>
          <div class="player-price" id="playerPrice">R$ 0,00 por a√ß√£o</div>
        </div>
        <button class="btn-miv btn-sm" onclick="event.stopPropagation(); openInvestModal(state.currentTrackIndex)">
          <i class="bi bi-currency-dollar"></i> Investir
        </button>
      </div>
      <div class="progress-container" onclick="seekMusic(event)">
        <div class="progress-bar" id="musicProgress"></div>
      </div>
      <div class="player-time d-flex justify-content-between mt-1 small">
        <span id="currentTime">0:00</span>
        <span id="durationTime">0:00</span>
      </div>
      <div class="player-controls mt-2 d-flex justify-content-center gap-3">
        <button class="control-btn" onclick="toggleShuffle()">
          <i class="bi bi-shuffle" id="shuffleIcon"></i>
        </button>
        <button class="control-btn" onclick="playPrevious()">
          <i class="bi bi-skip-start-fill"></i>
        </button>
        <button class="control-btn play-btn fs-1" id="playButton" onclick="togglePlay()">
          <i class="bi bi-play-circle-fill"></i>
        </button>
        <button class="control-btn" onclick="playNext()">
          <i class="bi bi-skip-end-fill"></i>
        </button>
        <button class="control-btn" onclick="toggleRepeat()">
          <i class="bi bi-repeat" id="repeatIcon"></i>
        </button>
        <input type="range" id="volumeSlider" min="0" max="100" value="100" class="ms-3" oninput="setVolume(this.value)" style="width: 120px;">
      </div>
      <div id="queueContainer" class="mt-3" style="display:none; max-height: 40vh; overflow-y: auto;">
        <h6 class="text-center mb-2">Fila de reprodu√ß√£o</h6>
        <ul id="queueList" class="list-group list-group-flush"></ul>
      </div>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav">
    <button class="nav-btn active" onclick="changeSection('marketplace', this)">
      <i class="bi bi-house"></i> <span>Market</span>
    </button>
    <button class="nav-btn" onclick="changeSection('portfolio', this)">
      <i class="bi bi-briefcase"></i> <span>Carteira</span>
    </button>
    <button class="nav-btn" onclick="changeSection('ledger', this)">
      <i class="bi bi-receipt"></i> <span>Extrato</span>
    </button>
  </nav>
</div>

<!-- Modais -->
<div id="investModal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title"><i class="bi bi-currency-dollar me-2"></i> Investir em M√∫sica</h5>
      <button class="modal-close" onclick="closeModal('investModal')">
        <i class="bi bi-x"></i>
      </button>
    </div>
    <div class="modal-body">
      <h6 id="investTrackTitle" class="mb-2">T√≠tulo da M√∫sica</h6>
      <p class="text-muted mb-4" id="investTrackArtist">Artista</p>
      <div class="form-group">
        <label class="text-muted mb-2 d-block">Quantidade de A√ß√µes</label>
        <input type="number" id="investQuantity" class="form-control-custom" value="1" min="1" step="1" oninput="updateInvestmentTotal()">
      </div>
      <div class="d-flex justify-content-between mb-3">
        <span class="text-muted">Valor por a√ß√£o:</span>
        <span class="text-success fw-bold" id="investUnitPrice">R$ 0,00</span>
      </div>
      <div class="d-flex justify-content-between mb-4">
        <span class="text-muted">Valor total:</span>
        <span class="text-success fw-bold fs-4" id="investTotalPrice">R$ 0,00</span>
      </div>
      <div class="alert alert-info bg-dark border-info mb-3">
        <i class="bi bi-info-circle me-2"></i> Cada a√ß√£o representa 0.01% de participa√ß√£o nos royalties
      </div>
      <div class="alert alert-warning bg-dark border-warning">
        <i class="bi bi-exclamation-triangle me-2"></i> Saldo dispon√≠vel: <span id="investAvailableBalance" class="fw-bold">R$ 0,00</span>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('investModal')">Cancelar</button>
      <button class="btn-miv" id="confirmInvestBtn" onclick="confirmInvestment()">Confirmar Investimento</button>
    </div>
  </div>
</div>

<div id="addMusicModal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title"><i class="bi bi-music-note-beamed me-2"></i> Cadastrar Nova M√∫sica</h5>
      <button class="modal-close" onclick="closeModal('addMusicModal')">
        <i class="bi bi-x"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="text-muted mb-2 d-block">T√≠tulo da M√∫sica *</label>
        <input type="text" id="musicTitle" class="form-control-custom" placeholder="Digite o t√≠tulo da m√∫sica" required>
      </div>
      <div class="form-group">
        <label class="text-muted mb-2 d-block">G√™nero Musical *</label>
        <select id="musicGenre" class="form-control-custom" required>
          <option value="">Selecione um g√™nero</option>
          <option value="POP">üéµ POP</option>
          <option value="HIPHOP_RAP">üé§ HIP HOP / RAP</option>
          <option value="ROCK">ü§ò ROCK</option>
          <option value="ELETRONICA">‚ö° ELETR√îNICA</option>
          <option value="MPB">üé∏ MPB</option>
          <option value="SERTANEJO">üé∂ SERTANEJO</option>
          <option value="FUNK">üíÉ FUNK</option>
          <option value="OUTRO">üéº OUTRO</option>
        </select>
      </div>
      <div class="form-group">
        <label class="text-muted mb-2 d-block">Link do YouTube *</label>
        <input type="url" id="musicYoutube" class="form-control-custom" placeholder="https://youtube.com/watch?v=..." required>
      </div>
      <div class="form-group">
        <label class="text-muted mb-2 d-block">Link da Capa (opcional)</label>
        <input type="url" id="musicCover" class="form-control-custom" placeholder="https://exemplo.com/capa.jpg">
      </div>
      <div class="form-group">
        <label class="text-muted mb-2 d-block">Valor por A√ß√£o *</label>
        <input type="number" id="musicPrice" class="form-control-custom" value="10.00" min="1" step="0.01" required>
      </div>
      <div class="form-group">
        <label class="text-muted mb-2 d-block">Percentual Dispon√≠vel *</label>
        <div class="input-group">
          <input type="number" id="musicPercent" class="form-control-custom" value="20" min="1" max="100" required>
          <span class="input-group-text bg-dark text-white border-secondary">%</span>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('addMusicModal')">Cancelar</button>
      <button class="btn-miv" onclick="registerMusic()">
        <i class="bi bi-save me-2"></i> Cadastrar M√∫sica
      </button>
    </div>
  </div>
</div>

<!-- JavaScript -->
<script>
// ========== CONFIGURA√á√ÉO ==========
const CONFIG = {
  // SUA URL DO GOOGLE APPS SCRIPT
  API_URL: 'https://script.google.com/macros/s/AKfycbyV1d8U92EMLxo_Sz9CeRDMhyqfNgtrEvNOJY_jQTAQmxl3C53l8iv84E8Q2HPRag/exec',
  VERSION: '2.0.0'
};

// ========== ESTADO GLOBAL ==========
const state = {
  currentUser: null,
  userBalance: 0,
  playlist: [],
  portfolioAssets: [],
  ledgerData: [],
  currentTrackIndex: -1,
  isPlaying: false,
  currentInvestTrack: null
};

// ========== UTILIT√ÅRIOS ==========
function showToast(message, type = 'success') {
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.innerHTML = `
    <i class="bi ${type === 'success' ? 'bi-check-circle' : 'bi-exclamation-circle'} toast-icon"></i>
    <div class="toast-message">${message}</div>
  `;
  container.appendChild(toast);
  setTimeout(() => toast.classList.add('show'), 10);
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => container.removeChild(toast), 300);
  }, 3000);
}

function showLoading(message = 'Carregando...') {
  const loadingScreen = document.getElementById('loadingScreen');
  loadingScreen.style.display = 'flex';
  document.getElementById('loadingMessage').textContent = message;
}

function hideLoading() {
  document.getElementById('loadingScreen').style.display = 'none';
}

function showModal(modalId) {
  document.getElementById(modalId).classList.add('show');
}

function closeModal(modalId) {
  document.getElementById(modalId).classList.remove('show');
}

function formatCurrency(value) {
  if (value === null || value === undefined || isNaN(value)) value = 0;
  return new Intl.NumberFormat('pt-BR', {
    style: 'currency',
    currency: 'BRL'
  }).format(Number(value));
}

function formatDate(dateString) {
  if (!dateString) return '-';
  try {
    const date = new Date(dateString);
    return date.toLocaleDateString('pt-BR', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  } catch (e) {
    return dateString;
  }
}

// ========== AUTENTICA√á√ÉO ==========
async function handleLogin() {
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value.trim();

  if (!email || !password) {
    showToast('Preencha todos os campos', 'error');
    return;
  }

  showLoading('Autenticando...');

  try {
    // Para desenvolvimento: credenciais de teste
    if (email === 'admin@miv.com' && password === 'admin123') {
      state.currentUser = {
        id: 1,
        nome: 'Administrador',
        email: 'admin@miv.com',
        tipo: 'admin',
        saldo: 1000,
        acesso: 'aprovado'
      };
      localStorage.setItem('miv_user', JSON.stringify(state.currentUser));
      showToast('Login realizado com sucesso!');
      initializeApp();
      hideLoading();
      return;
    }

    const formData = new URLSearchParams();
    formData.append('action', 'login');
    formData.append('email', email);
    formData.append('password', password);

    const response = await fetch(CONFIG.API_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: formData
    });

    const result = await response.json();

    if (result.success && result.data) {
      state.currentUser = result.data;
      localStorage.setItem('miv_user', JSON.stringify(state.currentUser));
      showToast('Login realizado com sucesso!');
      
      // Limpa campos
      document.getElementById('loginEmail').value = '';
      document.getElementById('loginPassword').value = '';
      
      initializeApp();
    } else {
      showToast(result.message || 'Credenciais inv√°lidas', 'error');
    }
  } catch (error) {
    console.error('Erro no login:', error);
    showToast('Erro de conex√£o com o servidor', 'error');
  } finally {
    hideLoading();
  }
}

function showRegisterForm() {
  document.getElementById('loginForm').style.display = 'none';
  document.getElementById('registerForm').style.display = 'block';
}

function showLoginForm() {
  document.getElementById('registerForm').style.display = 'none';
  document.getElementById('loginForm').style.display = 'block';
}

function toggleArtistField() {
  const type = document.getElementById('registerType').value;
  const field = document.getElementById('artistLinkField');
  field.style.display = type === 'artista' ? 'block' : 'none';
}

async function handleRegister() {
  const name = document.getElementById('registerName').value.trim();
  const email = document.getElementById('registerEmail').value.trim();
  const password = document.getElementById('registerPassword').value.trim();
  const type = document.getElementById('registerType').value;
  const link = document.getElementById('registerLink')?.value.trim() || '';

  if (!name || !email || !password || !type) {
    showToast('Preencha todos os campos obrigat√≥rios', 'error');
    return;
  }

  if (password.length < 6) {
    showToast('A senha deve ter no m√≠nimo 6 caracteres', 'error');
    return;
  }

  showLoading('Criando conta...');

  try {
    const formData = new URLSearchParams();
    formData.append('action', 'register');
    formData.append('nome', name);
    formData.append('email', email);
    formData.append('password', password);
    formData.append('tipo', type);
    formData.append('workLink', link);
    formData.append('saldo', '0');
    formData.append('acesso', 'pendente');

    const response = await fetch(CONFIG.API_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: formData
    });

    const result = await response.json();

    if (result.success) {
      showToast('Conta criada com sucesso! Aguarde aprova√ß√£o.', 'success');
      showLoginForm();
      
      // Limpa campos
      document.getElementById('registerName').value = '';
      document.getElementById('registerEmail').value = '';
      document.getElementById('registerPassword').value = '';
      document.getElementById('registerType').value = '';
      if (document.getElementById('registerLink')) {
        document.getElementById('registerLink').value = '';
      }
    } else {
      showToast(result.message || 'Erro ao criar conta', 'error');
    }
  } catch (error) {
    console.error('Erro no registro:', error);
    showToast('Erro de conex√£o com o servidor', 'error');
  } finally {
    hideLoading();
  }
}

// ========== INICIALIZA√á√ÉO DO APP ==========
function initializeApp() {
  document.getElementById('authScreen').style.display = 'none';
  document.getElementById('mainApp').style.display = 'block';
  
  updateUserInterface();
  loadAllData();
}

function updateUserInterface() {
  if (!state.currentUser) return;
  
  const userBadge = document.getElementById('userBadge');
  if (userBadge) {
    const userType = state.currentUser.tipo || 'ouvinte';
    let badgeText = 'Ouvinte';
    if (userType === 'artista') badgeText = 'Artista';
    if (userType === 'admin') badgeText = 'Admin';
    userBadge.textContent = badgeText;
  }
  
  const artistNavItem = document.getElementById('artistNavItem');
  if (artistNavItem) {
    const userType = state.currentUser.tipo || 'ouvinte';
    if (userType === 'artista' || userType === 'admin') {
      artistNavItem.style.display = 'block';
    } else {
      artistNavItem.style.display = 'none';
    }
  }
}

async function loadAllData() {
  showLoading('Carregando dados...');
  try {
    await loadBalance();
    await loadMarketplace();
    await loadPortfolio();
    await loadLedger();
    
    if (state.currentUser.tipo === 'artista' || state.currentUser.tipo === 'admin') {
      await loadArtistData();
    }
    
    showToast('Sistema carregado com sucesso!', 'success');
  } catch (error) {
    console.error('Erro ao carregar dados:', error);
    showToast('Erro ao carregar dados do sistema', 'error');
  } finally {
    hideLoading();
  }
}

// ========== CARREGAMENTO DE DADOS ==========
async function loadBalance() {
  if (!state.currentUser) return;
  
  try {
    const formData = new URLSearchParams();
    formData.append('action', 'get_saldo');
    formData.append('user_id', state.currentUser.id || state.currentUser.email);
    
    const response = await fetch(CONFIG.API_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: formData
    });
    
    const result = await response.json();
    
    if (result.success && result.data) {
      state.userBalance = parseFloat(result.data.saldo) || 0;
    } else {
      state.userBalance = state.currentUser.saldo || 0;
    }
    
    const balanceElement = document.getElementById('currentBalance');
    if (balanceElement) {
      balanceElement.textContent = formatCurrency(state.userBalance);
    }
  } catch (error) {
    console.error('Erro ao carregar saldo:', error);
    state.userBalance = state.currentUser.saldo || 0;
    const balanceElement = document.getElementById('currentBalance');
    if (balanceElement) {
      balanceElement.textContent = formatCurrency(state.userBalance);
    }
  }
}

async function loadMarketplace() {
  try {
    const formData = new URLSearchParams();
    formData.append('action', 'get_musicas');
    
    const response = await fetch(CONFIG.API_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: formData
    });
    
    const result = await response.json();
    
    if (result.success && result.data) {
      state.playlist = result.data.filter(music => 
        music && (music.status || '').toLowerCase() === 'ativo'
      ) || [];
    } else {
      // Fallback para m√∫sicas de exemplo
      state.playlist = getSampleMusic();
    }
    
    renderMarketplace();
  } catch (error) {
    console.error('Erro ao carregar marketplace:', error);
    state.playlist = getSampleMusic();
    renderMarketplace();
    showToast('Usando dados de exemplo', 'info');
  }
}

function getSampleMusic() {
  return [
    {
      id: 1,
      titulo: "EVA",
      artista: "Elzo Henschell",
      genero: "ROCK",
      link_youtube: "https://www.youtube.com/watch?v=bFqLIyxuiMM",
      link_capa: "https://i.ytimg.com/vi/bFqLIyxuiMM/hqdefault.jpg",
      valor_acao: 15.50,
      percentual_disponivel: 25,
      acoes_vendidas: 75,
      status: "ativo"
    },
    {
      id: 2,
      titulo: "O M√°ximo",
      artista: "Elzo Henschell",
      genero: "ROCK",
      link_youtube: "https://youtu.be/utoRQzolfqs",
      link_capa: "https://i9.ytimg.com/vi_webp/utoRQzolfqs/mqdefault.webp",
      valor_acao: 22.00,
      percentual_disponivel: 40,
      acoes_vendidas: 60,
      status: "ativo"
    },
    {
      id: 3,
      titulo: "Som ON",
      artista: "Selo MIV",
      genero: "INSTRUMENTAL",
      link_youtube: "https://youtu.be/O4vSvOLtkuM",
      link_capa: "https://via.placeholder.com/300x180/111418/00ff88?text=MIV",
      valor_acao: 18.75,
      percentual_disponivel: 35,
      acoes_vendidas: 65,
      status: "ativo"
    }
  ];
}

function renderMarketplace() {
  const container = document.getElementById('marketplaceContent');
  if (!container) return;
  
  if (!state.playlist || state.playlist.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <i class="bi bi-music-note-slash empty-icon"></i>
        <h5 class="text-muted">Nenhuma m√∫sica dispon√≠vel</h5>
        <p class="text-muted">As m√∫sicas ser√£o carregadas em breve</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = state.playlist.map((track, index) => {
    const percentAvailable = track.percentual_disponivel || 0;
    const sharesSold = track.acoes_vendidas || 0;
    const totalShares = (percentAvailable / 0.01) + sharesSold;
    const availableShares = totalShares - sharesSold;
    const percentSold = totalShares > 0 ? (sharesSold / totalShares * 100).toFixed(1) : 0;
    
    let percentColor = '#007bff';
    if (percentSold >= 80) percentColor = '#dc3545';
    else if (percentSold >= 50) percentColor = '#ffc107';
    
    return `
      <div class="music-card" onclick="playTrack(${index})">
        <img src="${track.link_capa || track.LINK_CAPA || 'https://via.placeholder.com/300x180/111418/00ff88?text=MIV'}" 
             class="music-cover" 
             alt="${track.titulo || track.TITULO || 'M√∫sica'}"
             onerror="this.src='https://via.placeholder.com/300x180/111418/00ff88?text=MIV'">
        <div class="music-info">
          <h6 class="music-title">${track.titulo || track.TITULO || 'Sem t√≠tulo'}</h6>
          <p class="music-artist">${track.artista || track.ARTISTA || 'Artista Desconhecido'}</p>
          <div class="music-meta">
            <span class="music-price">${formatCurrency(track.valor_acao || track.VALOR_ACAO || 0)}</span>
            <span class="music-percent" 
                  style="background: rgba(var(--${percentSold >= 80 ? 'danger' : percentSold >= 50 ? 'warning' : 'primary'}-rgb), 0.1); color: ${percentColor}"
                  data-tooltip="Dispon√≠vel: ${availableShares} a√ß√µes">
              ${availableShares} a√ß√µes disp.
            </span>
          </div>
          <button class="btn-miv btn-sm w-100" onclick="event.stopPropagation(); openInvestModal(${index})">
            <i class="bi bi-currency-dollar me-1"></i> Investir
          </button>
        </div>
      </div>
    `;
  }).join('');
}

async function loadPortfolio() {
  if (!state.currentUser) return;
  
  try {
    const formData = new URLSearchParams();
    formData.append('action', 'get_carteira');
    formData.append('user_id', state.currentUser.id || state.currentUser.email);
    
    const response = await fetch(CONFIG.API_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: formData
    });
    
    const result = await response.json();
    
    if (result.success) {
      state.portfolioAssets = result.data || [];
    } else {
      state.portfolioAssets = [];
    }
    
    renderPortfolio();
  } catch (error) {
    console.error('Erro ao carregar portf√≥lio:', error);
    state.portfolioAssets = [];
    renderPortfolio();
  }
}

function renderPortfolio() {
  const container = document.getElementById('portfolioContent');
  const countElement = document.getElementById('assetsCount');
  const portfolioValueElement = document.getElementById('portfolioValue');
  
  if (!container) return;
  
  // Calcula valor total do portf√≥lio
  let totalValue = 0;
  state.portfolioAssets.forEach(asset => {
    const music = state.playlist.find(m => m.id === asset.id_musica);
    const currentPrice = music ? (music.valor_acao || music.VALOR_ACAO || 0) : (asset.valor_pago_por_acao || 0);
    const quantity = asset.quantidade_acoes || 0;
    totalValue += currentPrice * quantity;
  });
  
  // Atualiza valores totais
  if (portfolioValueElement) {
    portfolioValueElement.textContent = formatCurrency(totalValue);
  }
  
  if (countElement) {
    countElement.textContent = `${state.portfolioAssets.length} ativo${state.portfolioAssets.length !== 1 ? 's' : ''}`;
  }
  
  if (!state.portfolioAssets || state.portfolioAssets.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <i class="bi bi-briefcase empty-icon"></i>
        <h5 class="text-muted">Nenhum ativo na carteira</h5>
        <p class="text-muted">Invista em m√∫sicas para come√ßar a construir seu portf√≥lio</p>
        <button class="btn-miv mt-3" onclick="changeSection('marketplace')">
          <i class="bi bi-arrow-right me-2"></i> Ir para o Marketplace
        </button>
      </div>
    `;
    return;
  }
  
  container.innerHTML = state.portfolioAssets.map(asset => {
    const music = state.playlist.find(m => m.id === asset.id_musica) || {};
    const currentPrice = music.valor_acao || music.VALOR_ACAO || asset.valor_pago_por_acao || 0;
    const purchasePrice = asset.valor_pago_por_acao || 0;
    const quantity = asset.quantidade_acoes || 0;
    const totalValue = quantity * currentPrice;
    const purchaseValue = quantity * purchasePrice;
    const profitLoss = totalValue - purchaseValue;
    const profitLossPercent = purchaseValue > 0 ? (profitLoss / purchaseValue * 100).toFixed(2) : 0;
    
    return `
      <div class="music-card mb-3">
        <div class="d-flex">
          <img src="${music.link_capa || music.LINK_CAPA || 'https://via.placeholder.com/80x80/111418/00ff88?text=MIV'}" 
               style="width: 80px; height: 80px; object-fit: cover; border-radius: 0.75rem; margin-right: 1rem;" 
               alt="${music.titulo || music.TITULO || 'M√∫sica'}"
               onerror="this.src='https://via.placeholder.com/80x80/111418/00ff88?text=MIV'">
          <div style="flex: 1;">
            <h6 class="music-title">${music.titulo || music.TITULO || 'M√∫sica n√£o encontrada'}</h6>
            <p class="music-artist">${music.artista || music.ARTISTA || 'Artista Desconhecido'}</p>
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <small class="text-muted">A√ß√µes:</small>
                <div class="fw-bold">${quantity}</div>
              </div>
              <div class="text-center">
                <small class="text-muted">Valor atual:</small>
                <div class="fw-bold">${formatCurrency(totalValue)}</div>
              </div>
              <div class="text-end">
                <small class="text-muted">Rentabilidade:</small>
                <div class="fw-bold ${profitLoss >= 0 ? 'text-success' : 'text-danger'}">
                  ${profitLoss >= 0 ? '+' : ''}${formatCurrency(profitLoss)}
                </div>
                <small class="${profitLoss >= 0 ? 'text-success' : 'text-danger'}">
                  (${profitLossPercent}%)
                </small>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

async function loadLedger() {
  if (!state.currentUser) return;
  
  try {
    const formData = new URLSearchParams();
    formData.append('action', 'get_extrato');
    formData.append('user_id', state.currentUser.id || state.currentUser.email);
    
    const response = await fetch(CONFIG.API_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: formData
    });
    
    const result = await response.json();
    
    if (result.success) {
      state.ledgerData = result.data || [];
    } else {
      state.ledgerData = [];
    }
    
    renderLedger();
  } catch (error) {
    console.error('Erro ao carregar extrato:', error);
    state.ledgerData = [];
    renderLedger();
  }
}

function renderLedger() {
  const container = document.getElementById('ledgerContent');
  if (!container) return;
  
  if (!state.ledgerData || state.ledgerData.length === 0) {
    container.innerHTML = `
      <tr>
        <td colspan="3" class="text-center text-muted py-4">
          <i class="bi bi-receipt fs-4 d-block mb-2"></i>
          Nenhuma transa√ß√£o encontrada
        </td>
      </tr>
    `;
    return;
  }
  
  // Ordena por data (mais recente primeiro)
  const sortedData = [...state.ledgerData].sort((a, b) => {
    const dateA = new Date(a.data || a.Data || 0);
    const dateB = new Date(b.data || b.Data || 0);
    return dateB - dateA;
  });
  
  container.innerHTML = sortedData.map(transaction => {
    const amount = parseFloat(transaction.valor || transaction.Valor || 0);
    const type = (transaction.tipo || transaction.Tipo || '').toLowerCase();
    const description = transaction.descricao || transaction.Descricao || '';
    
    let typeClass = 'text-muted';
    let typeIcon = 'bi-receipt';
    
    if (type.includes('deposito') || type.includes('royalty') || type.includes('receita')) {
      typeClass = 'text-success';
      typeIcon = 'bi-plus-circle';
    } else if (type.includes('compra') || type.includes('investimento') || type.includes('saque')) {
      typeClass = 'text-danger';
      typeIcon = 'bi-currency-dollar';
    } else if (type.includes('venda')) {
      typeClass = 'text-info';
      typeIcon = 'bi-arrow-up-right';
    }
    
    return `
      <tr>
        <td>${formatDate(transaction.data || transaction.Data)}</td>
        <td>
          <i class="bi ${typeIcon} me-2"></i>
          ${description}
        </td>
        <td class="text-end ${typeClass} fw-bold">
          ${amount >= 0 ? '+' : ''}${formatCurrency(amount)}
        </td>
      </tr>
    `;
  }).join('');
}

async function loadArtistData() {
  if (!state.currentUser || (state.currentUser.tipo !== 'artista' && state.currentUser.tipo !== 'admin')) return;
  
  try {
    const formData = new URLSearchParams();
    formData.append('action', 'get_artist_data');
    formData.append('user_id', state.currentUser.id || state.currentUser.email);
    
    const response = await fetch(CONFIG.API_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: formData
    });
    
    const result = await response.json();
    
    if (result.success) {
      const artistData = result.data || {};
      
      // Atualiza estat√≠sticas
      const musicCountEl = document.getElementById('artistMusicCount');
      const royaltiesEl = document.getElementById('artistRoyalties');
      const sharesSoldEl = document.getElementById('artistSharesSold');
      
      if (musicCountEl) musicCountEl.textContent = artistData.total_musicas || 0;
      if (royaltiesEl) royaltiesEl.textContent = formatCurrency(artistData.total_royalties || 0);
      if (sharesSoldEl) sharesSoldEl.textContent = artistData.total_acoes_vendidas || 0;
      
      // Renderiza m√∫sicas do artista
      const container = document.getElementById('artistMusicContent');
      if (container) {
        const artistMusic = artistData.musicas || [];
        
        if (artistMusic.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <i class="bi bi-music-note-beamed empty-icon"></i>
              <h5 class="text-muted">Nenhuma m√∫sica cadastrada</h5>
              <p class="text-muted">Cadastre sua primeira m√∫sica para come√ßar a vender a√ß√µes</p>
              <button class="btn-miv mt-3" onclick="openAddMusicModal()">
                <i class="bi bi-plus-circle me-2"></i> Cadastrar M√∫sica
              </button>
            </div>
          `;
        } else {
          container.innerHTML = artistMusic.map(music => {
            const percentSold = music.percentual_vendido || 0;
            const earnings = music.arrecadacao_total || 0;
            
            return `
              <div class="music-card">
                <img src="${music.link_capa || 'https://via.placeholder.com/300x180/111418/00ff88?text=MIV'}" 
                     class="music-cover" 
                     alt="${music.titulo}"
                     onerror="this.src='https://via.placeholder.com/300x180/111418/00ff88?text=MIV'">
                <div class="music-info">
                  <h6 class="music-title">${music.titulo}</h6>
                  <p class="music-artist">${state.currentUser.nome}</p>
                  <div class="music-meta">
                    <span class="music-price">${formatCurrency(music.valor_acao)}</span>
                    <span class="music-percent ${percentSold >= 80 ? 'bg-success' : percentSold >= 50 ? 'bg-warning' : 'bg-info'} text-white">
                      ${percentSold.toFixed(1)}% vendido
                    </span>
                  </div>
                  <div class="d-flex gap-2 mt-2">
                    <button class="btn btn-outline-success btn-sm flex-fill" onclick="editMusic('${music.id}')">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-outline-info btn-sm flex-fill" onclick="viewMusicStats('${music.id}')">
                      <i class="bi bi-bar-chart"></i>
                    </button>
                  </div>
                  <div class="mt-2 text-center">
                    <small class="text-muted">Arrecadado: ${formatCurrency(earnings)}</small>
                  </div>
                </div>
              </div>
            `;
          }).join('');
        }
      }
    }
  } catch (error) {
    console.error('Erro ao carregar dados do artista:', error);
  }
}

// ========== INVESTIMENTOS ==========
function openInvestModal(trackIndex) {
  if (trackIndex < 0 || trackIndex >= state.playlist.length) {
    showToast('M√∫sica n√£o encontrada', 'error');
    return;
  }
  
  const track = state.playlist[trackIndex];
  state.currentInvestTrack = track;
  
  // Preenche informa√ß√µes no modal
  document.getElementById('investTrackTitle').textContent = track.titulo || track.TITULO || 'T√≠tulo desconhecido';
  document.getElementById('investTrackArtist').textContent = track.artista || track.ARTISTA || 'Artista desconhecido';
  document.getElementById('investUnitPrice').textContent = formatCurrency(track.valor_acao || track.VALOR_ACAO || 0);
  document.getElementById('investAvailableBalance').textContent = formatCurrency(state.userBalance);
  
  const investQuantity = document.getElementById('investQuantity');
  investQuantity.value = 1;
  investQuantity.min = 1;
  investQuantity.max = Math.floor(state.userBalance / (track.valor_acao || track.VALOR_ACAO || 1));
  
  updateInvestmentTotal();
  showModal('investModal');
}

function updateInvestmentTotal() {
  const quantityInput = document.getElementById('investQuantity');
  const quantity = quantityInput ? parseInt(quantityInput.value) || 1 : 1;
  const unitPrice = state.currentInvestTrack ? (state.currentInvestTrack.valor_acao || state.currentInvestTrack.VALOR_ACAO || 0) : 0;
  const total = quantity * unitPrice;
  
  document.getElementById('investTotalPrice').textContent = formatCurrency(total);
  
  // Habilita/desabilita bot√£o
  const confirmBtn = document.getElementById('confirmInvestBtn');
  if (total <= state.userBalance && quantity > 0) {
    confirmBtn.disabled = false;
    confirmBtn.textContent = 'Confirmar Investimento';
  } else {
    confirmBtn.disabled = true;
    if (total > state.userBalance) {
      confirmBtn.textContent = 'Saldo Insuficiente';
    } else {
      confirmBtn.textContent = 'Quantidade Inv√°lida';
    }
  }
}

async function confirmInvestment() {
  if (!state.currentInvestTrack || !state.currentUser) {
    showToast('Erro ao processar investimento', 'error');
    return;
  }
  
  const quantityInput = document.getElementById('investQuantity');
  const quantity = quantityInput ? parseInt(quantityInput.value) || 1 : 1;
  const totalPrice = quantity * (state.currentInvestTrack.valor_acao || state.currentInvestTrack.VALOR_ACAO || 0);
  
  if (totalPrice > state.userBalance) {
    showToast('Saldo insuficiente para esta compra', 'error');
    return;
  }
  
  if (quantity <= 0) {
    showToast('Quantidade inv√°lida', 'error');
    return;
  }
  
  showLoading('Processando investimento...');
  
  try {
    const formData = new URLSearchParams();
    formData.append('action', 'buy');
    formData.append('user_id', state.currentUser.id || state.currentUser.email);
    formData.append('music_id', state.currentInvestTrack.id || state.currentInvestTrack.ID);
    formData.append('quantidade', quantity.toString());
    formData.append('valor_total', totalPrice.toString());
    
    const response = await fetch(CONFIG.API_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: formData
    });
    
    const result = await response.json();
    
    if (result.success) {
      showToast(`Investimento realizado com sucesso! ${quantity} a√ß√£o(√µes) comprada(s).`, 'success');
      
      // Atualiza dados locais
      state.userBalance -= totalPrice;
      document.getElementById('currentBalance').textContent = formatCurrency(state.userBalance);
      
      // Recarrega dados
      await Promise.all([
        loadPortfolio(),
        loadLedger(),
        loadMarketplace()
      ]);
      
      closeModal('investModal');
    } else {
      showToast(result.message || 'Erro ao processar investimento', 'error');
    }
  } catch (error) {
    console.error('Erro no investimento:', error);
    showToast('Erro de conex√£o ao processar investimento', 'error');
  } finally {
    hideLoading();
  }
}

// ========== GERENCIAMENTO DE M√öSICAS (ARTISTA) ==========
function openAddMusicModal() {
  if (state.currentUser.tipo !== 'artista' && state.currentUser.tipo !== 'admin') {
    showToast('Apenas artistas podem cadastrar m√∫sicas', 'error');
    return;
  }
  
  // Limpa campos
  document.getElementById('musicTitle').value = '';
  document.getElementById('musicGenre').value = '';
  document.getElementById('musicYoutube').value = '';
  document.getElementById('musicCover').value = '';
  document.getElementById('musicPrice').value = '10.00';
  document.getElementById('musicPercent').value = '20';
  
  showModal('addMusicModal');
}

async function registerMusic() {
  if (!state.currentUser || (state.currentUser.tipo !== 'artista' && state.currentUser.tipo !== 'admin')) {
    showToast('Apenas artistas podem cadastrar m√∫sicas', 'error');
    return;
  }
  
  const title = document.getElementById('musicTitle').value.trim();
  const genre = document.getElementById('musicGenre').value;
  const youtube = document.getElementById('musicYoutube').value.trim();
  const cover = document.getElementById('musicCover').value.trim();
  const price = parseFloat(document.getElementById('musicPrice').value) || 0;
  const percent = parseFloat(document.getElementById('musicPercent').value) || 0;
  
  // Valida√ß√µes
  if (!title || !genre || !youtube) {
    showToast('Preencha todos os campos obrigat√≥rios', 'error');
    return;
  }
  
  if (price <= 0) {
    showToast('O valor por a√ß√£o deve ser maior que zero', 'error');
    return;
  }
  
  if (percent <= 0 || percent > 100) {
    showToast('O percentual deve estar entre 1% e 100%', 'error');
    return;
  }
  
  showLoading('Cadastrando m√∫sica...');
  
  try {
    const formData = new URLSearchParams();
    formData.append('action', 'uploadMusic');
    formData.append('user_id', state.currentUser.id || state.currentUser.email);
    formData.append('titulo', title);
    formData.append('artista', state.currentUser.nome);
    formData.append('genero', genre);
    formData.append('link_youtube', youtube);
    formData.append('link_capa', cover);
    formData.append('valor_acao', price.toString());
    formData.append('percentual_disponivel', percent.toString());
    formData.append('status', 'ativo');
    
    const response = await fetch(CONFIG.API_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: formData
    });
    
    const result = await response.json();
    
    if (result.success) {
      showToast('M√∫sica cadastrada com sucesso!', 'success');
      
      // Recarrega dados
      await Promise.all([
        loadArtistData(),
        loadMarketplace()
      ]);
      
      closeModal('addMusicModal');
    } else {
      showToast(result.message || 'Erro ao cadastrar m√∫sica', 'error');
    }
  } catch (error) {
    console.error('Erro ao cadastrar m√∫sica:', error);
    showToast('Erro de conex√£o ao cadastrar m√∫sica', 'error');
  } finally {
    hideLoading();
  }
}

function editMusic(musicId) {
  showToast('Funcionalidade em desenvolvimento', 'info');
}

function viewMusicStats(musicId) {
  showToast('Estat√≠sticas em desenvolvimento', 'info');
}

// ========== PLAYER DE M√öSICA ==========
function playTrack(index) {
  if (index < 0 || index >= state.playlist.length) {
    showToast('M√∫sica n√£o encontrada', 'error');
    return;
  }
  
  state.currentTrackIndex = index;
  const track = state.playlist[index];
  
  // Atualiza informa√ß√µes do player
  document.getElementById('playerTitle').textContent = track.titulo || track.TITULO || 'T√≠tulo desconhecido';
  document.getElementById('playerArtist').textContent = track.artista || track.ARTISTA || 'Artista desconhecido';
  document.getElementById('playerPrice').textContent = `${formatCurrency(track.valor_acao || track.VALOR_ACAO || 0)} por a√ß√£o`;
  
  const playerAlbumArt = document.getElementById('playerAlbumArt');
  const coverUrl = track.link_capa || track.LINK_CAPA || 'https://via.placeholder.com/60x60/111418/00ff88?text=MIV';
  playerAlbumArt.src = coverUrl;
  playerAlbumArt.onerror = function() {
    this.src = 'https://via.placeholder.com/60x60/111418/00ff88?text=MIV';
  };
  
  // Mostra o player
  document.getElementById('playerBar').style.display = 'block';
  
  // Atualiza bot√£o de play
  document.getElementById('playButton').innerHTML = '<i class="bi bi-pause-circle-fill"></i>';
  state.isPlaying = true;
  
  // Extrai ID do YouTube e toca
  const youtubeLink = track.link_youtube || track.LINK_YOUTUBE;
  if (youtubeLink) {
    const videoId = extractYouTubeId(youtubeLink);
    if (videoId) {
      document.getElementById('youtubePlayer').innerHTML = `
        <iframe width="100%" height="100%" 
                src="https://www.youtube.com/embed/${videoId}?autoplay=1&controls=0&modestbranding=1&showinfo=0&rel=0" 
                frameborder="0" 
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                allowfullscreen>
        </iframe>
      `;
    }
  }
  
  showToast('Player de m√∫sica iniciado', 'info');
}

function extractYouTubeId(url) {
  if (!url) return null;
  const regExp = /^.*(youtu\.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
  const match = url.match(regExp);
  return (match && match[2].length === 11) ? match[2] : null;
}

function togglePlay() {
  const playButton = document.getElementById('playButton');
  if (state.isPlaying) {
    playButton.innerHTML = '<i class="bi bi-play-circle-fill"></i>';
    state.isPlaying = false;
  } else {
    playButton.innerHTML = '<i class="bi bi-pause-circle-fill"></i>';
    state.isPlaying = true;
  }
}

function togglePlayerExpansion() {
  const playerBar = document.getElementById('playerBar');
  playerBar.classList.toggle('expanded');
}

function seekMusic(event) {
  // Implementa√ß√£o b√°sica - pode ser expandida
  console.log('Seek position:', event.offsetX);
}

function setVolume(value) {
  console.log('Volume set to:', value);
}

function toggleShuffle() {
  const icon = document.getElementById('shuffleIcon');
  icon.style.color = icon.style.color === 'var(--neon-green)' ? 'var(--text-light)' : 'var(--neon-green)';
  showToast(icon.style.color === 'var(--neon-green)' ? 'Modo aleat√≥rio ativado' : 'Modo aleat√≥rio desativado');
}

function toggleRepeat() {
  const icon = document.getElementById('repeatIcon');
  icon.style.color = icon.style.color === 'var(--neon-green)' ? 'var(--text-light)' : 'var(--neon-green)';
  showToast(icon.style.color === 'var(--neon-green)' ? 'Repeti√ß√£o ativada' : 'Repeti√ß√£o desativada');
}

function playNext() {
  if (state.playlist.length === 0) return;
  const nextIndex = (state.currentTrackIndex + 1) % state.playlist.length;
  playTrack(nextIndex);
}

function playPrevious() {
  if (state.playlist.length === 0) return;
  const prevIndex = state.currentTrackIndex > 0 ? state.currentTrackIndex - 1 : state.playlist.length - 1;
  playTrack(prevIndex);
}

// ========== NAVEGA√á√ÉO E UI ==========
function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
}

function changeSection(sectionId, buttonElement = null) {
  // Esconde todas as se√ß√µes
  document.querySelectorAll('.section').forEach(section => {
    section.classList.remove('active');
  });
  
  // Mostra a se√ß√£o selecionada
  const sectionElement = document.getElementById(`${sectionId}Section`);
  if (sectionElement) {
    sectionElement.classList.add('active');
  }
  
  // Atualiza bot√µes de navega√ß√£o
  if (buttonElement) {
    document.querySelectorAll('.nav-btn').forEach(btn => {
      btn.classList.remove('active');
    });
    buttonElement.classList.add('active');
  }
  
  // Atualiza menu lateral
  document.querySelectorAll('.nav-link').forEach(link => {
    link.classList.remove('active');
    if (link.getAttribute('onclick')?.includes(sectionId)) {
      link.classList.add('active');
    }
  });
  
  // Fecha sidebar no mobile
  if (window.innerWidth < 768) {
    toggleSidebar();
  }
}

function logout() {
  if (confirm('Tem certeza que deseja sair?')) {
    // Limpa localStorage
    localStorage.removeItem('miv_user');
    
    // Esconde player
    document.getElementById('playerBar').style.display = 'none';
    
    // Mostra tela de login
    document.getElementById('mainApp').style.display = 'none';
    document.getElementById('authScreen').style.display = 'flex';
    showLoginForm();
    
    // Limpa estado
    state.currentUser = null;
    state.userBalance = 0;
    state.playlist = [];
    state.portfolioAssets = [];
    state.ledgerData = [];
    
    showToast('Logout realizado com sucesso', 'success');
  }
}

// ========== INICIALIZA√á√ÉO ==========
document.addEventListener('DOMContentLoaded', function() {
  console.log(`SELO MIV v${CONFIG.VERSION} - Sistema iniciando...`);
  
  // Verifica se h√° usu√°rio salvo
  setTimeout(() => {
    hideLoading();
    
    const savedUser = localStorage.getItem('miv_user');
    if (savedUser) {
      try {
        state.currentUser = JSON.parse(savedUser);
        initializeApp();
      } catch (e) {
        console.error('Erro ao restaurar sess√£o:', e);
        localStorage.removeItem('miv_user');
      }
    }
  }, 1500);
  
  // Enter key para forms
  document.getElementById('loginPassword')?.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') handleLogin();
  });
  
  document.getElementById('registerPassword')?.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') handleRegister();
  });
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
