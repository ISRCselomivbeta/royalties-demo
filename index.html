<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>SELO MIV Play</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- mantém seu CSS original -->
<link rel="stylesheet" href="style.css">
</head>

<body>

<!-- ================= AUTH ================= -->
<div id="auth">

  <div id="loginBox">
    <h2>Login</h2>
    <input id="login_email" type="email" placeholder="Email">
    <input id="login_password" type="password" placeholder="Senha">
    <button onclick="login()">Entrar</button>
    <p><a href="#" onclick="showRegister()">Criar conta</a></p>
  </div>

  <div id="registerBox" style="display:none">
    <h2>Cadastro</h2>
    <input id="reg_nome" type="text" placeholder="Nome">
    <input id="reg_email" type="email" placeholder="Email">
    <input id="reg_password" type="password" placeholder="Senha">

    <select id="reg_tipo" onchange="toggleArtist()">
      <option value="">Tipo</option>
      <option value="investidor">Investidor</option>
      <option value="artista">Artista</option>
    </select>

    <input id="reg_link" type="text" placeholder="Link artístico" style="display:none">

    <button onclick="register()">Cadastrar</button>
    <p><a href="#" onclick="showLogin()">Já tenho conta</a></p>
  </div>

</div>

<!-- ================= APP ================= -->
<div id="app" style="display:none">

  <header>
    <h2>SELO MIV</h2>
    <button onclick="logout()">Sair</button>
  </header>

  <section>
    <h3>Saldo</h3>
    <div id="saldo">R$ 0,00</div>
  </section>

  <section>
    <h3>Músicas</h3>
    <div id="musicas"></div>
  </section>

</div>

<script>
/* ================= CONFIG ================= */
const API = 'https://script.google.com/macros/s/AKfycbwcs1mvYQb81WkwoMtSgtyXkSJfwaInXNy0DLzJjovFbxHs78vYwj13Mel3p5d3XuI/exec';

/* ================= HELPERS ================= */
function request(action, data = {}) {
  return fetch(API, {
    method: 'POST',
    body: JSON.stringify({ action, ...data })
  }).then(r => r.json());
}

function $(id){ return document.getElementById(id); }

/* ================= UI ================= */
function showRegister(){
  $('loginBox').style.display='none';
  $('registerBox').style.display='block';
}

function showLogin(){
  $('registerBox').style.display='none';
  $('loginBox').style.display='block';
}

function toggleArtist(){
  $('reg_link').style.display =
    $('reg_tipo').value === 'artista' ? 'block' : 'none';
}

/* ================= AUTH ================= */
function register(){
  request('register',{
    nome: $('reg_nome').value.trim(),
    email: $('reg_email').value.trim(),
    password: $('reg_password').value.trim(),
    tipo: $('reg_tipo').value,
    workLink: $('reg_link').value.trim()
  }).then(r=>{
    if(!r.success) return alert(r.error);
    alert('Cadastro realizado');
    showLogin();
  });
}

function login(){
  request('login',{
    email: $('login_email').value.trim(),
    password: $('login_password').value.trim()
  }).then(r=>{
    if(!r.success) return alert(r.error);
    localStorage.setItem('user', JSON.stringify(r.user));
    start();
  });
}

function logout(){
  localStorage.removeItem('user');
  location.reload();
}

/* ================= APP ================= */
function start(){
  const user = JSON.parse(localStorage.getItem('user'));
  if(!user) return;

  $('auth').style.display='none';
  $('app').style.display='block';

  loadSaldo();
  loadMusicas();
}

function loadSaldo(){
  const u = JSON.parse(localStorage.getItem('user'));
  request('getSaldo',{ userId:u.id }).then(r=>{
    if(r.success){
      $('saldo').innerText = 'R$ ' + r.saldo.toFixed(2);
    }
  });
}

function loadMusicas(){
  request('getMusicas').then(r=>{
    if(!r.success) return;
    $('musicas').innerHTML='';
    r.musicas.forEach(m=>{
      const d=document.createElement('div');
      d.innerHTML=`
        <strong>${m.nome}</strong><br>
        Preço: R$ ${m.precoAcao}<br>
        Disponível: ${m.acoesDisponiveis}<br>
        <button onclick="buy('${m.id}')">Comprar</button>
        <hr>`;
      $('musicas').appendChild(d);
    });
  });
}

function buy(id){
  const u = JSON.parse(localStorage.getItem('user'));
  request('buy',{
    userId:u.id,
    musicaId:id,
    quantidade:1
  }).then(r=>{
    alert(r.message || r.error);
    loadSaldo();
    loadMusicas();
  });
}

/* ================= INIT ================= */
document.addEventListener('DOMContentLoaded', start);
</script>

</body>
</html>
