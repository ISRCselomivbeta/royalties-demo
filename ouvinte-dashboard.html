<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIV Premium | Dashboard Unificado</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --miv-blue: #0072ff;
            --miv-cyan: #00c6ff;
            --miv-red: #f6465d;
            --miv-green: #0ecb81;
            --bg-dark: #05070a;
            --card-gray: #1e2329;
            --border: rgba(255, 255, 255, 0.1);
        }

        body {
            background: var(--bg-dark);
            color: #ffffff;
            font-family: 'Inter', sans-serif;
            padding-bottom: 120px;
        }

        /* Ticker Superior */
        .ticker-wrap { background: rgba(0, 114, 255, 0.1); padding: 5px 0; border-bottom: 1px solid var(--border); overflow: hidden; }
        .ticker { display: inline-block; white-space: nowrap; animation: ticker 30s linear infinite; font-size: 0.75rem; color: var(--miv-cyan); font-weight: bold; }
        @keyframes ticker { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }

        /* Card de Saldo */
        .wallet-card {
            background: linear-gradient(135deg, var(--miv-blue), var(--miv-cyan));
            border-radius: 24px;
            padding: 25px;
            margin: 20px 15px;
            box-shadow: 0 10px 30px rgba(0, 114, 255, 0.3);
            text-align: center;
        }
        .saldo-valor { font-size: 2.2rem; font-weight: 800; }

        /* Navega√ß√£o por Abas (Estilo P√≠lula) */
        .nav-miv { display: flex; justify-content: center; gap: 8px; margin-bottom: 20px; overflow-x: auto; padding: 0 10px; }
        .btn-tab {
            background: var(--card-gray); border: 1px solid var(--border); color: #fff;
            border-radius: 50px; padding: 8px 15px; font-size: 0.75rem; white-space: nowrap;
        }
        .btn-tab.active { background: var(--miv-cyan); color: #000; font-weight: bold; border-color: var(--miv-cyan); }

        /* Se√ß√µes de Conte√∫do */
        .page-section { display: none; animation: fadeIn 0.3s ease; }
        .page-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Mercado e Exchange Cards */
        .music-card { background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 20px; padding: 15px; margin-bottom: 15px; }
        .yt-frame { border-radius: 15px; width: 100%; height: 160px; margin-bottom: 10px; border: 1px solid var(--border); }
        
        /* Bot√µes */
        .btn-buy { background: var(--miv-green); border: none; color: black; font-weight: bold; border-radius: 10px; }
        .btn-sell { background: var(--miv-red); border: none; color: white; font-weight: bold; border-radius: 10px; }
        .btn-mine { background: transparent; border: 1px solid var(--miv-cyan); color: var(--miv-cyan); font-weight: bold; border-radius: 10px; }

        /* Hist√≥rico */
        .historico-item { background: var(--card-gray); border-radius: 12px; padding: 15px; margin-bottom: 10px; border-left: 4px solid var(--miv-cyan); }
        .v-pos { color: var(--miv-green); }
        .v-neg { color: var(--miv-red); }

        /* Player Minerador */
        .miv-player {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(5, 7, 10, 0.95); backdrop-filter: blur(20px);
            border-top: 1px solid var(--miv-cyan); padding: 15px 25px; z-index: 1000; display: none;
        }
    </style>
</head>
<body>

    <div class="ticker-wrap">
        <div class="ticker">‚Ä¢ MIV Exchange: Ativos em alta +12% ‚Ä¢ @Ouvinte minerou R$ 0,01 agora ‚Ä¢ Participe dos Drops de Playlist ‚Ä¢</div>
    </div>

    <div class="wallet-card">
        <p class="small mb-1 opacity-75">Meu Patrim√¥nio Musical</p>
        <div class="saldo-valor" id="saldoTxt">R$ 0,00</div>
        <div class="d-flex justify-content-center gap-2 mt-2">
            <span class="badge rounded-pill bg-black bg-opacity-25 p-2 px-3" style="font-size: 0.65rem;">
                <i class="bi bi-lightning-charge-fill text-warning"></i> Ativo M01: R$ 18,50
            </span>
        </div>
    </div>

    <div class="nav-miv">
        <button class="btn-tab active" onclick="switchTab('market', this)">üî• Mercado</button>
        <button class="btn-tab" onclick="switchTab('exchange', this)">üöÄ Exchange (Vender)</button>
        <button class="btn-tab" onclick="switchTab('banca', this)">üíé Minha Banca</button>
    </div>

    <main class="container px-4">
        
        <section id="sec-market" class="page-section active">
            <h6 class="text-micro opacity-50 mb-3 small">Novos Ativos para Investir</h6>
            <div id="lista-market">
                <div class="text-center py-5"><div class="spinner-border text-info"></div></div>
            </div>
        </section>

        <section id="sec-exchange" class="page-section">
            <h6 class="text-micro opacity-50 mb-3 small">Realizar Lucro (Venda)</h6>
            <div id="lista-venda">
                <p class="text-muted text-center small py-5">Buscando seus ativos na rede...</p>
            </div>
        </section>

        <section id="sec-banca" class="page-section">
            <h6 class="text-micro opacity-50 mb-3 small">Hist√≥rico de Transa√ß√µes</h6>
            <div id="lista-historico">
                <p class="text-muted text-center small">Nenhuma transa√ß√£o registrada.</p>
            </div>
        </section>

    </main>

    <div class="miv-player" id="playerArea">
        <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center">
                <div class="spinner-grow text-info me-3" style="width: 1rem; height: 1rem;"></div>
                <div>
                    <small class="text-info d-block fw-bold" style="font-size: 0.6rem;">BLOCKCHAIN VALIDANDO...</small>
                    <span id="timerStatus" style="font-size: 0.9rem;">30s restantes</span>
                </div>
            </div>
            <button class="btn text-white p-0" onclick="cancelarPlay()"><i class="bi bi-x-circle h4"></i></button>
        </div>
    </div>

    <script>
        const YT_API_KEY = 'AIzaSyAPaYGY_MrrNgKdEqTs3Qw7tPNv5p5QwPM';
        const PLAYLIST_ID = 'PLvteL0_9cu8oE_N4Qfz5JJucTTkY2czcN';
        const APP_URL = "https://script.google.com/macros/s/AKfycbz-XDvFYhUjmZMfnZreUdzULCfAprqStkfNAWaY2vXqR4XwOgtF0OOe30g4z7-v_-xu/exec";
        
        let timerInterval;

        window.onload = () => carregarTudo();

        function switchTab(tab, btn) {
            document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.btn-tab').forEach(b => b.classList.remove('active'));
            document.getElementById('sec-' + tab).classList.add('active');
            btn.classList.add('active');
        }

        async function carregarTudo() {
            carregarMarketplace();
            carregarDadosServidor();
        }

        async function carregarMarketplace() {
            try {
                const res = await fetch(`https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&maxResults=20&playlistId=${PLAYLIST_ID}&key=${YT_API_KEY}`);
                const data = await res.json();
                const container = document.getElementById('lista-market');
                const exchangeContainer = document.getElementById('lista-venda');
                container.innerHTML = '';
                exchangeContainer.innerHTML = '';

                data.items.forEach(item => {
                    const id = item.snippet.resourceId.videoId;
                    const tit = item.snippet.title;
                    
                    // Card para o Mercado (Comprar)
                    container.innerHTML += `
                        <div class="music-card">
                            <iframe class="yt-frame" src="https://www.youtube.com/embed/${id}" frameborder="0"></iframe>
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0 text-truncate fw-bold" style="max-width: 60%;">${tit}</h6>
                                <button class="btn btn-buy btn-sm px-3" onclick="negociar('${id}', '${tit}', 15.00, 'COMPRA')">COMPRAR</button>
                            </div>
                            <button class="btn btn-mine btn-sm w-100 mt-3" onclick="iniciarMinera√ß√£o('${id}', '${tit}')">OUVIR E MINERAR</button>
                        </div>`;

                    // Card para a Exchange (Venda) - Pre√ßo de mercado simulado em 18.50 para lucro
                    exchangeContainer.innerHTML += `
                        <div class="music-card">
                            <div class="d-flex justify-content-between align-items-center">
                                <div><small class="text-info opacity-75">ATIVO</small><br><span class="fw-bold">${tit}</span></div>
                                <div class="text-end"><small class="text-muted">MERCADO</small><br><span class="text-success fw-bold">R$ 18,50</span></div>
                            </div>
                            <button class="btn btn-sell btn-sm w-100 mt-3" onclick="negociar('${id}', '${tit}', 18.50, 'VENDA')">VENDER TODAS (LUCRO)</button>
                        </div>`;
                });
            } catch (e) { console.error("Erro API"); }
        }

        async function carregarDadosServidor() {
            const userId = localStorage.getItem('userId');
            try {
                const res = await fetch(`${APP_URL}?acao=ver_carteira&userId=${userId}`);
                const data = await res.json();
                if(data.success) {
                    document.getElementById('saldoTxt').innerText = "R$ " + data.saldo.toFixed(2);
                    const histCont = document.getElementById('lista-historico');
                    histCont.innerHTML = '';
                    data.historico.reverse().forEach(item => {
                        const isPos = item.valor >= 0;
                        histCont.innerHTML += `
                            <div class="historico-item d-flex justify-content-between">
                                <div><div class="small fw-bold">${item.desc}</div><small class="opacity-50 text-micro">${new Date(item.data).toLocaleDateString()}</small></div>
                                <div class="fw-bold ${isPos ? 'v-pos' : 'v-neg'}">${isPos ? '+' : ''} R$ ${item.valor.toFixed(2)}</div>
                            </div>`;
                    });
                }
            } catch(e) {}
        }

        function negociar(id, titulo, preco, tipo) {
            const q = tipo === 'COMPRA' ? prompt(`Quantas cotas de ${titulo} deseja comprar?`) : 1; 
            if(q > 0) {
                const v = q * preco;
                if(!confirm(`Confirmar ${tipo} de ${q} cotas por R$ ${v.toFixed(2)}?`)) return;
                
                fetch(`${APP_URL}?acao=negociar_acao&user_id=${localStorage.getItem('userId')}&musica_id=${id}&quantidade=${q}&preco_unitario=${preco}&valor=${v}&tipo_ordem=${tipo}`)
                .then(() => { alert("Transa√ß√£o processada na rede MIV!"); carregarDadosServidor(); });
            }
        }

        function iniciarMinera√ß√£o(id, titulo) {
            document.getElementById('playerArea').style.display = 'block';
            let t = 30;
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                t--;
                document.getElementById('timerStatus').innerText = `${t}s restantes`;
                if(t <= 0) {
                    clearInterval(timerInterval);
                    finalizarMinera√ß√£o(id);
                }
            }, 1000);
        }

        async function finalizarMinera√ß√£o(id) {
            document.getElementById('timerStatus').innerText = "Creditando...";
            await fetch(`${APP_URL}?acao=registrar_play&ouvinte_id=${localStorage.getItem('userId')}&musica_id=${id}`);
            document.getElementById('playerArea').style.display = 'none';
            alert("Minera√ß√£o bem sucedida! +R$ 0,01");
            carregarDadosServidor();
        }

        function cancelarPlay() { clearInterval(timerInterval); document.getElementById('playerArea').style.display = 'none'; }
    </script>
</body>
</html>
