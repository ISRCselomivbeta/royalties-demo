<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIV Streaming & Invest | Ouvinte</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --miv-blue: #0072ff;
            --miv-cyan: #00c6ff;
            --glass: rgba(255, 255, 255, 0.03);
            --border: rgba(255, 255, 255, 0.1);
        }

        body {
            background: #05070a;
            color: #e0e0e0;
            font-family: 'Inter', system-ui, sans-serif;
            margin: 0; padding-bottom: 100px;
        }

        /* Top Bar */
        .top-nav {
            padding: 20px;
            background: rgba(5, 7, 10, 0.8);
            backdrop-filter: blur(10px);
            position: sticky; top: 0; z-index: 100;
        }

        /* Wallet Card */
        .wallet-card {
            background: linear-gradient(135deg, var(--miv-blue), var(--miv-cyan));
            border-radius: 20px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 10px 30px rgba(0, 114, 255, 0.3);
        }

        /* Feed de Músicas */
        .music-card {
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 18px;
            padding: 15px;
            margin-bottom: 15px;
            transition: 0.3s;
        }
        .music-card:hover { background: rgba(255,255,255,0.06); border-color: var(--miv-cyan); }

        .album-art {
            width: 60px; height: 60px;
            border-radius: 12px;
            background: #1e2329;
            object-fit: cover;
        }

        /* Player flutuante simulado */
        .mini-player {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(17, 20, 24, 0.95);
            backdrop-filter: blur(15px);
            border-top: 1px solid var(--border);
            padding: 15px 20px;
            display: none;
        }

        .btn-miv {
            background: var(--miv-cyan);
            color: #000; font-weight: bold;
            border-radius: 10px; border: none;
            padding: 8px 15px;
        }

        .text-cyan { color: var(--miv-cyan); }
        .small-timer { font-size: 0.7rem; letter-spacing: 1px; }
    </style>
</head>
<body>

    <div class="top-nav d-flex justify-content-between align-items-center">
        <div>
            <span class="text-muted small">Bem-vindo,</span>
            <h5 class="mb-0 fw-bold" id="nomeUser">...</h5>
        </div>
        <button onclick="logout()" class="btn btn-link text-danger p-0 text-decoration-none"><i class="bi bi-power h4"></i></button>
    </div>

    <div class="container">
        <div class="wallet-card">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <span class="small-timer opacity-75">SALDO DISPONÍVEL</span>
                    <h2 class="fw-bold mb-0" id="saldoTxt">R$ 0,00000000</h2>
                </div>
                <i class="bi bi-wallet2 h3"></i>
            </div>
        </div>

        <h6 class="text-muted mb-3 small fw-bold">MARKETPLACE DE ATIVOS MIV</h6>

        <div id="feedMusicas">
            <div class="music-card">
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <div class="d-flex align-items-center">
                        <div class="album-art d-flex align-items-center justify-content-center me-3 shadow">
                            <i class="bi bi-vinyl-fill text-cyan h3 mb-0"></i>
                        </div>
                        <div>
                            <h6 class="mb-0 fw-bold">Som da Rua</h6>
                            <span class="text-muted small">Artista: Selo MIV</span>
                        </div>
                    </div>
                    <div class="text-end">
                        <span class="text-cyan fw-bold d-block">R$ 15,00</span>
                        <span class="small-timer text-muted">Ação</span>
                    </div>
                </div>
                
                <div class="row g-2">
                    <div class="col-8">
                        <button class="btn btn-dark w-100 border-secondary text-white btn-sm py-2" onclick="playMusic('M001', 'Som da Rua', '15.00')">
                            <i class="bi bi-play-fill"></i> OUVIR E GANHAR
                        </button>
                    </div>
                    <div class="col-4">
                        <button class="btn btn-miv btn-sm w-100 py-2" onclick="abrirInvest('M001', '15.00')">
                            INVESTIR
                        </button>
                    </div>
                </div>
            </div>
            </div>
    </div>

    <div class="mini-player shadow-lg" id="playerArea">
        <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center">
                <div class="spinner-border spinner-border-sm text-cyan me-3" role="status" id="spinner"></div>
                <div>
                    <small class="text-muted d-block small-timer" id="playingTitle">OUVINDO...</small>
                    <span class="fw-bold" id="timerStatus">Validando: 30s</span>
                </div>
            </div>
            <button class="btn btn-sm btn-outline-danger border-0" onclick="cancelarPlay()"><i class="bi bi-x-lg"></i></button>
        </div>
    </div>

    <div class="modal fade" id="modalInvest" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark border-secondary">
                <div class="modal-body p-4 text-center">
                    <h5 class="fw-bold mb-3">Comprar Ações</h5>
                    <p class="text-muted">Valor Unitário: <span class="text-cyan fw-bold">R$ 15,00</span></p>
                    <input type="number" id="qtdInvest" class="form-control bg-black border-secondary text-white text-center mb-3" placeholder="Quantas ações?">
                    <button class="btn btn-miv w-100 py-3" onclick="confirmarCompra()">CONFIRMAR INVESTIMENTO</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbz-XDvFYhUjmZMfnZreUdzULCfAprqStkfNAWaY2vXqR4XwOgtF0OOe30g4z7-v_-xu/exec";
        let tempoRestante = 30;
        let timerInterval;

        window.onload = () => {
            document.getElementById('nomeUser').innerText = localStorage.getItem('userName');
            carregarSaldo();
        };

        async function carregarSaldo() {
            const res = await fetch(`${API_URL}?acao=ver_carteira&userId=${localStorage.getItem('userId')}`);
            const data = await res.json();
            if(data.success) document.getElementById('saldoTxt').innerText = "R$ " + data.saldo.toFixed(8);
        }

        function playMusic(id, titulo, preco) {
            document.getElementById('playerArea').style.display = 'block';
            document.getElementById('playingTitle').innerText = "OUVINDO: " + titulo;
            iniciarContagem(id);
        }

        function iniciarContagem(musicaId) {
            tempoRestante = 30;
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                tempoRestante--;
                document.getElementById('timerStatus').innerText = "Validando: " + tempoRestante + "s";
                if(tempoRestante <= 0) {
                    clearInterval(timerInterval);
                    creditar(musicaId);
                }
            }, 1000);
        }

        async function creditar(musicaId) {
            document.getElementById('timerStatus').innerText = "Processando...";
            await fetch(`${API_URL}?acao=registrar_play&ouvinte_id=${localStorage.getItem('userId')}&musica_id=${musicaId}`);
            document.getElementById('playerArea').style.display = 'none';
            alert("Sucesso! R$ 0,0000001 foram adicionados.");
            carregarSaldo();
        }

        function abrirInvest(id, preco) {
            const modal = new bootstrap.Modal(document.getElementById('modalInvest'));
            modal.show();
        }

        async function confirmarCompra() {
            const q = document.getElementById('qtdInvest').value;
            const v = q * 15;
            const res = await fetch(`${API_URL}?acao=negociar_acao&user_id=${localStorage.getItem('userId')}&musica_id=M001&quantidade=${q}&preco_unitario=15&valor=${v}&tipo_ordem=COMPRA`);
            const data = await res.json();
            if(data.success) { 
                alert("Investimento realizado!"); 
                location.reload(); 
            } else { 
                alert(data.error); 
            }
        }

        function logout() { localStorage.clear(); location.href='login.html'; }
        function cancelarPlay() { clearInterval(timerInterval); document.getElementById('playerArea').style.display = 'none'; }
    </script>
</body>
</html>
