<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | SELO MIV</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #0b0e11; color: white; font-family: sans-serif; }
        .card-miv { background: #1e2329; border: 1px solid #333; border-radius: 15px; padding: 20px; margin-bottom: 20px; }
        .saldo-destaque { font-size: 1.8rem; color: #00c6ff; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container py-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4>Olá, <span id="nomeUser">...</span></h4>
            <button onclick="localStorage.clear(); location.href='login.html'" class="btn btn-sm btn-outline-danger">Sair</button>
        </div>

        <div class="card-miv text-center">
            <p class="mb-1 text-muted">Meu Saldo (8 Decimais)</p>
            <div class="saldo-destaque" id="saldoTxt">R$ 0,00000000</div>
        </div>

        <div class="card-miv">
            <h6 class="text-info">Player de Recompensa (R$ 0,0000001 p/ play)</h6>
            <iframe style="border-radius:12px" src="https://open.spotify.com/embed/track/4cOdzh9InnoOFmY7qZ630G" width="100%" height="152" frameBorder="0" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"></iframe>
            <button id="btnGanhar" class="btn btn-info w-100 mt-3 fw-bold" onclick="iniciarContagem()">ATIVAR GANHOS</button>
            <p id="timerTxt" class="text-center mt-2 small" style="display:none">Validando em: <span id="segundos">30</span>s</p>
        </div>

        <div class="card-miv">
            <h6>Mercado de Ações (M001)</h6>
            <p class="small text-muted">Preço: R$ 15,00</p>
            <div class="input-group">
                <input type="number" id="qtdAcoes" class="form-control bg-dark text-white border-secondary" placeholder="Qtd">
                <button class="btn btn-success" onclick="negociar('COMPRA')">Comprar</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbz-XDvFYhUjmZMfnZreUdzULCfAprqStkfNAWaY2vXqR4XwOgtF0OOe30g4z7-v_-xu/exec";

        window.onload = () => {
            document.getElementById('nomeUser').innerText = localStorage.getItem('userName');
            carregarSaldo();
        };

        async function carregarSaldo() {
            const res = await fetch(`${API_URL}?acao=ver_carteira&userId=${localStorage.getItem('userId')}`);
            const data = await res.json();
            if(data.success) document.getElementById('saldoTxt').innerText = "R$ " + data.saldo.toFixed(8);
        }

        function iniciarContagem() {
            let t = 30;
            const btn = document.getElementById('btnGanhar');
            btn.disabled = true;
            document.getElementById('timerTxt').style.display = 'block';
            const it = setInterval(() => {
                t--;
                document.getElementById('segundos').innerText = t;
                if(t <= 0) {
                    clearInterval(it);
                    creditar();
                }
            }, 1000);
        }

        async function creditar() {
            await fetch(`${API_URL}?acao=registrar_play&ouvinte_id=${localStorage.getItem('userId')}&musica_id=M001`);
            alert("Creditado: R$ 0,0000001");
            location.reload();
        }

        async function negociar(tipo) {
            const q = document.getElementById('qtdAcoes').value;
            const v = q * 15;
            const res = await fetch(`${API_URL}?acao=negociar_acao&user_id=${localStorage.getItem('userId')}&musica_id=M001&quantidade=${q}&preco_unitario=15&valor=${v}&tipo_ordem=${tipo}`);
            const data = await res.json();
            if(data.success) { alert("Sucesso!"); location.reload(); } else { alert(data.error); }
        }
    </script>
</body>
</html>
